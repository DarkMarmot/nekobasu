"use strict";function isValid(t){return reverseLookup.hasOwnProperty(t)}function ALWAYS_TRUE(){return!0}function ALWAYS_FALSE(){return!1}function TO_SOURCE(t,e){return e}function TO_MSG(t,e){return t}function NOOP(){}function FUNCTOR(t){return"function"==typeof t?t:function(){return t}}function _wireFrames(t,e){for(var r=t._streams,n=e._streams,i=r.length,a=0;a<i;a++){var s=r[a],u=new Stream(e);u.name=s.name,n.push(u),s.addTarget(u)}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),slicedToArray=function(){function t(t,e){var r=[],n=!0,i=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(n=(s=u.next()).done)&&(r.push(s.value),!e||r.length!==e);n=!0);}catch(t){i=!0,a=t}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),Packet=function(){function t(e,r,n){classCallCheck(this,t),this._msg=e,this._topic=r,this._source=n,this._timestamp=Date.now()}return createClass(t,[{key:"msg",get:function(){return this._msg}},{key:"topic",get:function(){return this._topic}},{key:"source",get:function(){return this._source}},{key:"timestamp",get:function(){return this._timestamp}}]),t}(),DATA_TYPES={ACTION:"action",MIRROR:"mirror",STATE:"state",COMPUTED:"computed",NONE:"none",ANY:"any"},reverseLookup={};for(var p in DATA_TYPES){var v=DATA_TYPES[p];reverseLookup[v]=p}var SubscriberList=function(){function t(e,r){classCallCheck(this,t),this._topic=e,this._subscribers=[],this._lastPacket=null,this._data=r,this._name=r._name,this._dead=!1}return createClass(t,[{key:"tell",value:function(t,e,r){if(!this.dead){e=e||this.topic;var n=this.name,i=new Packet(t,e,n);this.data.type!==DATA_TYPES.ACTION&&(this._lastPacket=i);var a=[].concat(this._subscribers),s=a.length;if(!r)for(var u=0;u<s;u++){var o=a[u];"function"==typeof o?o.call(o,t,i):o.tell(t,i)}}}},{key:"destroy",value:function(){this.dead||(this._subscribers=null,this._lastPacket=null,this._dead=!0)}},{key:"add",value:function(t){this._subscribers.push(t)}},{key:"remove",value:function(t){var e=this._subscribers.indexOf(t);-1!==e&&this._subscribers.splice(e,1)}},{key:"lastPacket",get:function(){return this._lastPacket}},{key:"data",get:function(){return this._data}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"topic",get:function(){return this._topic}}]),t}(),Data=function(){function t(e,r,n){if(classCallCheck(this,t),n=n||DATA_TYPES.NONE,!isValid(n))throw new Error("Invalid Data of type: "+n);this._scope=e,this._name=r,this._type=n,this._dead=!1,this._noTopicSubscriberList=new SubscriberList(null,this),this._wildcardSubscriberList=new SubscriberList(null,this),this._subscriberListsByTopic=new Map}return createClass(t,[{key:"destroy",value:function(){this.dead&&this._throwDead();var t=!0,e=!1,r=void 0;try{for(var n,i=this._subscriberListsByTopic.values()[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){n.value.destroy()}}catch(t){e=!0,r=t}finally{try{!t&&i.return&&i.return()}finally{if(e)throw r}}this._dead=!0}},{key:"_demandSubscriberList",value:function(t){var e=this._subscriberListsByTopic.get(t);return e||(e=new SubscriberList(t,this),this._subscriberListsByTopic.set(t,e),e)}},{key:"verify",value:function(t){if(this.type===t)return this;throw new Error("Data "+this.name+" requested as type "+t+" exists as "+this.type)}},{key:"follow",value:function(t,e){this.dead&&this._throwDead(),this.subscribe(t,e);var r=this.peek();return r&&("function"==typeof t?t.call(t,r.msg,r):t.tell(r.msg,r)),this}},{key:"subscribe",value:function(t,e){return this.dead&&this._throwDead(),(e?this._demandSubscriberList(e):this._noTopicSubscriberList).add(t),this}},{key:"monitor",value:function(t){return this.dead&&this._throwDead(),this._wildcardSubscriberList.add(t),this}},{key:"unsubscribe",value:function(t,e){if(this.dead&&this._throwDead(),"string"!=typeof e)this._noTopicSubscriberList.remove(t);else{this._demandSubscriberList(e).remove(t)}return this._wildcardSubscriberList.remove(t),this}},{key:"peek",value:function(t){this.dead&&this._throwDead();var e=t?this._subscriberListsByTopic.get(t):this._noTopicSubscriberList;return e?e.lastPacket:null}},{key:"read",value:function(t){this.dead&&this._throwDead();var e=this.peek(t);return e?e.msg:void 0}},{key:"silentWrite",value:function(t,e){this.dead&&this._throwDead(),this.write(t,e,!0)}},{key:"write",value:function(t,e,r){if(this.dead&&this._throwDead(),this.type===DATA_TYPES.MIRROR)throw new Error("Mirror Data: "+this.name+" is read-only");if(e){this._demandSubscriberList(e).tell(t)}else this._noTopicSubscriberList.tell(t,null,r);this._wildcardSubscriberList.tell(t,e,r)}},{key:"refresh",value:function(t){return this.dead&&this._throwDead(),this.write(this.read(t),t),this}},{key:"toggle",value:function(t){return this.dead&&this._throwDead(),this.write(!this.read(t),t),this}},{key:"_throwDead",value:function(){throw new Error("Data: "+this.name+" is already dead.")}},{key:"scope",get:function(){return this._scope}},{key:"name",get:function(){return this._name}},{key:"type",get:function(){return this._type}},{key:"dead",get:function(){return this._dead}}]),t}(),Func={ASSERT_NEED_ONE_ARGUMENT:function(t){if(t.length<1)throw new Error("Method requires at least one argument.")},ASSERT_IS_FUNCTION:function(t){if("function"!=typeof t)throw new Error("Argument [func] is not of type function.")},getAlwaysTrue:function(){return function(){return!0}},getBatchTimer:function(){var t=this;return function(){Catbus$1.enqueue(t)}},getSyncTimer:function(){var t=this;return function(){t.release(t)}},getDeferTimer:function(){var t=this;return function(){setTimeout(t.release,0,t)}},getThrottleTimer:function(t){function e(s){if(!r.stream.dead){var u=r.keep.isEmpty;if(!s)return void(i?a=!0:(r.release(r),n=!1,i=setTimeout(e,t.call(r),!0)));u?n||(n=!0,a=!1,i=setTimeout(e,t.call(r),!0)):(r.release(r),n=!1,i=setTimeout(e,t.call(r),!0))}}var r=this;t=FUNCTOR(t);var n=!1,i=null,a=!1;r.keep.auto;return e},getQueue:function(t){t=t||1/0;var e=[],r=function(r,n){return e.length<t&&e.push(r),e};return r.isBuffer=ALWAYS_TRUE,r.next=function(){return e.shift()},r.isEmpty=function(){return 0===e.length},r.content=function(){return e},r},getScan:function(t,e){var r=2===arguments.length,n=void 0,i=!0,a=function(a,s){return i?(i=!1,n=r?t(e,a,s):a):n=t(n,a,s),n};return a.reset=NOOP,a.next=a.content=function(){return n},a},getGroup:function(t){t=t||TO_SOURCE;var e={},r=function(r,n){var i=t(r,n);return e[i]=r,e};return r.reset=function(){for(var t in e)delete e[t];r.isEmpty=!0},r.next=r.content=function(){return e},r},getKeepLast:function(t){if(!t||t<0){var e=void 0,r=function(t,r){return e=t};return r.reset=function(){r.isEmpty=!0},r.next=r.content=function(){return e},r}var n=[],i=function(e,r){return n.push(e),n.length>t&&n.shift(),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepFirst:function(t){if(!t||t<0){var e=void 0,r=function(t,r){return e=t};return r.reset=function(){e=!1,r.isEmpty=!0},r.next=r.content=function(){return e},r}var n=[],i=function(e,r){return n.length<t&&n.push(e),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepAll:function(){var t=[],e=function(e,r){return t.push(e),t};return e.reset=function(){for(;t.length;)t.shift();e.isEmpty=!0},e.next=e.content=function(){return t},e},getWhenCount:function(t){var e=!1,r=function(r){return e=e||r.length>=t};return r.reset=function(){e=!1},r},getWhenKeys:function(t){for(var e={},r=t.length,n=0;n<r;n++){var i=t[n];e[i]=!0}var a=!1,s=function(e){if(a)return!0;for(var n=0;n<r;n++){var i=t[n];if(!e.hasOwnProperty(i))return!1}return a=!0};return s.reset=function(){a=!1;for(var t in e)delete e[t]},s},getSkipDupes:function(){var t=!1,e=void 0;return function(r){var n=!t||r!==e;return e=r,t=!0,n}},ASSERT_NOT_HOLDING:function(t){if(t.holding)throw new Error("Method cannot be invoked while holding messages in the frame.")},ASSERT_IS_HOLDING:function(t){if(!t.holding)throw new Error("Method cannot be invoked unless holding messages in the frame.")}};Func.TO_SOURCE=TO_SOURCE,Func.To_MSG=TO_MSG,Func.FUNCTOR=FUNCTOR,Func.ALWAYS_TRUE=ALWAYS_TRUE,Func.ALWAYS_FALSE=ALWAYS_FALSE,Func.NOOP=NOOP;var PoolAspects=function t(){classCallCheck(this,t),this.until=null,this.reduce=null,this.when=null,this.clear=null,this.timer=null},Frame=function(){function t(e,r){classCallCheck(this,t),r=r||[],this._bus=e,this._index=e._frames.length,this._holding=!1,this._streams=r,this._process=null,this._action=null,this._isFactory=!1,this._poolAspects=null;for(var n=r.length,i=0;i<n;i++)r[i].debugFrame=this}return createClass(t,[{key:"applySyncProcess",value:function(t,e,r){this._process=t,this._action=e,this._isFactory=r;var n=this._streams,i=n.length;if(r)for(var a=0;a<i;a++){var s=n[a];s.actionMethod=e(),s.processMethod=s[t]}else for(var u=0;u<i;u++){var o=n[u];o.actionMethod=e,o.processMethod=o[t]}return this}},{key:"hold",value:function(){this._holding=!0,this._poolAspects=new PoolAspects;for(var t=this._streams,e=t.length,r=0;r<e;r++){var n=t[r];n.createPool(),n.processMethod=n.doPool}return this}},{key:"run",value:function(t,e){return this.applySyncProcess("doRun",t,e)}},{key:"transform",value:function(t,e){return this.applySyncProcess("doTransform",Func.FUNCTOR(t),e)}},{key:"name",value:function(t,e){return this.applySyncProcess("doName",Func.FUNCTOR(t),e)}},{key:"delay",value:function(t,e){return this.applySyncProcess("doDelay",Func.FUNCTOR(t),e)}},{key:"filter",value:function(t,e){return this.applySyncProcess("doFilter",t,e)}},{key:"skipDupes",value:function(){return this.applySyncProcess("doFilter",Func.getSkipDupes,!0)}},{key:"clear",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["clear",t].concat(r))}},{key:"reduce",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["keep",t].concat(r))}},{key:"timer",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["timer",t].concat(r))}},{key:"when",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["when",t].concat(r))}},{key:"until",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["until",t].concat(r))}},{key:"buildPoolAspect",value:function(t,e){"timer"===t&&(this._holding=!1);for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this._poolAspects[t]=[e].concat(n);for(var a=this._streams,s=a.length,u=0;u<s;u++){var o=a[u],c=o.pool;c.build.apply(c,[t,e].concat(n))}return this}},{key:"destroy",value:function(){for(var t=this._streams,e=t.length,r=0;r<e;r++)t[r].cleanupMethod();this._streams=null}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return this._holding}},{key:"streams",get:function(){return[].concat(this._streams)}}]),t}(),Pool=function(){function t(e){classCallCheck(this,t),this.stream=e,this.keep=null,this.when=Func.ALWAYS_TRUE,this.until=Func.ALWAYS_TRUE,this.timer=null,this.clear=Func.ALWAYS_FALSE,this.isPrimed=!1,this.source=e.name}return createClass(t,[{key:"tell",value:function(t,e){if(this.keep(t,e),!this.isPrimed){var r=this.keep.content();this.when(r)&&(this.isPrimed=!0,this.timer(this))}}},{key:"build",value:function(t,e){for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this[t]=e.call.apply(e,[this].concat(n))}},{key:"release",value:function(t){t=t||this;var e=!t.keep.isEmpty,r=e&&t.keep.next();t.clear()&&(t.keep.reset(),t.when.reset()),t.isPrimed=!1,e&&t.stream.emit(r,t.stream.name)}}]),t}(),Stream=function(){function t(){classCallCheck(this,t),this.debugFrame=null,this.dead=!1,this.children=[],this.name=null,this.pool=null,this.cleanupMethod=Func.NOOP,this.processMethod=this.emit,this.actionMethod=null}return createClass(t,[{key:"tell",value:function(t,e){return this.dead?this:(this.processMethod(t,e),this)}},{key:"drop",value:function(t){var e=this.children,r=e.indexOf(t);-1!==r&&e.splice(r,1)}},{key:"addTarget",value:function(t){this.children.push(t)}},{key:"emit",value:function(t,e,r){r=r||this;for(var n=r.children,i=n.length,a=0;a<i;a++){n[a].tell(t,e)}}},{key:"doFilter",value:function(t,e){this.actionMethod(t,e)&&this.emit(t,e)}},{key:"doTransform",value:function(t,e){t=this.actionMethod(t,e),this.emit(t,e)}},{key:"doDelay",value:function(t,e){setTimeout(this.emit,this.actionMethod(t,e)||0,t,e,this)}},{key:"doName",value:function(t,e){e=this.actionMethod(t,e),this.emit(t,e)}},{key:"doRun",value:function(t,e){this.actionMethod(t,e),this.emit(t,e)}},{key:"createPool",value:function(){this.pool=new Pool(this)}},{key:"doPool",value:function(t,e){this.pool.tell(t,e)}},{key:"destroy",value:function(){this.dead||this.cleanupMethod()}}]),t}();Stream.fromData=function(t,e,r){var n=new Stream,i=r||e||t.name;n.name=i;var a=function(t){n.tell(t,i)};return n.cleanupMethod=function(){t.unsubscribe(a,e)},t.follow(a,e),n},Stream.fromEvent=function(t,e,r){r=!!r;var n=new Stream;n.name=e;var i=t.addEventListener||t.addListener||t.on,a=t.removeEventListener||t.removeListener||t.off,s=function(t){n.tell(t,e)};return n.cleanupMethod=function(){a.call(t,e,s,r)},i.call(t,e,s,r),n};var Bus=function(){function t(e,r){classCallCheck(this,t),this._frames=[],this._dead=!1,this._scope=e,e&&e._busList.push(this);var n=new Frame(this,r||[]);this._frames.push(n),this._currentFrame=n}return createClass(t,[{key:"addFrame",value:function(){var t=this._currentFrame,e=this._currentFrame=new Frame(this);return this._frames.push(e),_wireFrames(t,e),e}},{key:"spawn",value:function(){}},{key:"split",value:function(){Func.ASSERT_NOT_HOLDING(this)}},{key:"fork",value:function(){Func.ASSERT_NOT_HOLDING(this);var e=new t(this.scope);return _wireFrames(this._currentFrame,e._currentFrame),e}},{key:"add",value:function(t){var e=this.addFrame();return _wireFrames(t._currentFrame,e),this}},{key:"defer",value:function(){return this.timer(Func.getDeferTimer)}},{key:"batch",value:function(){return this.timer(Func.getBatchTimer)}},{key:"sync",value:function(){return this.timer(Func.getSyncTimer)}},{key:"throttle",value:function(t){return this.timer(Func.getThrottleTimer,t)}},{key:"hold",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().hold(),this}},{key:"scan",value:function(t,e){return this.reduce(Func.getScan,t,e)}},{key:"delay",value:function(t){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame().delay(t),this}},{key:"willReset",value:function(){return Func.ASSERT_IS_HOLDING(this),this.clear(Func.getAlwaysTrue)}},{key:"whenKeys",value:function(t){return Func.ASSERT_IS_HOLDING(this),this.when(Func.getWhenKeys,t)}},{key:"group",value:function(t){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().hold().reduce(Func.getGroup,t),this}},{key:"all",value:function(){return this.reduce(Func.getKeepAll)}},{key:"first",value:function(t){return this.reduce(Func.getKeepFirst,t)}},{key:"last",value:function(t){return this.reduce(Func.getKeepLast,t)}},{key:"clear",value:function(t){for(var e,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return(e=this._currentFrame).clear.apply(e,[t].concat(n))}},{key:"reduce",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).reduce.apply(e,[t].concat(i)):(r=this.addFrame().hold()).reduce.apply(r,[t].concat(i)).timer(Func.getSyncTimer),this}},{key:"timer",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).timer.apply(e,[t].concat(i)):(r=this.addFrame().hold()).timer.apply(r,[t].concat(i)),this}},{key:"until",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).until.apply(e,[t].concat(i)):(r=this.addFrame().hold()).until.apply(r,[t].concat(i)).timer(Func.getSyncTimer),this}},{key:"when",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).when.apply(e,[t].concat(i)):(r=this.addFrame().hold()).when.apply(r,[t].concat(i)).timer(Func.getSyncTimer),this}},{key:"run",value:function(t){return Func.ASSERT_IS_FUNCTION(t),Func.ASSERT_NOT_HOLDING(this),this.addFrame().run(t),this}},{key:"merge",value:function(){Func.ASSERT_NOT_HOLDING(this);var t=new Stream,e=this._currentFrame,r=this._currentFrame=new Frame(this,[t]);this._frames.push(r);for(var n=e._streams,i=n.length,a=0;a<i;a++){n[a].addTarget(t)}return this}},{key:"transform",value:function(t){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame().transform(t),this}},{key:"name",value:function(t){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame().name(t),this}},{key:"filter",value:function(t){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_IS_FUNCTION(t),Func.ASSERT_NOT_HOLDING(this),this.addFrame().filter(t),this}},{key:"skipDupes",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().skipDupes(),this}},{key:"toStream",value:function(){}},{key:"destroy",value:function(){if(this.dead)return this;this._dead=!0;var t=this._frames,e=!0,r=!1,n=void 0;try{for(var i,a=t[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){i.value.destroy()}}catch(t){r=!0,n=t}finally{try{!e&&a.return&&a.return()}finally{if(r)throw n}}return this}},{key:"dead",get:function(){return this._dead}},{key:"holding",get:function(){return this._currentFrame._holding}},{key:"scope",get:function(){return this._scope}}]),t}(),idCounter=0,Scope=function(){function t(e){classCallCheck(this,t),this._id=++idCounter,this._name=e,this._parent=null,this._children=[],this._busList=[],this._dataList=new Map,this._valves=new Map,this._mirrors=new Map,this._dead=!1}return createClass(t,[{key:"clear",value:function(){this._dead||(this._destroyEach(this._children),this._destroyEach(this._busList),this._destroyEach(this._dataList.values()),this._children=[],this._busList=[],this._dataList.clear(),this._valves.clear(),this._mirrors.clear())}},{key:"_destroyEach",value:function(t){for(var e=t.length,r=0;r<e;r++){var n=t[r];n||console.log(n),n.destroy()}}},{key:"destroy",value:function(){this.clear(),this.parent=null,this._dead=!0}},{key:"createChild",value:function(e){var r=new t(e);return r.parent=this,r}},{key:"insertParent",value:function(t){return t.parent=this.parent,this.parent=t,this}},{key:"_createMirror",value:function(t){var e=Object.create(t);return e._type=DATA_TYPES.MIRROR,this._mirrors.set(t.name,e),e}},{key:"_createData",value:function(t,e){var r=new Data(this,t,e);return this._dataList.set(t,r),r}},{key:"data",value:function(t){return this.grab(t)||this._createData(t,DATA_TYPES.NONE)}},{key:"action",value:function(t){var e=this.grab(t);return e?e.verify(DATA_TYPES.ACTION):this._createData(t,DATA_TYPES.ACTION)}},{key:"state",value:function(t){var e=this.grab(t);if(e)return e.verify(DATA_TYPES.STATE);var r=this._createData(t,DATA_TYPES.STATE);return this._createMirror(r),r}},{key:"findDataSet",value:function(t,e){var r={},n=!0,i=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var o=s.value;r[o]=this.find(o,e)}}catch(t){i=!0,a=t}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}},{key:"readDataSet",value:function(t,e){var r=this.findDataSet(t,e),n={},i=!0,a=!1,s=void 0;try{for(var u,o=r[Symbol.iterator]();!(i=(u=o.next()).done);i=!0){var c=u.value;if(c){var h=c.peek();h&&(n[c.name]=h.msg)}}}catch(t){a=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(a)throw s}}return n}},{key:"flatten",value:function(){var t=this,e=new Map,r=new Map,n=!0,i=!1,a=void 0;try{for(var s,u=t._dataList[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var o=slicedToArray(s.value,2),c=o[0],h=o[1];e.set(c,h)}}catch(t){i=!0,a=t}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}for(;t=t._parent;){var l=t._dataList,f=t._valves,d=t._mirrors;if(l.size){if(f.size)if(r.size){var y=!0,v=!1,_=void 0;try{for(var m,p=r.keys()[Symbol.iterator]();!(y=(m=p.next()).done);y=!0){var k=m.value;f.has(k)||r.delete(k)}}catch(t){v=!0,_=t}finally{try{!y&&p.return&&p.return()}finally{if(v)throw _}}}else{var S=!0,g=!1,b=void 0;try{for(var T,A=f.entries()[Symbol.iterator]();!(S=(T=A.next()).done);S=!0){var w=slicedToArray(T.value,2),F=w[0],h=w[1];r.set(F,h)}}catch(t){g=!0,b=t}finally{try{!S&&A.return&&A.return()}finally{if(g)throw b}}}var E=r.size?r:l,O=!0,N=!1,L=void 0;try{for(var D,C=E.keys()[Symbol.iterator]();!(O=(D=C.next()).done);O=!0){var R=D.value;if(!e.has(R)){var P=d.get(R)||l.get(R);P&&e.set(R,P)}}}catch(t){N=!0,L=t}finally{try{!O&&C.return&&C.return()}finally{if(N)throw L}}}}return e}},{key:"find",value:function(t,e){var r=this.grab(t);if(r)return r;for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(t))break;var a=n._mirrors.get(t);if(a)return a;var s=n.grab(t);if(s)return s}if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"findOuter",value:function(t,e){var r=!1;this.grab(t)&&(r=!0);for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(t))break;var a=n._mirrors.get(t);if(a){if(r)return a;r=!0}else{var s=n.grab(t);if(s){if(r)return s;r=!0}}}if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"grab",value:function(t,e){var r=this._dataList.get(t);if(!r&&e)throw new Error("Required Data: "+t+" not found!");return r||null}},{key:"transaction",value:function(t){if(Array.isArray(t))return this._multiWriteArray(t);if("object"===(void 0===t?"undefined":_typeof(t)))return this._multiWriteHash(t);throw new Error("Write values must be in an array of object hash.")}},{key:"_multiWriteArray",value:function(t,e){var r=[],n=!0,i=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var o=s.value,c=this.find(o.name);c.silentWrite(o.value,o.topic||null),r.push(c)}}catch(t){i=!0,a=t}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}var h=!0,l=!1,f=void 0;try{for(var d,y=r[Symbol.iterator]();!(h=(d=y.next()).done);h=!0){var v=d.value,_=t[0];v.refresh(_.topic||null)}}catch(t){l=!0,f=t}finally{try{!h&&y.return&&y.return()}finally{if(l)throw f}}return this}},{key:"_multiWriteHash",value:function(t){var e=[];for(var r in t){var n=t[r],i=this.find(r);i.silentWrite(n),e.push(i)}var a=!0,s=!1,u=void 0;try{for(var o,c=e[Symbol.iterator]();!(a=(o=c.next()).done);a=!0){o.value.refresh()}}catch(t){s=!0,u=t}finally{try{!a&&c.return&&c.return()}finally{if(s)throw u}}return this}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"children",get:function(){return this._children.map(function(t){return t})}},{key:"parent",get:function(){return this._parent},set:function(t){var e=this.parent;if(e!==t){if(e){var r=e._children.indexOf(this);e._children.splice(r,1)}return this._parent=t,t&&t._children.push(this),this}}},{key:"valves",set:function(t){var e=!0,r=!1,n=void 0;try{for(var i,a=t[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var s=i.value;this._valves.set(s,!0)}}catch(t){r=!0,n=t}finally{try{!e&&a.return&&a.return()}finally{if(r)throw n}}},get:function(){return Array.from(this._valves.keys())}}]),t}(),Catbus$1={},_batchQueue=[],_primed=!1;Catbus$1.fromEvent=function(t,e,r){var n=Stream.fromEvent(t,e,r);return new Bus(null,[n])},Catbus$1.enqueue=function(t){_batchQueue.push(t),_primed||(_primed=!0,"undefined"!=typeof window&&window.requestAnimationFrame?requestAnimationFrame(Catbus$1.flush):process.nextTick(Catbus$1.flush))},Catbus$1.scope=function(t){return console.log("root is ",t),new Scope(t)},Catbus$1.flush=function(){_primed=!1;var t=0,e=_batchQueue;for(_batchQueue=[];e.length;){for(;e.length;){e.shift().release()}if(e=_batchQueue,_batchQueue=[],++t>10)throw new Error("Flush batch cycling loop > 10.",e)}},module.exports=Catbus$1;
