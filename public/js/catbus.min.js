"use strict";function ALWAYS_TRUE(){return!0}function ALWAYS_FALSE(){return!1}function TO_SOURCE(e,t){return t}function TO_TOPIC(e,t,r){return r}function TO_MSG(e){return e}function NOOP(){}function FUNCTOR(e){return"function"==typeof e?e:function(){return e}}function isValid(e){return reverseLookup.hasOwnProperty(e)}function pass(e,t,r,n,i){e.emit(t,r,n,i)}function toTickStackString(e){tickStack=[];for(var t=e.split(/([`])/),r=[],n=!1;t.length;){var i=t.shift();"`"===i?(n=!n,r.push(i)):n?tickStack.push(i):r.push(i)}return r.join("")}function parse(e,t){e=toTickStackString(e);for(var r=[],n=e.split(/([{}]|-})/).map(function(e){return e.trim()}).filter(function(e){return e}),i=0;i<n.length;i++){var a=n[i],s="}"===a||"{"===a||"-}"===a?a:parseSentence(a);("string"==typeof s||s.length>0)&&r.push(s)}return validate(r,t)}function validate(e,t){for(var r=[],n=!0,i=0;i<e.length;i++){var a=e[i];if("string"!=typeof a)for(var s=0;s<a.length;s++){var o=a[s];n&&!t?(validateReactPhrase(o),n=!1,r.push({name:"REACT",phrase:o})):(validateProcessPhrase(o),r.push({name:"PROCESS",phrase:o}))}else"{"===a?r.push({name:"FORK"}):"}"===a?r.push({name:"BACK"}):"-}"===a&&r.push({name:"JOIN"})}return r}function validateReactPhrase(e){for(var t=!1,r=0;r<e.length;r++){var n=e[r],i=n.operation=n.operation||"WATCH";if(t=t||reactionsByName[i],!withReactionsByName[i])throw new Error("This Nyan command cannot be in a reaction!")}if(!t)throw new Error("Nyan commands must begin with an observation!")}function validateProcessPhrase(e){var t=e[0],r=t.operation||"READ";if(!thenByName[r])throw new Error("Illegal operation in phrase!");for(var n=0;n<e.length;n++){var i=e[n];if(i.operation=i.operation||r,i.operation!==r)throw new Error("Multiple operation types in phrase (only one allowed)!")}}function parseSentence(e){for(var t=[],r=e.split("|").map(function(e){return e.trim()}).filter(function(e){return e}),n=0;n<r.length;n++){var i=r[n],a=parsePhrase(i);t.push(a)}return t}function parsePhrase(e){for(var t=[],r=e.split(",").map(function(e){return e.trim()}).filter(function(e){return e}),n=r.length,i=0;i<n;i++){for(var a=r[i],s=a.split(/([(?!:.`)])/),o=[],u=!1;s.length;){var c=s.shift();if("`"===c)u=!u,o.push(c);else if(u)o.push(c);else{var h=c.trim();h&&o.push(h)}}var l=o.shift(),f=a[0],d=namesBySymbol[f],v=d?1:0,y=l.slice(v).trim(),m=[],p=!1,_=!1,g=null,k=null,b=!1;if("ALIAS"===d)k=o.shift(),o.shift();else if("METHOD"===d){o.shift();var S=tickStack.shift(),w=S.indexOf(" ");for(-1===w?m.push(S):(m.push(S.slice(0,w)),S.length>w&&m.push(S.slice(w+1)));o.length;)o.shift()}for(;o.length;){switch(o.shift()){case".":var T=o.length&&o[0],E=o.length>1&&"?"===o[1];T&&(m.push({name:T,silentFail:E}),o.shift(),E&&o.shift());break;case"?":p=!0;break;case"!":b=!0;break;case":":if(o.length){var A=o[0];"("===A?_=!0:(g=A,o.shift())}else _=!0;break;case"(":o.length&&(k=o.shift())}}k=k||g||y;var D=new NyanWord(y,d,p,b,g,k,_,m);t.push(D)}return t}function getPacketFromDataWord(e,t){var r=e.find(t.name,!t.maybe);return r&&r.peek(t.topic)}function getSurveyFromDataWord(e,t){var r=e.find(t.name,!t.maybe);return r&&r.survey()}function throwError(e){console.log("throwing ",e);var t=new Error(e);throw console.log(this,t),t}function getDoSkipNamedDupes(e){var t={},r=e.length;return function(n){for(var i=!1,a=0;a<r;a++){var s=e[a];t.hasOwnProperty(s)&&t[s]===n[s]||(i=!0),t[s]=n[s]}return i}}function getDoWrite(e,t){var r=e.find(t.name,!t.maybe);return function(e){r.write(e,t.topic)}}function getDoSpray(e,t){for(var r={},n={},i=t.length,a=0;a<i;a++){var s=t[a],o=e.find(s.name,!s.maybe);o&&(r[s.alias]=s,n[s.alias]=o)}return function(e){for(var t in e){var i=n[t];if(i){var a=r[t],s=e[t];i.silentWrite(s,a.topic)}}for(var o in e){var u=n[o];if(u){var c=r[o];u.refresh(c.topic)}}}}function getDoRead(e,t){var r=t.length,n=t[0];return r>1||n.monitor?getDoReadMultiple(e,t):getDoReadSingle(e,n)}function getDoAnd(e,t){return getDoReadMultiple(e,t,!0)}function getDoReadSingle(e,t){return function(){var r=getPacketFromDataWord(e,t);return r&&r.msg}}function getDoReadMultiple(e,t,r){var n=t.length;return function(i,a){var s={};if(r)if(a)s[a]=i;else for(var o in i)s[o]=i[o];for(var u=0;u<n;u++){var c=t[u];if(c.monitor){var h=getSurveyFromDataWord(e,c),l=!0,f=!1,d=void 0;try{for(var v,y=h[Symbol.iterator]();!(l=(v=y.next()).done);l=!0){var m=slicedToArray(v.value,2),p=m[0],_=m[1];s[p]=_}}catch(e){f=!0,d=e}finally{try{!l&&y.return&&y.return()}finally{if(f)throw d}}}else{var g=getPacketFromDataWord(e,c),k=c.monitor?c.alias||c.topic:c.alias||c.name;g&&(s[k]=g.msg)}}return s}}function getDataWire(e,t,r){var n=e.find(t.name,!t.maybe);return t.monitor?Wire.fromMonitor(n,t.alias,r):Wire.fromSubscribe(n,t.topic,t.alias,r)}function isObject(e){return null!==e&&("function"==typeof e||"object"===(void 0===e?"undefined":_typeof(e)))}function getEventWire(e,t){return Wire.fromEvent(t,e.topic,e.useCapture,e.alias)}function doExtracts(e,t){for(var r=e,n=t.length,i=0;i<n;i++){var a=t[i];if(!isObject(r)){if(a.silentFail)return;throwError("Cannot access property '"+a.name+"' of "+r)}r=r[a.name]}return r}function getNeedsArray(e){return e.filter(function(e){return e.operation.need}).map(function(e){return e.alias})}function getDoMsgHashExtract(e){for(var t=e.length,r={},n=0;n<t;n++){var i=e[n];r[i.alias]=i.extracts}return function(e){var t={};for(var n in r){e.hasOwnProperty(n)&&(t[n]=doExtracts(e[n],r[n]))}return t}}function getDoMsgExtract(e){var t=e.extracts;return function(e){return doExtracts(e,t)}}function applyReaction(e,t,r,n){var i=[],a=[],s=[];if(1===r.length&&"ACTION"===r[0].operation){var o=r[0];return void t.wire(getDataWire(e,o,!1))}for(var u=0;u<r.length;u++){var c=r[u],h=c.operation;"WATCH"===h?(t.wire(getDataWire(e,c,!0)),a.push(c.alias)):"WIRE"===h?t.wire(getDataWire(e,c,!0)):"EVENT"===h&&t.wire(getEventWire(c,n)),c.extracts&&s.push(c),c.need&&i.push(c.alias)}t._wires.length>1?(t.merge().group().batch(),s.length&&t.msg(getDoMsgHashExtract(s)),i.length&&t.hasKeys(i),a.length&&t.filter(getDoSkipNamedDupes(a))):(s.length&&t.msg(getDoMsgExtract(s[0])),a.length&&t.skipDupes())}function isTruthy(e){return!!e}function isFalsey(e){return!e}function applyMethod(e,t){switch(t.extracts[0]){case"true":e.msg(!0);break;case"false":e.msg(!1);break;case"null":e.msg(null);break;case"undefined":e.msg(void 0);break;case"array":e.msg([]);break;case"object":e.msg({});break;case"truthy":e.filter(isTruthy);break;case"falsey":e.filter(isFalsey);break;case"string":e.msg(function(){return t.extracts[1]})}}function applyProcess(e,t,r,n,i){var a=r[0].operation;if("READ"===a){t.msg(getDoRead(e,r));var s=getNeedsArray(r);s.length&&t.whenKeys(s)}else if("AND"===a){t.msg(getDoAnd(e,r));var o=getNeedsArray(r);o.length&&t.whenKeys(o)}else"METHOD"===a?applyMethod(t,r[0]):"FILTER"===a?applyFilterProcess(t,r,n):"RUN"===a?applyMsgProcess(t,r,n):"ALIAS"===a?applySourceProcess(t,r[0]):"WRITE"===a?t.run(getDoWrite(e,r[0])):"SPRAY"===a&&t.run(getDoSpray(e,r))}function applyMsgProcess(e,t,r){for(var n=t.length,i=0;i<n;i++)!function(n){var i=t[n],a=i.name,s=r[a],o=function(e,t,n){return s.call(r,e,t,n)};e.msg(o)}(i)}function applySourceProcess(e,t){e.source(t.alias)}function applyFilterProcess(e,t,r){for(var n=t.length,i=0;i<n;i++)!function(n){var i=t[n],a=i.name,s=r[a],o=function(e,t,n){return s.call(r,e,t,n)};e.filter(o)}(i)}function nyanToBus(e,t,r,n,i){for(var a=Nyan.parse(r),s=a.length,o=0;o<s;o++){var u=a[o],c=u.name,h=u.phrase;"JOIN"===c?(t=t.join(),t.merge(),t.group(),t.sync()):"FORK"===c?t=t.fork():"BACK"===c?t=t.back():"PROCESS"===c?applyProcess(e,t,h,n,i):applyReaction(e,t,h,i)}return t}function _destroyEach(e){for(var t=e.length,r=0;r<t;r++){e[r].destroy()}}var Func={ASSERT_NEED_ONE_ARGUMENT:function(e){if(e.length<1)throw new Error("Method requires at least one argument.")},ASSERT_IS_FUNCTION:function(e){if("function"!=typeof e)throw new Error("Argument [func] is not of type function.")},getAlwaysTrue:function(){return function(){return!0}},getBatchTimer:function(e){Catbus$1.enqueue(e)},getSyncTimer:function(){return function(e){e.release(e)}},getDeferTimer:function(){return function(e){setTimeout(e.release,0,e)}},getThrottleTimer:function(e){function t(s){if(!r.stream.dead){var o=r.keep.isEmpty;if(!s)return void(i?a=!0:(r.release(r),n=!1,i=setTimeout(t,e.call(r),!0)));o?n||(n=!0,a=!1,i=setTimeout(t,e.call(r),!0)):(r.release(r),n=!1,i=setTimeout(t,e.call(r),!0))}}var r=this;e=FUNCTOR(e);var n=!1,i=null,a=!1;r.keep.auto;return t},getQueue:function(e){e=e||1/0;var t=[],r=function(r,n){return t.length<e&&t.push(r),t};return r.isBuffer=ALWAYS_TRUE,r.next=function(){return t.shift()},r.isEmpty=function(){return 0===t.length},r.content=function(){return t},r},getScan:function(e,t){var r=2===arguments.length,n=void 0,i=!0,a=function(a,s){return i?(i=!1,n=r?e(t,a,s):a):n=e(n,a,s),n};return a.reset=NOOP,a.next=a.content=function(){return n},a},getGroup:function(e){e=e||TO_SOURCE;var t={},r=function(r,n){var i=e(r,n);if(i)t[i]=r;else for(var a in r)t[a]=r[a];return t};return r.reset=function(){for(var e in t)delete t[e];r.isEmpty=!0},r.next=r.content=function(){return t},r},getHash:function(e){e=e||TO_SOURCE;var t={},r=function(r,n){var i=e(r,n);return t[i]=r,t};return r.reset=function(){for(var e in t)delete t[e];r.isEmpty=!0},r.next=r.content=function(){return t},r},getKeepLast:function(e){if(!e||e<0){var t=void 0,r=function(e,r){return t=e};return r.reset=function(){r.isEmpty=!0},r.next=r.content=function(){return t},r}var n=[],i=function(t,r){return n.push(t),n.length>e&&n.shift(),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepFirst:function(e){if(!e||e<0){var t=void 0,r=function(e,r){return t=e};return r.reset=function(){t=!1,r.isEmpty=!0},r.next=r.content=function(){return t},r}var n=[],i=function(t,r){return n.length<e&&n.push(t),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepAll:function(){var e=[],t=function(t,r){return e.push(t),e};return t.reset=function(){for(;e.length;)e.shift();t.isEmpty=!0},t.next=t.content=function(){return e},t},getWhenCount:function(e){var t=!1,r=function(r){return t=t||r.length>=e};return r.reset=function(){t=!1},r},getWhenKeys:function(e){for(var t={},r=e.length,n=0;n<r;n++){var i=e[n];t[i]=!0}var a=!1,s=function(t){if(a)return!0;for(var n=0;n<r;n++){var i=e[n];if(!t.hasOwnProperty(i))return!1}return a=!0};return s.reset=function(){a=!1;for(var e in t)delete t[e]},s},getHasKeys:function(e,t){var r=!1,n=e.length;return function(i){if(r||!n)return!0;for(var a=0;a<n;a++){var s=e[a];if(!i.hasOwnProperty(s))return!1}return t||(r=!0),!0}},getSkipDupes:function(){var e=!1,t=void 0;return function(r){var n=!e||r!==t;return t=r,e=!0,n}},ASSERT_NOT_HOLDING:function(e){if(e.holding)throw new Error("Method cannot be invoked while holding messages in the frame.")},ASSERT_IS_HOLDING:function(e){if(!e.holding)throw new Error("Method cannot be invoked unless holding messages in the frame.")}};Func.TO_SOURCE=TO_SOURCE,Func.TO_TOPIC=TO_TOPIC,Func.To_MSG=TO_MSG,Func.FUNCTOR=FUNCTOR,Func.ALWAYS_TRUE=ALWAYS_TRUE,Func.ALWAYS_FALSE=ALWAYS_FALSE,Func.NOOP=NOOP;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),slicedToArray=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),toArray=function(e){return Array.isArray(e)?e:Array.from(e)},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},Packet=function(){function e(t,r,n){classCallCheck(this,e),this._msg=t,this._topic=r,this._source=n,this._timestamp=Date.now()}return createClass(e,[{key:"msg",get:function(){return this._msg}},{key:"topic",get:function(){return this._topic}},{key:"source",get:function(){return this._source}},{key:"timestamp",get:function(){return this._timestamp}}]),e}(),DATA_TYPES={ACTION:"action",MIRROR:"mirror",STATE:"state",COMPUTED:"computed",NONE:"none",ANY:"any"},reverseLookup={};for(var p in DATA_TYPES){var v=DATA_TYPES[p];reverseLookup[v]=p}var SubscriberList=function(){function e(t,r){classCallCheck(this,e),this._topic=t,this._subscribers=[],this._lastPacket=null,this._data=r,this._name=r._name,this._dead=!1}return createClass(e,[{key:"handle",value:function(e,t,r){if(!this.dead){t=t||this.topic;var n=this.name,i=new Packet(e,t,n);this.data.type!==DATA_TYPES.ACTION&&(this._lastPacket=i);var a=[].concat(this._subscribers),s=a.length;if(!r)for(var o=0;o<s;o++){var u=a[o];"function"==typeof u?u.call(u,e,i):u.handle(e,i)}}}},{key:"destroy",value:function(){this.dead||(this._subscribers=null,this._lastPacket=null,this._dead=!0)}},{key:"add",value:function(e){this._subscribers.push(e)}},{key:"remove",value:function(e){var t=this._subscribers.indexOf(e);-1!==t&&this._subscribers.splice(t,1)}},{key:"lastPacket",get:function(){return this._lastPacket}},{key:"data",get:function(){return this._data}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"topic",get:function(){return this._topic}}]),e}(),Data=function(){function e(t,r,n){if(classCallCheck(this,e),n=n||DATA_TYPES.NONE,!isValid(n))throw new Error("Invalid Data of type: "+n);this._scope=t,this._name=r,this._type=n,this._dead=!1,this._wildcardSubscriberList=new SubscriberList(null,this),this._subscriberListsByTopic=new Map}return createClass(e,[{key:"destroy",value:function(){this.dead&&this._throwDead();var e=!0,t=!1,r=void 0;try{for(var n,i=this._subscriberListsByTopic.values()[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){n.value.destroy()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}this._dead=!0}},{key:"_demandSubscriberList",value:function(e){e=e||void 0;var t=this._subscriberListsByTopic.get(e);return t||(t=new SubscriberList(e,this),this._subscriberListsByTopic.set(e,t),t)}},{key:"verify",value:function(e){if(this.type===e)return this;throw new Error("Data "+this.name+" requested as type "+e+" exists as "+this.type)}},{key:"follow",value:function(e,t){this.dead&&this._throwDead(),t=t||void 0,this.subscribe(e,t);var r=this.peek();return r&&("function"==typeof e?e.call(e,r.msg,r):e.handle(r.msg,r)),this}},{key:"subscribe",value:function(e,t){return this.dead&&this._throwDead(),t=t||void 0,this._demandSubscriberList(t).add(e),this}},{key:"monitor",value:function(e){return this.dead&&this._throwDead(),this._wildcardSubscriberList.add(e),this}},{key:"unsubscribe",value:function(e,t){return this.dead&&this._throwDead(),t=t||void 0,this._demandSubscriberList(t).remove(e),this._wildcardSubscriberList.remove(e),this}},{key:"topics",value:function(){return this._subscriberListsByTopic.keys()}},{key:"survey",value:function(){var e=this._subscriberListsByTopic.entries(),t=new Map,r=!0,n=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var o=slicedToArray(a.value,2),u=o[0],c=o[1];t.set(u,c.lastPacket)}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return t}},{key:"peek",value:function(e){this.dead&&this._throwDead(),e=e||void 0;var t=this._subscriberListsByTopic.get(e);return t?t.lastPacket:null}},{key:"read",value:function(e){this.dead&&this._throwDead(),e=e||void 0;var t=this.peek(e);return t?t.msg:void 0}},{key:"silentWrite",value:function(e,t){this.dead&&this._throwDead(),t=t||void 0,this.write(e,t,!0)}},{key:"write",value:function(e,t,r){if(this.dead&&this._throwDead(),this.type===DATA_TYPES.MIRROR)throw new Error("Mirror Data: "+this.name+" is read-only");t=t||void 0,this._demandSubscriberList(t).handle(e,t,r),this._wildcardSubscriberList.handle(e,t,r)}},{key:"refresh",value:function(e){this.dead&&this._throwDead(),e=e||void 0;var t=this.peek(e);return t&&this.write(t._msg,e),this}},{key:"toggle",value:function(e){return this.dead&&this._throwDead(),e=e||void 0,this.write(!this.read(e),e),this}},{key:"_throwDead",value:function(){throw new Error("Data: "+this.name+" is already dead.")}},{key:"scope",get:function(){return this._scope}},{key:"name",get:function(){return this._name}},{key:"type",get:function(){return this._type}},{key:"dead",get:function(){return this._dead}}]),e}(),Wave=function(){function e(t){classCallCheck(this,e),this.process=t&&t.process?this[t.process]:pass,this.action=t?t.stateful?t.action.apply(t,toConsumableArray(t.args)):t.action:null}return createClass(e,[{key:"handle",value:function(e,t,r,n,i){this.process(e,t,r,n,i)}},{key:"run",value:function(e,t,r,n,i){this.action(r,n,i),e.emit(t,r,n,i)}},{key:"msg",value:function(e,t,r,n,i){r=this.action(r,n,i),e.emit(t,r,n,i)}},{key:"source",value:function(e,t,r,n,i){n=this.action(r,n,i),e.emit(t,r,n,i)}},{key:"filter",value:function(e,t,r,n,i){this.action(r,n,i)&&e.emit(t,r,n,i)}},{key:"delay",value:function(e,t,r,n,i){function a(){e.emit(t,r,n,i)}setTimeout(a,this.action(r,n,i)||0,r,n,i)}}]),e}(),Pool=function(){function e(t,r,n){function i(e){if(!n[e])return null;var t=toArray(n[e]),r=t[0],i=t[1],a=t.slice(2);return i?r.call.apply(r,[this].concat(toConsumableArray(a))):r}classCallCheck(this,e),this.frame=t,this.wire=r,this.keep=i("keep")||Func.getKeepLast(),this.when=i("when")||Func.ALWAYS_TRUE,this.until=i("until")||Func.ALWAYS_TRUE,this.timer=i("timer"),this.clear=i("clear")||Func.ALWAYS_FALSE,this.isPrimed=!1}return createClass(e,[{key:"handle",value:function(e,t,r,n,i){if(this.keep(r,n,i),!this.isPrimed){var a=this.keep.content();this.when(a)&&(this.isPrimed=!0,this.timer(this))}}},{key:"build",value:function(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this[e]=t.call.apply(t,[this].concat(n))}},{key:"release",value:function(e){e=e||this;var t=!e.keep.isEmpty,r=t&&e.keep.next();e.clear()&&(e.keep.reset(),e.when.reset()),e.isPrimed=!1,t&&e.frame.emit(e.wire,r)}}]),e}(),PoolDef=function e(){classCallCheck(this,e),this.name="pool",this.keep=null,this.when=null,this.until=null,this.timer=null,this.clear=null},Wire=function(){function e(){classCallCheck(this,e),this.target=null,this.dead=!1,this.name=null,this.cleanupMethod=Func.NOOP,this.pull=Func.NOOP}return createClass(e,[{key:"handle",value:function(e,t,r){return!this.dead&&this.target&&this.target.handle(this,e,this.name||t,r),this}},{key:"destroy",value:function(){!this.dead&&this.target&&(this.dead=!0,this.cleanupMethod())}}]),e}();Wire.fromMonitor=function(e,t){var r=new Wire,n=r.name=t||e.name,i=function(e,t,i){r.handle(e,n,i)};return r.cleanupMethod=function(){e.unsubscribe(i)},e.monitor(i),r},Wire.fromSubscribe=function(e,t,r,n){var i=new Wire,a=i.name=r||t||e.name,s=function(e,t,r){i.handle(e,a,r)};return i.cleanupMethod=function(){e.unsubscribe(s,t)},n&&(i.pull=function(){var t=e.peek();if(t){var r=t._msg,n=a||t._source,s=t._topic;i.handle(r,n,s)}}),e.subscribe(s,t),i},Wire.fromEvent=function(e,t,r){r=!!r;var n=new Wire;n.name=t;var i=e.addEventListener||e.addListener||e.on,a=e.removeEventListener||e.removeListener||e.off,s=function(e){n.handle(e,t)};return n.cleanupMethod=function(){a.call(e,t,s,r)},i.call(e,t,s,r),n};for(var Frame=function(){function e(t){classCallCheck(this,e),this._bus=t,this._targets=[],this._index=t._frames.length,this._wireMap=new WeakMap,this._holding=!1,this._processDef=null,this._mergingWire=null}return createClass(e,[{key:"define",value:function(e){return this._processDef=e,this}},{key:"merge",value:function(){return this._mergingWire=new Wire,this}},{key:"handle",value:function(e,t,r,n){if(this._mergingWire)return void this.emit(this._mergingWire,t,r,n);this._wireMap.has(e)||this._wireMap.set(e,this._createHandler(e)),this._wireMap.get(e).handle(this,e,t,r||e.name,n)}},{key:"emit",value:function(e,t,r,n){for(var i=this._targets.length,a=0;a<i;a++){this._targets[a].handle(e,t,r,n)}}},{key:"_createHandler",value:function(e){var t=this._processDef;return t&&"pool"===t.name?new Pool(this,e,t):new Wave(t)}},{key:"hold",value:function(){return this._holding=!0,this._processDef=new PoolDef,this}},{key:"target",value:function(e){this._targets.push(e)}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return this._holding}}]),e}(),WaveDef=function e(t,r,n){classCallCheck(this,e),this.name="wave",this.process=t,this.action=r,this.stateful=n;for(var i=arguments.length,a=Array(i>3?i-3:0),s=3;s<i;s++)a[s-3]=arguments[s];this.args=a},Bus=function(){function e(t){classCallCheck(this,e),this._frames=[],this._wires=[],this._dead=!1,this._scope=t,this._children=[],this._parent=null,t&&t._busList.push(this);var r=new Frame(this);this._frames.push(r),this._currentFrame=r}return createClass(e,[{key:"addFrame",value:function(){var e=this._currentFrame,t=this._currentFrame=new Frame(this);return this._frames.push(t),e.target(t),t}},{key:"spawn",value:function(){}},{key:"split",value:function(){Func.ASSERT_NOT_HOLDING(this)}},{key:"fork",value:function(){Func.ASSERT_NOT_HOLDING(this);var t=new e(this.scope);return t.parent=this,this._currentFrame.target(t._currentFrame),t}},{key:"back",value:function(){if(!this._parent)throw new Error("Cannot exit fork, parent does not exist!");return this.parent}},{key:"join",value:function(){var e=this.back();return e.add(this),e}},{key:"add",value:function(e){var t=this.addFrame();return e._currentFrame.target(t),this}},{key:"defer",value:function(){return this.timer(Func.getDeferTimer)}},{key:"batch",value:function(){return this.timer(Func.getBatchTimer)}},{key:"sync",value:function(){return this.timer(Func.getSyncTimer)}},{key:"throttle",value:function(e){return this.timer(Func.getThrottleTimer,e)}},{key:"hold",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().hold(),this}},{key:"pull",value:function(){for(var e=this._wires.length,t=0;t<e;t++){this._wires[t].pull()}return this}},{key:"event",value:function(e,t,r){var n=Wire.fromEvent(e,t,r);return this.wire(n)}},{key:"subscribe",value:function(e,t,r,n){var i=Wire.fromSubscribe(e,t,r,n);return this.wire(i)}},{key:"wire",value:function(e){return e.target=this._frames[0],this._wires.push(e),this}},{key:"monitor",value:function(e,t){var r=Wire.fromMonitor(e,t);return r.target=this._frames[0],this._wires.push(r),this}},{key:"scan",value:function(e,t){return this.reduce(Func.getScan,e,t)}},{key:"delay",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame().define(new WaveDef("delay",Func.FUNCTOR(e))),this}},{key:"willReset",value:function(){return Func.ASSERT_IS_HOLDING(this),this.clear(Func.getAlwaysTrue)}},{key:"whenKeys",value:function(e){return this.when(Func.getWhenKeys,!0,e)}},{key:"group",value:function(e){return Func.ASSERT_NOT_HOLDING(this),this.hold().reduce(Func.getGroup,e),this}},{key:"groupByTopic",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().hold().reduce(Func.getGroup,Func.TO_TOPIC),this}},{key:"all",value:function(){return this.reduce(Func.getKeepAll)}},{key:"first",value:function(e){return this.reduce(Func.getKeepFirst,e)}},{key:"last",value:function(e){return this.reduce(Func.getKeepLast,e)}},{key:"clear",value:function(e){for(var t,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return(t=this._currentFrame).clear.apply(t,[e].concat(n))}},{key:"reduce",value:function(e){for(var t=this.holding,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(t){this._currentFrame._processDef.keep=[e,!0].concat(n)}else{var a=this.addFrame(),s=new(Function.prototype.bind.apply(WaveDef,[null].concat(["msg",e,!0],n)));a.define(s)}return this}},{key:"timer",value:function(e,t){for(var r=this.holding,n=r?this._currentFrame:this.addFrame().hold(),i=n._processDef,a=arguments.length,s=Array(a>2?a-2:0),o=2;o<a;o++)s[o-2]=arguments[o];return i.timer=[e,t].concat(s),this._currentFrame._holding=!1,this}},{key:"until",value:function(e){for(var t,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(t=this._currentFrame).until.apply(t,[e].concat(i)):(r=this.addFrame().hold().reduce(Func.getKeepLast)).until.apply(r,[e].concat(i)).timer(Func.getSyncTimer),this}},{key:"when",value:function(e,t){for(var r=this.holding,n=arguments.length,i=Array(n>2?n-2:0),a=2;a<n;a++)i[a-2]=arguments[a];if(r){this._currentFrame._processDef.when=[e,t].concat(i)}else{var s=this.addFrame(),o=new(Function.prototype.bind.apply(WaveDef,[null].concat(["filter",e,t],i)));s.define(o)}return this}},{key:"run",value:function(e){return Func.ASSERT_IS_FUNCTION(e),Func.ASSERT_NOT_HOLDING(this),this.addFrame().define(new WaveDef("run",e)),this}},{key:"merge",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().merge(),this}},{key:"msg",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame().define(new WaveDef("msg",Func.FUNCTOR(e))),this}},{key:"transform",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame().transform(e),this}},{key:"source",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame().define(new WaveDef("source",Func.FUNCTOR(e))),this}},{key:"filter",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_IS_FUNCTION(e),Func.ASSERT_NOT_HOLDING(this),this.addFrame().define(new WaveDef("filter",e)),this}},{key:"hasKeys",value:function(e){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().define(new WaveDef("filter",Func.getHasKeys(e))),this}},{key:"skipDupes",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame().define(new WaveDef("filter",Func.getSkipDupes,!0)),this}},{key:"toStream",value:function(){}},{key:"destroy",value:function(){if(this.dead)return this;this._dead=!0;for(var e=this._wires,t=e.length,r=0;r<t;r++){e[r].destroy()}return this}},{key:"children",get:function(){return this._children.map(function(e){return e})}},{key:"parent",get:function(){return this._parent},set:function(e){var t=this.parent;if(t!==e){if(t){var r=t._children.indexOf(this);t._children.splice(r,1)}return this._parent=e,e&&e._children.push(this),this}}},{key:"dead",get:function(){return this._dead}},{key:"holding",get:function(){return this._currentFrame._holding}},{key:"scope",get:function(){return this._scope}}]),e}(),Nyan={},operationDefs=[{name:"ACTION",sym:"^",react:!0,subscribe:!0,need:!0,solo:!0},{name:"WIRE",sym:"~",react:!0,follow:!0},{name:"WATCH",sym:null,react:!0,follow:!0},{name:"EVENT",sym:"@",react:!0,event:!0},{name:"ALIAS",sym:"(",then:!0,solo:!0},{name:"METHOD",sym:"`",then:!0,solo:!0},{name:"READ",sym:null,then:!0,read:!0},{name:"ATTR",sym:"#",then:!0,solo:!0,output:!0},{name:"AND",sym:"&",then:!0},{name:"STYLE",sym:"$",then:!0,solo:!0,output:!0},{name:"WRITE",sym:"=",then:!0,solo:!0},{name:"SPRAY",sym:"<",then:!0},{name:"RUN",sym:"*",then:!0,output:!0},{name:"FILTER",sym:">",then:!0}],operationsBySymbol={},operationsByName={},symbolsByName={},namesBySymbol={},reactionsByName={},withReactionsByName={},thenByName={},i=0;i<operationDefs.length;i++){var op=operationDefs[i],name=op.name,sym=op.sym;sym&&(operationsBySymbol[sym]=op,namesBySymbol[sym]=name),operationsByName[name]=op,symbolsByName[name]=sym,op.then&&(thenByName[name]=!0),op.react&&(reactionsByName[name]=!0,withReactionsByName[name]=!0)}var NyanWord=function e(t,r,n,i,a,s,o,u){classCallCheck(this,e),this.name=t,this.operation=r,this.maybe=n||!1,this.need=i||!1,this.topic=a||null,this.alias=s||null,this.monitor=o||!1,this.extracts=u&&u.length?u:null},tickStack=[];Nyan.parse=parse;var Stream=function(){function e(){classCallCheck(this,e),this.dead=!1,this.children=[],this.name=null,this.pool=null,this.cleanupMethod=Func.NOOP,this.pull=Func.NOOP,this.processMethod=this.emit,this.actionMethod=null}return createClass(e,[{key:"handle",value:function(e,t){return this.dead?this:(this.processMethod(e,this.name||t),this)}},{key:"drop",value:function(e){var t=this.children,r=t.indexOf(e);-1!==r&&t.splice(r,1)}},{key:"addTarget",value:function(e){this.children.push(e)}},{key:"emit",value:function(e,t,r,n){n=n||this,t=n.name||t;for(var i=n.children,a=i.length,s=0;s<a;s++){i[s].handle(e,t,r)}}},{key:"doFilter",value:function(e,t,r){this.actionMethod(e,t,r)&&this.emit(e,t,r)}},{key:"doMsg",value:function(e,t,r){e=this.actionMethod(e,t,r),this.emit(e,t,r)}},{key:"doTransform",value:function(e,t,r){e=this.actionMethod.msg?this.actionMethod.msg(e,t,r):e,t=this.actionMethod.source?this.actionMethod.source(e,t,r):t,r=this.actionMethod.topic?this.actionMethod.topic(e,t,r):r,this.emit(e,t,r)}},{key:"doDelay",value:function(e,t,r){setTimeout(this.emit,this.actionMethod(e,t,r)||0,e,t,r,this)}},{key:"doSource",value:function(e,t,r){this.name=this.actionMethod(),this.emit(e,this.name||t,r)}},{key:"doRun",value:function(e,t,r){this.actionMethod(e,t,r),this.emit(e,t,r)}},{key:"createPool",value:function(){this.pool=new Pool(this)}},{key:"doPool",value:function(e,t,r){this.pool.handle(e,this.name||t,r)}},{key:"destroy",value:function(){this.dead||this.cleanupMethod()}}]),e}();Stream.fromMonitor=function(e,t,r){var n=new Stream,i=t||e.name;n.name=i;var a=function(e,t,r){n.emit(e,i,r)};return n.cleanupMethod=function(){e.unsubscribe(a)},r&&(n.pull=function(){var t=e.survey();if(t){var r=t._msg,a=i||t._source,s=t._topic;n.emit(r,a,s,n)}}),e.monitor(a),n},Stream.fromSubscribe=function(e,t,r,n){var i=new Stream,a=r||t||e.name;i.name=a;var s=function(e,t,r){i.emit(e,a,r)};return i.cleanupMethod=function(){e.unsubscribe(s,t)},n&&(i.pull=function(){var t=e.peek();if(t){var r=t._msg,n=a||t._source,s=t._topic;i.emit(r,n,s,i)}}),e.subscribe(s,t),i},Stream.fromEvent=function(e,t,r){r=!!r;var n=new Stream;n.name=t;var i=e.addEventListener||e.addListener||e.on,a=e.removeEventListener||e.removeListener||e.off,s=function(e){n.handle(e,t)};return n.cleanupMethod=function(){a.call(e,t,s,r)},i.call(e,t,s,r),n};var idCounter=0,Scope=function(){function e(t){classCallCheck(this,e),this._id=++idCounter,this._name=t,this._parent=null,this._children=[],this._busList=[],this._dataList=new Map,this._valves=new Map,this._mirrors=new Map,this._dead=!1}return createClass(e,[{key:"react",value:function(e,t,r){if(!e)throw new Error("Need a Nyan phrase!");return nyanToBus(this,new Bus(this),e,t,r)}},{key:"clear",value:function(){this._dead||(_destroyEach(this.children),_destroyEach(this._busList),_destroyEach(this._dataList.values()),this._children=[],this._busList=[],this._dataList.clear(),this._valves.clear(),this._mirrors.clear())}},{key:"destroy",value:function(){this.clear(),this.parent=null,this._dead=!0}},{key:"createChild",value:function(t){var r=new e(t);return r.parent=this,r}},{key:"insertParent",value:function(e){return e.parent=this.parent,this.parent=e,this}},{key:"_createMirror",value:function(e){var t=Object.create(e);return t._type=DATA_TYPES.MIRROR,this._mirrors.set(e.name,t),t}},{key:"_createData",value:function(e,t){var r=new Data(this,e,t);return this._dataList.set(e,r),r}},{key:"data",value:function(e){return this.grab(e)||this._createData(e,DATA_TYPES.NONE)}},{key:"action",
value:function(e){var t=this.grab(e);return t?t.verify(DATA_TYPES.ACTION):this._createData(e,DATA_TYPES.ACTION)}},{key:"state",value:function(e){var t=this.grab(e);if(t)return t.verify(DATA_TYPES.STATE);var r=this._createData(e,DATA_TYPES.STATE);return this._createMirror(r),r}},{key:"findDataSet",value:function(e,t){var r={},n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=s.value;r[u]=this.find(u,t)}}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}},{key:"readDataSet",value:function(e,t){var r=this.findDataSet(e,t),n={},i=!0,a=!1,s=void 0;try{for(var o,u=r[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var c=o.value;if(c){var h=c.peek();h&&(n[c.name]=h.msg)}}}catch(e){a=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(a)throw s}}return n}},{key:"flatten",value:function(){var e=this,t=new Map,r=new Map,n=!0,i=!1,a=void 0;try{for(var s,o=e._dataList[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=slicedToArray(s.value,2),c=u[0],h=u[1];t.set(c,h)}}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}for(;e=e._parent;){var l=e._dataList,f=e._valves,d=e._mirrors;if(l.size){if(f.size)if(r.size){var v=!0,y=!1,m=void 0;try{for(var p,_=r.keys()[Symbol.iterator]();!(v=(p=_.next()).done);v=!0){var g=p.value;f.has(g)||r.delete(g)}}catch(e){y=!0,m=e}finally{try{!v&&_.return&&_.return()}finally{if(y)throw m}}}else{var k=!0,b=!1,S=void 0;try{for(var w,T=f.entries()[Symbol.iterator]();!(k=(w=T.next()).done);k=!0){var E=slicedToArray(w.value,2),A=E[0],h=E[1];r.set(A,h)}}catch(e){b=!0,S=e}finally{try{!k&&T.return&&T.return()}finally{if(b)throw S}}}var D=r.size?r:l,F=!0,O=!1,N=void 0;try{for(var R,C=D.keys()[Symbol.iterator]();!(F=(R=C.next()).done);F=!0){var L=R.value;if(!t.has(L)){var M=d.get(L)||l.get(L);M&&t.set(L,M)}}}catch(e){O=!0,N=e}finally{try{!F&&C.return&&C.return()}finally{if(O)throw N}}}}return t}},{key:"find",value:function(e,t){var r=this.grab(e);if(r)return r;for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(e))break;var a=n._mirrors.get(e);if(a)return a;var s=n.grab(e);if(s)return s}if(t)throw new Error("Required data: "+e+" not found!");return null}},{key:"findOuter",value:function(e,t){var r=!1;this.grab(e)&&(r=!0);for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(e))break;var a=n._mirrors.get(e);if(a){if(r)return a;r=!0}else{var s=n.grab(e);if(s){if(r)return s;r=!0}}}if(t)throw new Error("Required data: "+e+" not found!");return null}},{key:"grab",value:function(e,t){var r=this._dataList.get(e);if(!r&&t)throw new Error("Required Data: "+e+" not found!");return r||null}},{key:"transaction",value:function(e){if(Array.isArray(e))return this._multiWriteArray(e);if("object"===(void 0===e?"undefined":_typeof(e)))return this._multiWriteHash(e);throw new Error("Write values must be in an array of object hash.")}},{key:"_multiWriteArray",value:function(e){var t=[],r=!0,n=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var o=a.value,u=this.find(o.name);u.silentWrite(o.value,o.topic),t.push(u)}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}var c=!0,h=!1,l=void 0;try{for(var f,d=t[Symbol.iterator]();!(c=(f=d.next()).done);c=!0){var v=f.value,y=e[0];v.refresh(y.topic)}}catch(e){h=!0,l=e}finally{try{!c&&d.return&&d.return()}finally{if(h)throw l}}return this}},{key:"_multiWriteHash",value:function(e){var t=[];for(var r in e){var n=e[r],i=this.find(r);i.silentWrite(n),t.push(i)}var a=!0,s=!1,o=void 0;try{for(var u,c=t[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){u.value.refresh()}}catch(e){s=!0,o=e}finally{try{!a&&c.return&&c.return()}finally{if(s)throw o}}return this}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"children",get:function(){return this._children.map(function(e){return e})}},{key:"parent",get:function(){return this._parent},set:function(e){var t=this.parent;if(t!==e){if(t){var r=t._children.indexOf(this);t._children.splice(r,1)}return this._parent=e,e&&e._children.push(this),this}}},{key:"valves",set:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=e[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value;this._valves.set(s,!0)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}},get:function(){return Array.from(this._valves.keys())}}]),e}(),Catbus$1={},_batchQueue=[],_primed=!1;Catbus$1.fromEvent=function(e,t,r){var n=new Bus;return n.event(e,t,r),n},Catbus$1.enqueue=function(e){_batchQueue.push(e),_primed||(_primed=!0,"undefined"!=typeof window&&window.requestAnimationFrame?requestAnimationFrame(Catbus$1.flush):process.nextTick(Catbus$1.flush))},Catbus$1.createChild=Catbus$1.scope=function(e){return new Scope(e)},Catbus$1.flush=function(){_primed=!1;var e=0,t=_batchQueue;for(_batchQueue=[];t.length;){for(;t.length;){t.shift().release()}if(t=_batchQueue,_batchQueue=[],++e>10)throw new Error("Flush batch cycling loop > 10.",t)}},module.exports=Catbus$1;
