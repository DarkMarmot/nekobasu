"use strict";function isValid(e){return reverseLookup.hasOwnProperty(e)}function ALWAYS_TRUE(){return!0}function ALWAYS_FALSE(){return!1}function TO_SOURCE(e,t){return t}function TO_TOPIC(e,t,n){return n}function TO_MSG(e){return e}function NOOP(){}function FUNCTOR(e){return"function"==typeof e?e:function(){return e}}function callMany(e,t,n,r){for(var i=e.length,a=0;a<i;a++){var s=e[a];s.call(s,t,n,r)}}function callNoOne(e,t,n,r){}function callOne(e,t,n,r){var i=e[0];i.call(i,t,n,r)}function pass(e,t,n,r,i){e.emit(t,n,r,i)}function callback(e,t,n,r,i){e.emit(t,n,r,i)}function TO_SOURCE$1(e,t,n){return t}function toTickStackString(e){tickStack=[];for(var t=e.split(/([`])/),n=[],r=!1;t.length;){var i=t.shift();"`"===i?(r=!r,n.push(i)):r?tickStack.push(i):n.push(i)}return n.join("")}function parse(e,t){e=toTickStackString(e);for(var n=[],r=e.split(/([{}]|-})/).map(function(e){return e.trim()}).filter(function(e){return e}),i=0;i<r.length;i++){var a=r[i],s="}"===a||"{"===a||"-}"===a?a:parseSentence(a);("string"==typeof s||s.length>0)&&n.push(s)}return validate(n,t)}function validate(e,t){for(var n=[],r=!0,i=0;i<e.length;i++){var a=e[i];if("string"!=typeof a)for(var s=0;s<a.length;s++){var u=a[s];r&&!t?(validateReactPhrase(u),r=!1,n.push({name:"REACT",phrase:u})):(validateProcessPhrase(u),n.push({name:"PROCESS",phrase:u}))}else"{"===a?n.push({name:"FORK"}):"}"===a?n.push({name:"BACK"}):"-}"===a&&n.push({name:"JOIN"})}return n}function validateReactPhrase(e){for(var t=!1,n=0;n<e.length;n++){var r=e[n],i=r.operation=r.operation||"WATCH";if(t=t||reactionsByName[i],!withReactionsByName[i])throw new Error("This Nyan command cannot be in a reaction!")}if(!t)throw new Error("Nyan commands must begin with an observation!")}function validateProcessPhrase(e){var t=e[0],n=t.operation||"READ";if(!thenByName[n])throw new Error("Illegal operation in phrase!");for(var r=0;r<e.length;r++){var i=e[r];if(i.operation=i.operation||n,i.operation!==n)throw new Error("Multiple operation types in phrase (only one allowed)!")}}function parseSentence(e){for(var t=[],n=e.split("|").map(function(e){return e.trim()}).filter(function(e){return e}),r=0;r<n.length;r++){var i=n[r],a=parsePhrase(i);t.push(a)}return t}function parsePhrase(e){for(var t=[],n=e.split(",").map(function(e){return e.trim()}).filter(function(e){return e}),r=n.length,i=0;i<r;i++){for(var a=n[i],s=a.split(/([(?!:.`)])/),u=[],o=!1;s.length;){var l=s.shift();if("`"===l)o=!o,u.push(l);else if(o)u.push(l);else{var c=l.trim();c&&u.push(c)}}var h=u.shift(),f=a[0],v=namesBySymbol[f],y=v?1:0,d=h.slice(y).trim(),m=[],p=!1,_=!1,g=null,k=null,b=!1;if("ALIAS"===v)k=u.shift(),u.shift();else if("METHOD"===v){u.shift();var w=tickStack.shift(),S=w.indexOf(" ");for(-1===S?m.push(w):(m.push(w.slice(0,S)),w.length>S&&m.push(w.slice(S+1)));u.length;)u.shift()}for(;u.length;){switch(u.shift()){case".":var T=u.length&&u[0],F=u.length>1&&"?"===u[1];T&&(m.push({name:T,silentFail:F}),u.shift(),F&&u.shift());break;case"?":p=!0;break;case"!":b=!0;break;case":":if(u.length){var A=u[0];"("===A?_=!0:(g=A,u.shift())}else _=!0;break;case"(":u.length&&(k=u.shift())}}k=k||g||d;var E=new NyanWord(d,v,p,b,g,k,_,m);t.push(E)}return t}function getSurveyFromDataWord(e,t){var n=e.find(t.name,!t.maybe);return n&&n.survey()}function throwError(e){console.log("throwing ",e);var t=new Error(e);throw console.log(this,t),t}function getDoSkipNamedDupes(e){var t={},n=e.length;return function(r){for(var i=!1,a=0;a<n;a++){var s=e[a];t.hasOwnProperty(s)&&t[s]===r[s]||(i=!0),t[s]=r[s]}return i}}function getDoWrite(e,t){var n=e.find(t.name,!t.maybe);return function(e){n.write(e,t.topic)}}function getDoSpray(e,t){for(var n={},r={},i=t.length,a=0;a<i;a++){var s=t[a],u=e.find(s.name,!s.maybe);u&&(n[s.alias]=s,r[s.alias]=u)}return function(e){for(var t in e){var i=r[t];if(i){var a=n[t],s=e[t];i.silentWrite(s,a.topic)}}for(var u in e){var o=r[u];if(o){var l=n[u];o.refresh(l.topic)}}}}function getDoRead(e,t){var n=t.length,r=t[0];return n>1||r.monitor?getDoReadMultiple(e,t):getDoReadSingle(e,r)}function getDoAnd(e,t){return getDoReadMultiple(e,t,!0)}function getDoReadSingle(e,t){var n=e.find(t.name,!t.maybe),r=t.topic;return function(){return n.read(r)}}function getDoReadMultiple(e,t,n){var r=t.length;return function(i,a){var s={};if(n)if(a)s[a]=i;else for(var u in i)s[u]=i[u];for(var o=0;o<r;o++){var l=t[o];if(l.monitor){var c=getSurveyFromDataWord(e,l),h=!0,f=!1,v=void 0;try{for(var y,d=c[Symbol.iterator]();!(h=(y=d.next()).done);h=!0){var m=slicedToArray(y.value,2),p=m[0],_=m[1];s[p]=_}}catch(e){f=!0,v=e}finally{try{!h&&d.return&&d.return()}finally{if(f)throw v}}}else{var g=e.find(l.name,!l.maybe),k=l.monitor?l.alias||l.topic:l.alias||l.name;g.present(l.topic)&&(s[k]=g.read(l.topic))}}return s}}function getDataWire(e,t,n){var r=e.find(t.name,!t.maybe);return t.monitor?Wire.fromMonitor(r,t.alias,n):Wire.fromSubscribe(r,t.topic,t.alias,n)}function isObject(e){return null!==e&&("function"==typeof e||"object"===(void 0===e?"undefined":_typeof(e)))}function getEventWire(e,t){return Wire.fromEvent(t,e.topic,e.useCapture,e.alias)}function doExtracts(e,t){for(var n=e,r=t.length,i=0;i<r;i++){var a=t[i];if(!isObject(n)){if(a.silentFail)return;throwError("Cannot access property '"+a.name+"' of "+n)}n=n[a.name]}return n}function getNeedsArray(e){return e.filter(function(e){return e.operation.need}).map(function(e){return e.alias})}function getDoMsgHashExtract(e){for(var t=e.length,n={},r=0;r<t;r++){var i=e[r];n[i.alias]=i.extracts}return function(e){var t={};for(var r in n){e.hasOwnProperty(r)&&(t[r]=doExtracts(e[r],n[r]))}return t}}function getDoMsgExtract(e){var t=e.extracts;return function(e){return doExtracts(e,t)}}function applyReaction(e,t,n,r){var i=[],a=[],s=[];if(1===n.length&&"ACTION"===n[0].operation){var u=n[0];return void t.wire(getDataWire(e,u,!1))}for(var o=0;o<n.length;o++){var l=n[o],c=l.operation;"WATCH"===c?(t.wire(getDataWire(e,l,!0)),a.push(l.alias)):"WIRE"===c?t.wire(getDataWire(e,l,!0)):"EVENT"===c&&t.wire(getEventWire(l,r)),l.extracts&&s.push(l),l.need&&i.push(l.alias)}t._wires.length>1?(t.merge().group().batch(),s.length&&t.msg(getDoMsgHashExtract(s)),i.length&&t.hasKeys(i),a.length&&t.filter(getDoSkipNamedDupes(a))):(s.length&&t.msg(getDoMsgExtract(s[0])),a.length&&t.skipDupes())}function isTruthy(e){return!!e}function isFalsey(e){return!e}function applyMethod(e,t){switch(t.extracts[0]){case"true":e.msg(!0);break;case"false":e.msg(!1);break;case"null":e.msg(null);break;case"undefined":e.msg(void 0);break;case"array":e.msg([]);break;case"object":e.msg({});break;case"truthy":e.filter(isTruthy);break;case"falsey":e.filter(isFalsey);break;case"string":e.msg(function(){return t.extracts[1]})}}function applyProcess(e,t,n,r,i){var a=n[0].operation;if("READ"===a){t.msg(getDoRead(e,n));var s=getNeedsArray(n);s.length&&t.whenKeys(s)}else if("AND"===a){t.msg(getDoAnd(e,n));var u=getNeedsArray(n);u.length&&t.whenKeys(u)}else"METHOD"===a?applyMethod(t,n[0]):"FILTER"===a?applyFilterProcess(t,n,r):"RUN"===a?applyMsgProcess(t,n,r):"ALIAS"===a?applySourceProcess(t,n[0]):"WRITE"===a?t.run(getDoWrite(e,n[0])):"SPRAY"===a&&t.run(getDoSpray(e,n))}function applyMsgProcess(e,t,n){for(var r=t.length,i=0;i<r;i++)!function(r){var i=t[r],a=i.name,s=n[a],u=function(e,t,r){return s.call(n,e,t,r)};e.msg(u)}(i)}function applySourceProcess(e,t){e.source(t.alias)}function applyFilterProcess(e,t,n){for(var r=t.length,i=0;i<r;i++)!function(r){var i=t[r],a=i.name,s=n[a],u=function(e,t,r){return s.call(n,e,t,r)};e.filter(u)}(i)}function createBus(e,t,n,r){return applyNyan(e,new Bus(t),n,r)}function applyNyan(e,t,n,r){for(var i=e.length,a=t.scope,s=0;s<i;s++){var u=e[s],o=u.name,l=u.phrase;"JOIN"===o?(t=t.join(),t.merge(),t.group()):"FORK"===o?t=t.fork():"BACK"===o?t=t.back():"PROCESS"===o?applyProcess(a,t,l,n,r):applyReaction(a,t,l,r)}return t}function _destroyEach(e){for(var t=e.length,n=0;n<t;n++){e[n].destroy()}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var s,u=e[Symbol.iterator]();!(r=(s=u.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{!r&&u.return&&u.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),toArray=function(e){return Array.isArray(e)?e:Array.from(e)},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},Packet=function(){function e(t,n,r){classCallCheck(this,e),this._msg=t,this._topic=n,this._source=r,this._timestamp=Date.now()}return createClass(e,[{key:"msg",get:function(){return this._msg}},{key:"topic",get:function(){return this._topic}},{key:"source",get:function(){return this._source}},{key:"timestamp",get:function(){return this._timestamp}}]),e}(),DATA_TYPES={ACTION:"action",MIRROR:"mirror",STATE:"state",COMPUTED:"computed",NONE:"none",ANY:"any"},reverseLookup={};for(var p in DATA_TYPES){var v=DATA_TYPES[p];reverseLookup[v]=p}var Func={ASSERT_NEED_ONE_ARGUMENT:function(e){if(e.length<1)throw new Error("Method requires at least one argument.")},ASSERT_IS_FUNCTION:function(e){if("function"!=typeof e)throw new Error("Argument [func] is not of type function.")},getAlwaysTrue:function(){return function(){return!0}},getBatchTimer:function(e){Catbus$1.enqueue(e)},getSyncTimer:function(){return function(e){e.release(e)}},getDeferTimer:function(){return function(e){setTimeout(e.release,0,e)}},getThrottleTimer:function(e){function t(s){if(!n.stream.dead){var u=n.keep.isEmpty;if(!s)return void(i?a=!0:(n.release(n),r=!1,i=setTimeout(t,e.call(n),!0)));u?r||(r=!0,a=!1,i=setTimeout(t,e.call(n),!0)):(n.release(n),r=!1,i=setTimeout(t,e.call(n),!0))}}var n=this;e=FUNCTOR(e);var r=!1,i=null,a=!1;n.keep.auto;return t},getQueue:function(e){e=e||1/0;var t=[],n=function(n,r){return t.length<e&&t.push(n),t};return n.isBuffer=ALWAYS_TRUE,n.next=function(){return t.shift()},n.isEmpty=function(){return 0===t.length},n.content=function(){return t},n},getScan:function(e,t){var n=2===arguments.length,r=void 0,i=!0,a=function(a,s){return i?(i=!1,r=n?e(t,a,s):a):r=e(r,a,s),r};return a.reset=NOOP,a.next=a.content=function(){return r},a},getGroup:function(e){e=e||TO_SOURCE;var t={},n=function(n,r){var i=e(n,r);if(i)t[i]=n;else for(var a in n)t[a]=n[a];return t};return n.reset=function(){for(var e in t)delete t[e];n.isEmpty=!0},n.next=n.content=function(){return t},n},getHash:function(e){e=e||TO_SOURCE;var t={},n=function(n,r){var i=e(n,r);return t[i]=n,t};return n.reset=function(){for(var e in t)delete t[e];n.isEmpty=!0},n.next=n.content=function(){return t},n},getKeepLast:function(e){if(!e||e<0){var t=void 0,n=function(e,n){return t=e};return n.reset=function(){n.isEmpty=!0},n.next=n.content=function(){return t},n}var r=[],i=function(t,n){return r.push(t),r.length>e&&r.shift(),r};return i.reset=function(){for(;r.length;)r.shift();i.isEmpty=!0},i.next=i.content=function(){return r},i},getKeepFirst:function(e){if(!e||e<0){var t=void 0,n=function(e,n){return t=e};return n.reset=function(){t=!1,n.isEmpty=!0},n.next=n.content=function(){return t},n}var r=[],i=function(t,n){return r.length<e&&r.push(t),r};return i.reset=function(){for(;r.length;)r.shift();i.isEmpty=!0},i.next=i.content=function(){return r},i},getKeepAll:function(){var e=[],t=function(t,n){return e.push(t),e};return t.reset=function(){for(;e.length;)e.shift();t.isEmpty=!0},t.next=t.content=function(){return e},t},getWhenCount:function(e){var t=!1,n=function(n){return t=t||n.length>=e};return n.reset=function(){t=!1},n},getWhenKeys:function(e){for(var t={},n=e.length,r=0;r<n;r++){var i=e[r];t[i]=!0}var a=!1,s=function(t){if(a)return!0;for(var r=0;r<n;r++){var i=e[r];if(!t.hasOwnProperty(i))return!1}return a=!0};return s.reset=function(){a=!1;for(var e in t)delete t[e]},s},getHasKeys:function(e,t){var n=!1,r=e.length;return function(i){if(n||!r)return!0;for(var a=0;a<r;a++){var s=e[a];if(!i.hasOwnProperty(s))return!1}return t||(n=!0),!0}},getSkipDupes:function(){var e=!1,t=void 0;return function(n){var r=!e||n!==t;return t=n,e=!0,r}},ASSERT_NOT_HOLDING:function(e){if(e.holding)throw new Error("Method cannot be invoked while holding messages in the frame.")},ASSERT_IS_HOLDING:function(e){if(!e.holding)throw new Error("Method cannot be invoked unless holding messages in the frame.")}};Func.TO_SOURCE=TO_SOURCE,Func.TO_TOPIC=TO_TOPIC,Func.To_MSG=TO_MSG,Func.FUNCTOR=FUNCTOR,Func.ALWAYS_TRUE=ALWAYS_TRUE,Func.ALWAYS_FALSE=ALWAYS_FALSE,Func.NOOP=NOOP;var SubscriberList=function(){function e(t,n){classCallCheck(this,e),this._topic=t,this._subscribers=[],this._callback=callNoOne,this._used=!1,this._lastMsg=null,this._lastTopic=null,this._data=n,this._name=n._name,this._dead=!1,n.type===DATA_TYPES.ACTION&&(this.handle=this.handleAction)}return createClass(e,[{key:"handle",value:function(e,t,n){this._used=!0,t=t||this.topic;var r=this.name;this._lastMsg=e,this._lastTopic=t,n||this._callback(this._subscribers,e,r,t)}},{key:"handleAction",value:function(e,t){t=t||this.topic;var n=this.name;this._callback(this._subscribers,e,n,t)}},{key:"destroy",value:function(){this._subscribers=null,this._lastMsg=null,this._dead=!0}},{key:"add",value:function(e){var t="function"==typeof e?e:function(t,n,r){e.handle(t,n,r)};return this._subscribers.push(t),this.determineCaller(),this}},{key:"remove",value:function(e){var t=this._subscribers.indexOf(e);return-1!==t&&this._subscribers.splice(t,1),this.determineCaller(),this}},{key:"determineCaller",value:function(){var e=this._subscribers.length;this._callback=0===e?callNoOne:1==e?callOne:callMany}},{key:"used",get:function(){return this._used}},{key:"lastMsg",get:function(){return this._lastMsg}},{key:"lastTopic",get:function(){return this._lastTopic}},{key:"data",get:function(){return this._data}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"topic",get:function(){return this._topic}}]),e}(),Data=function(){function e(t,n,r){if(classCallCheck(this,e),r=r||DATA_TYPES.NONE,!isValid(r))throw new Error("Invalid Data of type: "+r);this._scope=t,this._name=n,this._type=r,this._dead=!1,this._noTopicList=new SubscriberList(null,this),this._wildcardSubscriberList=new SubscriberList(null,this),this._subscriberListsByTopic={}}return createClass(e,[{key:"destroy",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,i=this._subscriberListsByTopic.values()[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.destroy()}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}this._dead=!0}},{key:"_demandSubscriberList",value:function(e){e=e||null;var t=e?this._subscriberListsByTopic[e]:this._noTopicList;return t||(t=new SubscriberList(e,this),this._subscriberListsByTopic[e]=t,t)}},{key:"verify",value:function(e){if(this.type===e)return this;throw new Error("Data "+this.name+" requested as type "+e+" exists as "+this.type)}},{key:"follow",value:function(e,t){var n=this.subscribe(e,t);return n.used&&("function"==typeof e?e.call(e,n.lastMsg,n.source,n.lastTopic):e.handle(n.lastMsg,n.source,n.lastTopic)),this}},{key:"subscribe",value:function(e,t){return this._demandSubscriberList(t).add(e)}},{key:"monitor",value:function(e){return this._wildcardSubscriberList.add(e),this}},{key:"unsubscribe",value:function(e,t){return t=t||null,this._demandSubscriberList(t).remove(e),this._wildcardSubscriberList.remove(e),this}},{key:"survey",value:function(){throw new Error("not imp")}},{key:"present",value:function(e){return this._demandSubscriberList(e).used}},{key:"read",value:function(e){var t=this._demandSubscriberList(e);return t.used?t.lastMsg:void 0}},{key:"silentWrite",value:function(e,t){this.write(e,t,!0)}},{key:"write",value:function(e,t,n){if(this.type===DATA_TYPES.MIRROR)throw new Error("Mirror Data: "+this.name+" is read-only");this._demandSubscriberList(t).handle(e,t,n),this._wildcardSubscriberList.handle(e,t,n)}},{key:"refresh",value:function(e){var t=this._demandSubscriberList(e);return t.used&&this.write(t.lastMsg,t.lastTopic),this}},{key:"toggle",value:function(e){return this.write(!this.read(e),e),this}},{key:"_throwDead",value:function(){throw new Error("Data: "+this.name+" is already dead.")}},{key:"scope",get:function(){return this._scope}},{key:"name",get:function(){return this._name}},{key:"type",get:function(){return this._type}},{key:"dead",get:function(){return this._dead}}]),e}(),Wave=function(){function e(t){classCallCheck(this,e),this.process=t&&t.process?this[t.process]:pass,this.action=t?t.stateful?t.action.apply(t,toConsumableArray(t.args)):t.action:null}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){this.process(e,t,n,r,i)}},{key:"run",value:function(e,t,n,r,i){this.action(n,r,i),e.emit(t,n,r,i)}},{key:"msg",value:function(e,t,n,r,i){n=this.action(n,r,i),e.emit(t,n,r,i)}},{key:"source",value:function(e,t,n,r,i){r=this.action(n,r,i),e.emit(t,n,r,i)}},{key:"filter",value:function(e,t,n,r,i){this.action(n,r,i)&&e.emit(t,n,r,i)}},{key:"split",value:function(e,t,n,r,i){for(var a=n.length||0,s=0;s<a;s++){var u=n[s];e.emit(t,u,r,i)}}},{key:"delay",value:function(e,t,n,r,i){function a(){e.emit(t,n,r,i)}setTimeout(a,this.action(n,r,i)||0,n,r,i)}}]),e}(),Pool=function(){function e(t,n,r){function i(e){if(!r[e])return null;var t=toArray(r[e]),n=t[0],i=t[1],a=t.slice(2);return i?n.call.apply(n,[this].concat(toConsumableArray(a))):n}classCallCheck(this,e),this.frame=t,this.wire=n,this.keep=i("keep")||Func.getKeepLast(),this.when=i("when")||Func.ALWAYS_TRUE,this.until=i("until")||Func.ALWAYS_TRUE,this.timer=i("timer"),this.clear=i("clear")||Func.ALWAYS_FALSE,this.isPrimed=!1}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){if(this.keep(n,r,i),!this.isPrimed){var a=this.keep.content();this.when(a)&&(this.isPrimed=!0,this.timer(this))}}},{key:"build",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];this[e]=t.call.apply(t,[this].concat(r))}},{key:"release",value:function(e){e=e||this;var t=!e.keep.isEmpty,n=t&&e.keep.next();e.clear()&&(e.keep.reset(),e.when.reset()),e.isPrimed=!1,t&&e.frame.emit(e.wire,n)}}]),e}(),Tap=function(){function e(t){classCallCheck(this,e),this.action=t.action,this.value=null,this.stateful=!1}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){this.action(n,r,i),e.emit(t,n,r,i)}}]),e}(),Msg=function(){function e(t){classCallCheck(this,e),this.action=t.action,this.value=null,this.stateful=!1}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){var a=this.action(n,r,i);e.emit(t,a,r,i)}}]),e}(),Source=function(){function e(t){classCallCheck(this,e),this.action=t.action,this.value=null,this.stateful=!1}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){var a=this.action(n,r,i);e.emit(t,n,a,i)}}]),e}(),Filter=function(){function e(t){classCallCheck(this,e),this.action=t.action,this.value=null,this.stateful=!1}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){this.action(n,r,i)&&e.emit(t,n,r,i)}}]),e}(),Delay=function(){function e(t){classCallCheck(this,e),this.action=t.action,this.value=null}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){setTimeout(callback,this.action(n,r,i)||0,e,t,n,r,i)}}]),e}(),Scan=function(){function e(t){classCallCheck(this,e),this.action=t.action,this.value=0,this.stateful=!0}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){this.value=this.action(this.value,n,r,i),e.emit(t,this.value,r,i)}}]),e}(),SkipDupes=function(){function e(){classCallCheck(this,e),this.value=null,this.hadValue=!1}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){this.hadValue&&this.value===n||(e.emit(t,n,r,i),this.hadValue=!0,this.value=n)}}]),e}(),LastN=function(){function e(t){classCallCheck(this,e),this.value=[],this.max=t}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){var a=this.value;a.push(n),a.length>this.max&&a.shift(),e.emit(t,a,r,i)}},{key:"reset",value:function(){this.value=[]}},{key:"next",value:function(){return this.value}},{key:"content",value:function(){return this.value}}]),e}(),FirstN=function(){function e(t){classCallCheck(this,e),this.value=[],this.max=t}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){var a=this.value;a.length<this.max&&a.push(n),e.emit(t,a,r,i)}},{key:"reset",value:function(){this.value=[]}},{key:"next",value:function(){return this.value}},{key:"content",value:function(){return this.value}}]),e}(),All=function(){function e(){classCallCheck(this,e),this.value=[],this.hasValue=!1}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){var a=this.value;a.push(n),e.emit(t,a,r,i)}},{key:"reset",value:function(){this.value=[]}},{key:"next",value:function(){return this.value}},{key:"content",value:function(){return this.value}}]),e}(),Group=function(){function e(t){classCallCheck(this,e),this.action=t.action||TO_SOURCE$1,this.value={}}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){var a=this.action(n,r),s=this.value;if(a)s[a]=n;else for(var u in n)s[u]=n[u];e.emit(t,s,r,i)}},{key:"reset",value:function(){this.value={}}},{key:"next",value:function(){return this.value}},{key:"content",value:function(){return this.value}}]),e}(),PASS={handle:function(e,t,n,r,i){e.emit(t,n,r,i)}},SPLIT={handle:function(e,t,n,r,i){for(var a=n.length||0,s=0;s<a;s++){var u=n[s];e.emit(t,u,r,i)}}},Handler=function(){function e(t){classCallCheck(this,e),this.process=t&&t.process?this[t.process](t):PASS}return createClass(e,[{key:"handle",value:function(e,t,n,r,i){this.process.handle(e,t,n,r,i)}},{key:"eddy",value:function(e){return new Eddy(e)}},{key:"tap",value:function(e){return new Tap(e)}},{key:"msg",value:function(e){return new Msg(e)}},{key:"source",value:function(e){return new Source(e)}},{key:"filter",value:function(e){return new Filter(e)}},{key:"skipDupes",value:function(e){return new SkipDupes(e)}},{key:"delay",value:function(e){return new Delay(e)}},{key:"scan",value:function(e){return new Scan(e)}},{key:"group",value:function(e){return new Group(e)}},{key:"lastN",value:function(e){return new LastN(e.args[0])}},{key:"firstN",value:function(e){return new FirstN(e.args[0])}},{key:"all",value:function(){return new All}},{key:"split",value:function(){return SPLIT}}]),e}(),Frame=function(){function e(t,n){classCallCheck(this,e),this._bus=t,this._nextFrame=null,this._index=t._frames.length,this._wireMap={},this._holding=!1,this._processDef=n}return createClass(e,[{key:"handle",value:function(e,t,n,r){var i=e._id;this._wireMap.hasOwnProperty(i)||(this._wireMap[i]=this._createHandler(e)),this._wireMap[i].handle(this,e,t,n||e.name,r)}},{key:"emit",value:function(e,t,n,r){this._nextFrame.handle(e,t,n,r)}},{key:"_createHandler",value:function(e){var t=this._processDef;return t&&"pool"===t.name?new Pool(this,e,t):new Handler(t)}},{key:"target",value:function(e){this._nextFrame=e}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return this._holding}}]),e}(),_id=0,Wire=function(){function e(t){classCallCheck(this,e),this._id=++_id+"",this.target=null,this.dead=!1,this.name=t,this.cleanupMethod=Func.NOOP,this.pull=Func.NOOP}return createClass(e,[{key:"handle",value:function(e,t,n){!this.dead&&this.target&&this.target.handle(this,e,this.name,n)}},{key:"destroy",value:function(){!this.dead&&this.target&&(this.dead=!0,this.cleanupMethod())}}]),e}();Wire.fromInterval=function(e,t){var n=new Wire(t),r=function(e){n.handle(e)},i=setInterval(r,e);return n.cleanupMethod=function(){clearInterval(i)},n},Wire.fromMonitor=function(e,t){var n=new Wire(t),r=function(e,t,r){n.handle(e,t,r)};return n.cleanupMethod=function(){e.unsubscribe(r)},e.monitor(r),n},Wire.fromSubscribe=function(e,t,n,r){var i=new Wire(n||t||e.name),a=function(e,t,n){i.handle(e,t,n)};return i.cleanupMethod=function(){e.unsubscribe(a,t)},r&&(i.pull=function(){if(e.present(t)){var n=e.read(t),r=i.name;i.handle(n,r,t)}}),e.subscribe(a,t),i},Wire.fromEvent=function(e,t,n){n=!!n;var r=new Wire(t),i=e.addEventListener||e.addListener||e.on,a=e.removeEventListener||e.removeListener||e.off,s=function(e){r.handle(e,t)};return r.cleanupMethod=function(){a.call(e,t,s,n)},i.call(e,t,s,n),r};for(var FrameMerger=function(){function e(t){classCallCheck(this,e),this._bus=t,this._nextFrame=null,this._index=t._frames.length,this._mergingWire=new Wire}return createClass(e,[{key:"handle",value:function(e,t,n,r){this.emit(this._mergingWire,t,n,r)}},{key:"emit",value:function(e,t,n,r){this._nextFrame&&this._nextFrame.handle(e,t,n,r)}},{key:"target",value:function(e){this._nextFrame=e}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return!1}}]),e}(),FrameStateless=function(){function e(t,n){classCallCheck(this,e),this._bus=t,this._nextFrame=null,this._index=t._frames.length,this._process=new Handler(n)}return createClass(e,[{key:"handle",value:function(e,t,n,r){this._process.handle(this,e,t,n||e.name,r)}},{key:"emit",value:function(e,t,n,r){this._nextFrame&&this._nextFrame.handle(e,t,n,r)}},{key:"target",value:function(e){this._nextFrame=e}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return!1}}]),e}(),PoolDef=function e(){classCallCheck(this,e),this.name="pool",this.keep=null,this.when=null,this.until=null,this.timer=null,this.clear=null},FrameHold=function(){function e(t){classCallCheck(this,e),this._bus=t,this._nextFrame=null,this._index=t._frames.length,this._wireMap=new WeakMap,this._processDef=new PoolDef,this._holding=!0}return createClass(e,[{key:"handle",value:function(e,t,n,r){this._wireMap.has(e)||this._wireMap.set(e,this._createHandler(e)),this._wireMap.get(e).handle(this,e,t,n||e.name,r)}},{key:"emit",value:function(e,t,n,r){this._nextFrame&&this._nextFrame.handle(e,t,n,r)}},{key:"_createHandler",value:function(e){var t=this._processDef;return new Pool(this,e,t)}},{key:"target",value:function(e){this._nextFrame=e}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return this._holding}}]),e}(),FrameForker=function(){function e(t){classCallCheck(this,e),this._bus=t,this._targets=[],this._index=t._frames.length}return createClass(e,[{key:"handle",value:function(e,t,n,r){for(var i=this._targets.length,a=0;a<i;a++){this._targets[a].handle(e,t,n,r)}}},{key:"target",value:function(e){this._targets.push(e)}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return!1}}]),e}(),WaveDef=function e(t,n,r){classCallCheck(this,e),this.name="wave",this.process=t,this.action=n,this.stateful=r;for(var i=arguments.length,a=Array(i>3?i-3:0),s=3;s<i;s++)a[s-3]=arguments[s];this.args=a},Nyan={},operationDefs=[{name:"ACTION",sym:"^",react:!0,subscribe:!0,need:!0,solo:!0},{name:"WIRE",sym:"~",react:!0,follow:!0},{name:"WATCH",sym:null,react:!0,follow:!0},{name:"EVENT",sym:"@",react:!0,event:!0},{name:"ALIAS",sym:"(",then:!0,solo:!0},{name:"METHOD",sym:"`",then:!0,solo:!0},{name:"READ",sym:null,then:!0,read:!0},{name:"ATTR",sym:"#",then:!0,solo:!0,output:!0},{name:"AND",sym:"&",then:!0},{name:"STYLE",sym:"$",then:!0,solo:!0,output:!0},{name:"WRITE",sym:"=",then:!0,solo:!0},{name:"SPRAY",sym:"<",then:!0},{name:"RUN",sym:"*",then:!0,output:!0},{name:"FILTER",sym:">",then:!0}],operationsBySymbol={},operationsByName={},symbolsByName={},namesBySymbol={},reactionsByName={},withReactionsByName={},thenByName={},i=0;i<operationDefs.length;i++){var op=operationDefs[i],name=op.name,sym=op.sym;sym&&(operationsBySymbol[sym]=op,namesBySymbol[sym]=name),operationsByName[name]=op,symbolsByName[name]=sym,op.then&&(thenByName[name]=!0),op.react&&(reactionsByName[name]=!0,withReactionsByName[name]=!0)}var NyanWord=function e(t,n,r,i,a,s,u,o){classCallCheck(this,e),this.name=t,this.operation=n,this.maybe=r||!1,this.need=i||!1,this.topic=a||null,this.alias=s||null,this.monitor=u||!1,this.extracts=o&&o.length?o:null},tickStack=[];Nyan.parse=parse;var NyanRunner={applyNyan:applyNyan,createBus:createBus},Bus=function(){function e(t){classCallCheck(this,e),this._frames=[],this._wires=[],this._dead=!1,this._scope=t,this._children=[],this._parent=null,t&&t._busList.push(this);var n=new FrameStateless(this);this._frames.push(n),this._currentFrame=n}return createClass(e,[{key:"addFrame",value:function(e){var t=this._currentFrame,n=this._currentFrame=e&&e.stateful?new Frame(this,e):new FrameStateless(this,e);return this._frames.push(n),t.target(n),n}},{key:"addFrameHold",value:function(){var e=this._currentFrame,t=this._currentFrame=new FrameHold(this);return this._frames.push(t),e.target(t),t}},{key:"addFrameMerger",value:function(){var e=this._currentFrame,t=this._currentFrame=new FrameMerger(this);return this._frames.push(t),e.target(t),t}},{key:"addFrameForker",value:function(){var e=this._currentFrame,t=this._currentFrame=new FrameForker(this);return this._frames.push(t),e.target(t),t}},{key:"process",value:function(e,t,n){return"string"==typeof e&&(e=Nyan.parse(e,!0)),NyanRunner.applyNyan(e,this,t,n),this}},{key:"spawn",value:function(){}},{key:"fork",value:function(){Func.ASSERT_NOT_HOLDING(this);var t=new e(this.scope);return t.parent=this,this.addFrameForker(),this._currentFrame.target(t._currentFrame),t}},{key:"back",value:function(){if(!this._parent)throw new Error("Cannot exit fork, parent does not exist!");return this.parent}},{key:"join",value:function(){var e=this.back();return e.add(this),e}},{key:"add",value:function(e){var t=this.addFrame();return e._currentFrame.target(t),this}},{key:"defer",value:function(){return this.timer(Func.getDeferTimer)}},{key:"batch",value:function(){return this.timer(Func.getBatchTimer)}},{key:"sync",value:function(){return this.timer(Func.getSyncTimer)}},{key:"throttle",value:function(e){return this.timer(Func.getThrottleTimer,e)}},{key:"hold",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrameHold(),this}},{key:"pull",value:function(){for(var e=this._wires.length,t=0;t<e;t++){this._wires[t].pull()}return this}},{key:"event",value:function(e,t,n){var r=Wire.fromEvent(e,t,n);return this.wire(r)}},{key:"subscribe",value:function(e,t,n,r){var i=Wire.fromSubscribe(e,t,n,r);return this.wire(i)}},{key:"interval",value:function(e,t){var n=Wire.fromInterval(e,t);return this.wire(n)}},{key:"wire",value:function(e,t){return e.target=t||this._frames[0],this._wires.push(e),this}},{key:"monitor",value:function(e,t){var n=Wire.fromMonitor(e,t);return n.target=this._frames[0],this._wires.push(n),this}},{key:"scan",value:function(e,t){return this.holding?this.reduce(Func.getScan,e,t):(this.addFrame(new WaveDef("scan",e,!0,0)),this)}},{key:"delay",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("delay",Func.FUNCTOR(e))),this}},{key:"willReset",value:function(){return Func.ASSERT_IS_HOLDING(this),this.clear(Func.getAlwaysTrue)}},{key:"whenKeys",value:function(e){return this.when(Func.getWhenKeys,!0,e)}},{key:"group",
value:function(e){return this.holding?(this.reduce(Func.getGroup,e),this):(this.addFrame(new WaveDef("group",null,!0)),this)}},{key:"groupByTopic",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.hold().reduce(Func.getGroup,Func.TO_TOPIC),this}},{key:"all",value:function(){return this.holding?this.reduce(Func.getKeepAll):(this.addFrame(new WaveDef("all",null,!0)),this)}},{key:"first",value:function(e){return this.holding?this.reduce(Func.getKeepFirst,e):(this.addFrame(new WaveDef("firstN",null,!0,e)),this)}},{key:"last",value:function(e){return this.holding?this.reduce(Func.getKeepLast,e):(this.addFrame(new WaveDef("lastN",null,!0,e)),this)}},{key:"clear",value:function(e){for(var t,n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(t=this._currentFrame).clear.apply(t,[e].concat(r))}},{key:"reduce",value:function(e){for(var t=this.holding,n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];if(t){this._currentFrame._processDef.keep=[e,!0].concat(r)}else this.addFrame(new(Function.prototype.bind.apply(WaveDef,[null].concat(["msg",e,!0],r))));return this}},{key:"timer",value:function(e,t){for(var n=this.holding,r=n?this._currentFrame:this.addFrameHold(),i=r._processDef,a=arguments.length,s=Array(a>2?a-2:0),u=2;u<a;u++)s[u-2]=arguments[u];return i.timer=[e,t].concat(s),this._currentFrame._holding=!1,this}},{key:"until",value:function(e){for(var t,n,r=arguments.length,i=Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return this.holding?(t=this._currentFrame).until.apply(t,[e].concat(i)):(n=this.addFrameHold().reduce(Func.getKeepLast)).until.apply(n,[e].concat(i)).timer(Func.getSyncTimer),this}},{key:"when",value:function(e,t){for(var n=this.holding,r=arguments.length,i=Array(r>2?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];if(n){this._currentFrame._processDef.when=[e,t].concat(i)}else this.addFrame(new(Function.prototype.bind.apply(WaveDef,[null].concat(["filter",e,t],i))));return this}},{key:"run",value:function(e){return Func.ASSERT_IS_FUNCTION(e),Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("tap",e)),this}},{key:"merge",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrameMerger(),this}},{key:"msg",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("msg",Func.FUNCTOR(e))),this}},{key:"source",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("source",Func.FUNCTOR(e))),this}},{key:"filter",value:function(e){return Func.ASSERT_NEED_ONE_ARGUMENT(arguments),Func.ASSERT_IS_FUNCTION(e),Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("filter",e)),this}},{key:"split",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("split")),this}},{key:"hasKeys",value:function(e){return Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("filter",Func.getHasKeys(e))),this}},{key:"skipDupes",value:function(){return Func.ASSERT_NOT_HOLDING(this),this.addFrame(new WaveDef("skipDupes",null,!0)),this}},{key:"toStream",value:function(){}},{key:"destroy",value:function(){if(this.dead)return this;this._dead=!0;for(var e=this._wires,t=e.length,n=0;n<t;n++){e[n].destroy()}return this._wires=null,this}},{key:"children",get:function(){return this._children.map(function(e){return e})}},{key:"parent",get:function(){return this._parent},set:function(e){var t=this.parent;if(t!==e){if(t){var n=t._children.indexOf(this);t._children.splice(n,1)}return this._parent=e,e&&e._children.push(this),this}}},{key:"dead",get:function(){return this._dead}},{key:"holding",get:function(){return this._currentFrame._holding}},{key:"scope",get:function(){return this._scope}}]),e}(),idCounter=0,Scope=function(){function e(t){classCallCheck(this,e),this._id=++idCounter,this._name=t,this._parent=null,this._children=[],this._busList=[],this._dataList=new Map,this._valves=new Map,this._mirrors=new Map,this._dead=!1}return createClass(e,[{key:"bus",value:function(e,t,n){if(!e)return new Bus(this);var r="string"==typeof e?Nyan.parse(e):e;return console.log(r),NyanRunner.createBus(r,this,t,n)}},{key:"clear",value:function(){this._dead||(_destroyEach(this.children),_destroyEach(this._busList),_destroyEach(this._dataList.values()),this._children=[],this._busList=[],this._dataList.clear(),this._valves.clear(),this._mirrors.clear())}},{key:"destroy",value:function(){this.clear(),this.parent=null,this._dead=!0}},{key:"createChild",value:function(t){var n=new e(t);return n.parent=this,n}},{key:"insertParent",value:function(e){return e.parent=this.parent,this.parent=e,this}},{key:"_createMirror",value:function(e){var t=Object.create(e);return t._type=DATA_TYPES.MIRROR,this._mirrors.set(e.name,t),t}},{key:"_createData",value:function(e,t){var n=new Data(this,e,t);return this._dataList.set(e,n),n}},{key:"data",value:function(e){return this.grab(e)||this._createData(e,DATA_TYPES.NONE)}},{key:"action",value:function(e){var t=this.grab(e);return t?t.verify(DATA_TYPES.ACTION):this._createData(e,DATA_TYPES.ACTION)}},{key:"state",value:function(e){var t=this.grab(e);if(t)return t.verify(DATA_TYPES.STATE);var n=this._createData(e,DATA_TYPES.STATE);return this._createMirror(n),n}},{key:"findDataSet",value:function(e,t){var n={},r=!0,i=!1,a=void 0;try{for(var s,u=e[Symbol.iterator]();!(r=(s=u.next()).done);r=!0){var o=s.value;n[o]=this.find(o,t)}}catch(e){i=!0,a=e}finally{try{!r&&u.return&&u.return()}finally{if(i)throw a}}return n}},{key:"readDataSet",value:function(e,t){var n=this.findDataSet(e,t),r={},i=!0,a=!1,s=void 0;try{for(var u,o=n[Symbol.iterator]();!(i=(u=o.next()).done);i=!0){var l=u.value;l&&l.present()&&(r[l.name]=l.read())}}catch(e){a=!0,s=e}finally{try{!i&&o.return&&o.return()}finally{if(a)throw s}}return r}},{key:"flatten",value:function(){var e=this,t=new Map,n=new Map,r=!0,i=!1,a=void 0;try{for(var s,u=e._dataList[Symbol.iterator]();!(r=(s=u.next()).done);r=!0){var o=slicedToArray(s.value,2),l=o[0],c=o[1];t.set(l,c)}}catch(e){i=!0,a=e}finally{try{!r&&u.return&&u.return()}finally{if(i)throw a}}for(;e=e._parent;){var h=e._dataList,f=e._valves,v=e._mirrors;if(h.size){if(f.size)if(n.size){var y=!0,d=!1,m=void 0;try{for(var p,_=n.keys()[Symbol.iterator]();!(y=(p=_.next()).done);y=!0){var g=p.value;f.has(g)||n.delete(g)}}catch(e){d=!0,m=e}finally{try{!y&&_.return&&_.return()}finally{if(d)throw m}}}else{var k=!0,b=!1,w=void 0;try{for(var S,T=f.entries()[Symbol.iterator]();!(k=(S=T.next()).done);k=!0){var F=slicedToArray(S.value,2),A=F[0],c=F[1];n.set(A,c)}}catch(e){b=!0,w=e}finally{try{!k&&T.return&&T.return()}finally{if(b)throw w}}}var E=n.size?n:h,C=!0,N=!1,D=void 0;try{for(var O,R=E.keys()[Symbol.iterator]();!(C=(O=R.next()).done);C=!0){var x=O.value;if(!t.has(x)){var L=v.get(x)||h.get(x);L&&t.set(x,L)}}}catch(e){N=!0,D=e}finally{try{!C&&R.return&&R.return()}finally{if(N)throw D}}}}return t}},{key:"find",value:function(e,t){var n=this.grab(e);if(n)return n;for(var r=this;r=r._parent;){var i=r._valves;if(i.size&&!i.has(e))break;var a=r._mirrors.get(e);if(a)return a;var s=r.grab(e);if(s)return s}if(t)throw new Error("Required data: "+e+" not found!");return null}},{key:"findOuter",value:function(e,t){var n=!1;this.grab(e)&&(n=!0);for(var r=this;r=r._parent;){var i=r._valves;if(i.size&&!i.has(e))break;var a=r._mirrors.get(e);if(a){if(n)return a;n=!0}else{var s=r.grab(e);if(s){if(n)return s;n=!0}}}if(t)throw new Error("Required data: "+e+" not found!");return null}},{key:"grab",value:function(e,t){var n=this._dataList.get(e);if(!n&&t)throw new Error("Required Data: "+e+" not found!");return n||null}},{key:"transaction",value:function(e){if(Array.isArray(e))return this._multiWriteArray(e);if("object"===(void 0===e?"undefined":_typeof(e)))return this._multiWriteHash(e);throw new Error("Write values must be in an array of object hash.")}},{key:"_multiWriteArray",value:function(e){var t=[],n=!0,r=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var u=a.value,o=this.find(u.name);o.silentWrite(u.value,u.topic),t.push(o)}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}var l=!0,c=!1,h=void 0;try{for(var f,v=t[Symbol.iterator]();!(l=(f=v.next()).done);l=!0){var y=f.value,d=e[0];y.refresh(d.topic)}}catch(e){c=!0,h=e}finally{try{!l&&v.return&&v.return()}finally{if(c)throw h}}return this}},{key:"_multiWriteHash",value:function(e){var t=[];for(var n in e){var r=e[n],i=this.find(n);i.silentWrite(r),t.push(i)}var a=!0,s=!1,u=void 0;try{for(var o,l=t[Symbol.iterator]();!(a=(o=l.next()).done);a=!0){o.value.refresh()}}catch(e){s=!0,u=e}finally{try{!a&&l.return&&l.return()}finally{if(s)throw u}}return this}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"children",get:function(){return this._children.map(function(e){return e})}},{key:"parent",get:function(){return this._parent},set:function(e){var t=this.parent;if(t!==e){if(t){var n=t._children.indexOf(this);t._children.splice(n,1)}return this._parent=e,e&&e._children.push(this),this}}},{key:"valves",set:function(e){var t=!0,n=!1,r=void 0;try{for(var i,a=e[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value;this._valves.set(s,!0)}}catch(e){n=!0,r=e}finally{try{!t&&a.return&&a.return()}finally{if(n)throw r}}},get:function(){return Array.from(this._valves.keys())}}]),e}(),Catbus$1={},_batchQueue=[],_primed=!1;Catbus$1.bus=function(){return new Bus},Catbus$1.fromEvent=function(e,t,n){var r=new Bus;return r.event(e,t,n),r},Catbus$1.enqueue=function(e){_batchQueue.push(e),_primed||(_primed=!0,"undefined"!=typeof window&&window.requestAnimationFrame?requestAnimationFrame(Catbus$1.flush):process.nextTick(Catbus$1.flush))},Catbus$1.createChild=Catbus$1.scope=function(e){return new Scope(e)},Catbus$1.flush=function(){_primed=!1;var e=0,t=_batchQueue;for(_batchQueue=[];t.length;){for(;t.length;){t.shift().release()}if(t=_batchQueue,_batchQueue=[],++e>10)throw new Error("Flush batch cycling loop > 10.",t)}},module.exports=Catbus$1;
