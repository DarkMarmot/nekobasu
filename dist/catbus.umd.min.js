!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Catbus=e()}(this,function(){"use strict";function t(){return!0}function e(){return!1}function n(t,e){return e}function r(t,e,n){return n}function i(t){return t}function a(){}function s(t){return"function"==typeof t?t:function(){return t}}function u(t){return X.hasOwnProperty(t)}function o(t,e,n,r,i){t.emit(e,n,r,i)}function h(t){Et=[];for(var e=t.split(/([`])/),n=[],r=!1;e.length;){var i=e.shift();"`"===i?(r=!r,n.push(i)):r?Et.push(i):n.push(i)}return n.join("")}function c(t,e){t=h(t);for(var n=[],r=t.split(/([{}]|-})/).map(function(t){return t.trim()}).filter(function(t){return t}),i=0;i<r.length;i++){var a=r[i],s="}"===a||"{"===a||"-}"===a?a:d(a);("string"==typeof s||s.length>0)&&n.push(s)}return f(n,e)}function f(t,e){for(var n=[],r=!0,i=0;i<t.length;i++){var a=t[i];if("string"!=typeof a)for(var s=0;s<a.length;s++){var u=a[s];r&&!e?(l(u),r=!1,n.push({name:"REACT",phrase:u})):(v(u),n.push({name:"PROCESS",phrase:u}))}else"{"===a?n.push({name:"FORK"}):"}"===a?n.push({name:"BACK"}):"-}"===a&&n.push({name:"JOIN"})}return n}function l(t){for(var e=!1,n=0;n<t.length;n++){var r=t[n],i=r.operation=r.operation||"WATCH";if(e=e||mt[i],!pt[i])throw new Error("This Nyan command cannot be in a reaction!")}if(!e)throw new Error("Nyan commands must begin with an observation!")}function v(t){var e=t[0],n=e.operation||"READ";if(!_t[n])throw new Error("Illegal operation in phrase!");for(var r=0;r<t.length;r++){var i=t[r];if(i.operation=i.operation||n,i.operation!==n)throw new Error("Multiple operation types in phrase (only one allowed)!")}}function d(t){for(var e=[],n=t.split("|").map(function(t){return t.trim()}).filter(function(t){return t}),r=0;r<n.length;r++){var i=n[r],a=y(i);e.push(a)}return e}function y(t){for(var e=[],n=t.split(",").map(function(t){return t.trim()}).filter(function(t){return t}),r=n.length,i=0;i<r;i++){for(var a=n[i],s=a.split(/([(?!:.`)])/),u=[],o=!1;s.length;){var h=s.shift();if("`"===h)o=!o,u.push(h);else if(o)u.push(h);else{var c=h.trim();c&&u.push(c)}}var f=u.shift(),l=a[0],v=yt[l],d=v?1:0,y=f.slice(d).trim(),m=[],p=!1,_=!1,g=null,k=null,w=!1;if("ALIAS"===v)k=u.shift(),u.shift();else if("METHOD"===v){u.shift();var b=Et.shift(),T=b.indexOf(" ");for(-1===T?m.push(b):(m.push(b.slice(0,T)),b.length>T&&m.push(b.slice(T+1)));u.length;)u.shift()}for(;u.length;){switch(u.shift()){case".":var E=u.length&&u[0],S=u.length>1&&"?"===u[1];E&&(m.push({name:E,silentFail:S}),u.shift(),S&&u.shift());break;case"?":p=!0;break;case"!":w=!0;break;case":":if(u.length){var A=u[0];"("===A?_=!0:(g=A,u.shift())}else _=!0;break;case"(":u.length&&(k=u.shift())}}k=k||g||y;var O=new Tt(y,v,p,w,g,k,_,m);e.push(O)}return e}function m(t,e){var n=t.find(e.name,!e.maybe);return n&&n.peek(e.topic)}function p(t,e){var n=t.find(e.name,!e.maybe);return n&&n.survey()}function _(t){console.log("throwing ",t);var e=new Error(t);throw console.log(this,e),e}function g(t){var e={},n=t.length;return function(r){for(var i=!1,a=0;a<n;a++){var s=t[a];e.hasOwnProperty(s)&&e[s]===r[s]||(i=!0),e[s]=r[s]}return i}}function k(t,e){var n=t.find(e.name,!e.maybe);return function(t){n.write(t,e.topic)}}function w(t,e){for(var n={},r={},i=e.length,a=0;a<i;a++){var s=e[a],u=t.find(s.name,!s.maybe);u&&(n[s.alias]=s,r[s.alias]=u)}return function(t){for(var e in t){var i=r[e];if(i){var a=n[e],s=t[e];i.silentWrite(s,a.topic)}}for(var u in t){var o=r[u];if(o){var h=n[u];o.refresh(h.topic)}}}}function b(t,e){var n=e.length,r=e[0];return n>1||r.monitor?S(t,e):E(t,r)}function T(t,e){return S(t,e,!0)}function E(t,e){return function(){var n=m(t,e);return n&&n.msg}}function S(t,e,n){var r=e.length;return function(i,a){var s={};if(n)if(a)s[a]=i;else for(var u in i)s[u]=i[u];for(var o=0;o<r;o++){var h=e[o];if(h.monitor){var c=p(t,h),f=!0,l=!1,v=void 0;try{for(var d,y=c[Symbol.iterator]();!(f=(d=y.next()).done);f=!0){var _=z(d.value,2),g=_[0],k=_[1];s[g]=k}}catch(t){l=!0,v=t}finally{try{!f&&y.return&&y.return()}finally{if(l)throw v}}}else{var w=m(t,h),b=h.monitor?h.alias||h.topic:h.alias||h.name;w&&(s[b]=w.msg)}}return s}}function A(t,e,n){var r=t.find(e.name,!e.maybe);return e.monitor?st.fromMonitor(r,e.alias,n):st.fromSubscribe(r,e.topic,e.alias,n)}function O(t){return null!==t&&("function"==typeof t||"object"===(void 0===t?"undefined":j(t)))}function N(t,e){return st.fromEvent(e,t.topic,t.useCapture,t.alias)}function R(t,e){for(var n=t,r=e.length,i=0;i<r;i++){var a=e[i];if(!O(n)){if(a.silentFail)return;_("Cannot access property '"+a.name+"' of "+n)}n=n[a.name]}return n}function D(t){return t.filter(function(t){return t.operation.need}).map(function(t){return t.alias})}function L(t){for(var e=t.length,n={},r=0;r<e;r++){var i=t[r];n[i.alias]=i.extracts}return function(t){var e={};for(var r in n){t.hasOwnProperty(r)&&(e[r]=R(t[r],n[r]))}return e}}function M(t){var e=t.extracts;return function(t){return R(t,e)}}function F(t,e,n,r){var i=[],a=[],s=[];if(1===n.length&&"ACTION"===n[0].operation){var u=n[0];return void e.wire(A(t,u,!1))}for(var o=0;o<n.length;o++){var h=n[o],c=h.operation;"WATCH"===c?(e.wire(A(t,h,!0)),a.push(h.alias)):"WIRE"===c?e.wire(A(t,h,!0)):"EVENT"===c&&e.wire(N(h,r)),h.extracts&&s.push(h),h.need&&i.push(h.alias)}e._wires.length>1?(e.merge().group().batch(),s.length&&e.msg(L(s)),i.length&&e.hasKeys(i),a.length&&e.filter(g(a))):(s.length&&e.msg(M(s[0])),a.length&&e.skipDupes())}function I(t){return!!t}function x(t){return!t}function C(t,e){switch(e.extracts[0]){case"true":t.msg(!0);break;case"false":t.msg(!1);break;case"null":t.msg(null);break;case"undefined":t.msg(void 0);break;case"array":t.msg([]);break;case"object":t.msg({});break;case"truthy":t.filter(I);break;case"falsey":t.filter(x);break;case"string":t.msg(function(){return e.extracts[1]})}}function P(t,e,n,r,i){var a=n[0].operation;if("READ"===a){e.msg(b(t,n));var s=D(n);s.length&&e.whenKeys(s)}else if("AND"===a){e.msg(T(t,n));var u=D(n);u.length&&e.whenKeys(u)}else"METHOD"===a?C(e,n[0]):"FILTER"===a?G(e,n,r):"RUN"===a?H(e,n,r):"ALIAS"===a?W(e,n[0]):"WRITE"===a?e.run(k(t,n[0])):"SPRAY"===a&&e.run(w(t,n))}function H(t,e,n){for(var r=e.length,i=0;i<r;i++)!function(r){var i=e[r],a=i.name,s=n[a],u=function(t,e,r){return s.call(n,t,e,r)};t.msg(u)}(i)}function W(t,e){t.source(e.alias)}function G(t,e,n){for(var r=e.length,i=0;i<r;i++)!function(r){var i=e[r],a=i.name,s=n[a],u=function(t,e,r){return s.call(n,t,e,r)};t.filter(u)}(i)}function K(t,e,n,r,i){for(var a=ct.parse(n),s=a.length,u=0;u<s;u++){var o=a[u],h=o.name,c=o.phrase;"JOIN"===h?(e=e.join(),e.merge(),e.group(),e.sync()):"FORK"===h?e=e.fork():"BACK"===h?e=e.back():"PROCESS"===h?P(t,e,c,r,i):F(t,e,c,i)}return e}function U(t){for(var e=t.length,n=0;n<e;n++){t[n].destroy()}}var B={ASSERT_NEED_ONE_ARGUMENT:function(t){if(t.length<1)throw new Error("Method requires at least one argument.")},ASSERT_IS_FUNCTION:function(t){if("function"!=typeof t)throw new Error("Argument [func] is not of type function.")},getAlwaysTrue:function(){return function(){return!0}},getBatchTimer:function(t){Nt.enqueue(t)},getSyncTimer:function(){return function(t){t.release(t)}},getDeferTimer:function(){return function(t){setTimeout(t.release,0,t)}},getThrottleTimer:function(t){function e(s){if(!n.stream.dead){var u=n.keep.isEmpty;if(!s)return void(i?a=!0:(n.release(n),r=!1,i=setTimeout(e,t.call(n),!0)));u?r||(r=!0,a=!1,i=setTimeout(e,t.call(n),!0)):(n.release(n),r=!1,i=setTimeout(e,t.call(n),!0))}}var n=this;t=s(t);var r=!1,i=null,a=!1;n.keep.auto;return e},getQueue:function(e){e=e||1/0;var n=[],r=function(t,r){return n.length<e&&n.push(t),n};return r.isBuffer=t,r.next=function(){return n.shift()},r.isEmpty=function(){return 0===n.length},r.content=function(){return n},r},getScan:function(t,e){var n=2===arguments.length,r=void 0,i=!0,s=function(a,s){return i?(i=!1,r=n?t(e,a,s):a):r=t(r,a,s),r};return s.reset=a,s.next=s.content=function(){return r},s},getGroup:function(t){t=t||n;var e={},r=function(n,r){var i=t(n,r);if(i)e[i]=n;else for(var a in n)e[a]=n[a];return e};return r.reset=function(){for(var t in e)delete e[t];r.isEmpty=!0},r.next=r.content=function(){return e},r},getHash:function(t){t=t||n;var e={},r=function(n,r){var i=t(n,r);return e[i]=n,e};return r.reset=function(){for(var t in e)delete e[t];r.isEmpty=!0},r.next=r.content=function(){return e},r},getKeepLast:function(t){if(!t||t<0){var e=void 0,n=function(t,n){return e=t};return n.reset=function(){n.isEmpty=!0},n.next=n.content=function(){return e},n}var r=[],i=function(e,n){return r.push(e),r.length>t&&r.shift(),r};return i.reset=function(){for(;r.length;)r.shift();i.isEmpty=!0},i.next=i.content=function(){return r},i},getKeepFirst:function(t){if(!t||t<0){var e=void 0,n=function(t,n){return e=t};return n.reset=function(){e=!1,n.isEmpty=!0},n.next=n.content=function(){return e},n}var r=[],i=function(e,n){return r.length<t&&r.push(e),r};return i.reset=function(){for(;r.length;)r.shift();i.isEmpty=!0},i.next=i.content=function(){return r},i},getKeepAll:function(){var t=[],e=function(e,n){return t.push(e),t};return e.reset=function(){for(;t.length;)t.shift();e.isEmpty=!0},e.next=e.content=function(){return t},e},getWhenCount:function(t){var e=!1,n=function(n){return e=e||n.length>=t};return n.reset=function(){e=!1},n},getWhenKeys:function(t){for(var e={},n=t.length,r=0;r<n;r++){var i=t[r];e[i]=!0}var a=!1,s=function(e){if(a)return!0;for(var r=0;r<n;r++){var i=t[r];if(!e.hasOwnProperty(i))return!1}return a=!0};return s.reset=function(){a=!1;for(var t in e)delete e[t]},s},getHasKeys:function(t,e){var n=!1,r=t.length;return function(i){if(n||!r)return!0;for(var a=0;a<r;a++){var s=t[a];if(!i.hasOwnProperty(s))return!1}return e||(n=!0),!0}},getSkipDupes:function(){var t=!1,e=void 0;return function(n){var r=!t||n!==e;return e=n,t=!0,r}},ASSERT_NOT_HOLDING:function(t){if(t.holding)throw new Error("Method cannot be invoked while holding messages in the frame.")},ASSERT_IS_HOLDING:function(t){if(!t.holding)throw new Error("Method cannot be invoked unless holding messages in the frame.")}};B.TO_SOURCE=n,B.TO_TOPIC=r,B.To_MSG=i,B.FUNCTOR=s,B.ALWAYS_TRUE=t,B.ALWAYS_FALSE=e,B.NOOP=a;var j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},q=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},Y=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),z=function(){function t(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(r=(s=u.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{!r&&u.return&&u.return()}finally{if(i)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),J=function(t){return Array.isArray(t)?t:Array.from(t)},V=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},Q=function(){function t(e,n,r){q(this,t),this._msg=e,this._topic=n,this._source=r,this._timestamp=Date.now()}return Y(t,[{key:"msg",get:function(){return this._msg}},{key:"topic",get:function(){return this._topic}},{key:"source",get:function(){return this._source}},{key:"timestamp",get:function(){return this._timestamp}}]),t}(),$={ACTION:"action",MIRROR:"mirror",STATE:"state",COMPUTED:"computed",NONE:"none",ANY:"any"},X={};for(var Z in $){var tt=$[Z];X[tt]=Z}var et=function(){function t(e,n){q(this,t),this._topic=e,this._subscribers=[],this._lastPacket=null,this._data=n,this._name=n._name,this._dead=!1}return Y(t,[{key:"handle",value:function(t,e,n){if(!this.dead){e=e||this.topic;var r=this.name,i=new Q(t,e,r);this.data.type!==$.ACTION&&(this._lastPacket=i);var a=[].concat(this._subscribers),s=a.length;if(!n)for(var u=0;u<s;u++){var o=a[u];"function"==typeof o?o.call(o,t,i):o.handle(t,i)}}}},{key:"destroy",value:function(){this.dead||(this._subscribers=null,this._lastPacket=null,this._dead=!0)}},{key:"add",value:function(t){this._subscribers.push(t)}},{key:"remove",value:function(t){var e=this._subscribers.indexOf(t);-1!==e&&this._subscribers.splice(e,1)}},{key:"lastPacket",get:function(){return this._lastPacket}},{key:"data",get:function(){return this._data}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"topic",get:function(){return this._topic}}]),t}(),nt=function(){function t(e,n,r){if(q(this,t),r=r||$.NONE,!u(r))throw new Error("Invalid Data of type: "+r);this._scope=e,this._name=n,this._type=r,this._dead=!1,this._wildcardSubscriberList=new et(null,this),this._subscriberListsByTopic=new Map}return Y(t,[{key:"destroy",value:function(){this.dead&&this._throwDead();var t=!0,e=!1,n=void 0;try{for(var r,i=this._subscriberListsByTopic.values()[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){r.value.destroy()}}catch(t){e=!0,n=t}finally{try{!t&&i.return&&i.return()}finally{if(e)throw n}}this._dead=!0}},{key:"_demandSubscriberList",value:function(t){t=t||void 0;var e=this._subscriberListsByTopic.get(t);return e||(e=new et(t,this),this._subscriberListsByTopic.set(t,e),e)}},{key:"verify",value:function(t){if(this.type===t)return this;throw new Error("Data "+this.name+" requested as type "+t+" exists as "+this.type)}},{key:"follow",value:function(t,e){this.dead&&this._throwDead(),e=e||void 0,this.subscribe(t,e);var n=this.peek();return n&&("function"==typeof t?t.call(t,n.msg,n):t.handle(n.msg,n)),this}},{key:"subscribe",value:function(t,e){return this.dead&&this._throwDead(),e=e||void 0,this._demandSubscriberList(e).add(t),this}},{key:"monitor",value:function(t){return this.dead&&this._throwDead(),this._wildcardSubscriberList.add(t),this}},{key:"unsubscribe",value:function(t,e){return this.dead&&this._throwDead(),e=e||void 0,this._demandSubscriberList(e).remove(t),this._wildcardSubscriberList.remove(t),this}},{key:"topics",value:function(){return this._subscriberListsByTopic.keys()}},{key:"survey",value:function(){var t=this._subscriberListsByTopic.entries(),e=new Map,n=!0,r=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var u=z(a.value,2),o=u[0],h=u[1];e.set(o,h.lastPacket)}}catch(t){r=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}return e}},{key:"peek",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this._subscriberListsByTopic.get(t);return e?e.lastPacket:null}},{key:"read",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this.peek(t);return e?e.msg:void 0}},{key:"silentWrite",value:function(t,e){this.dead&&this._throwDead(),e=e||void 0,this.write(t,e,!0)}},{key:"write",value:function(t,e,n){if(this.dead&&this._throwDead(),this.type===$.MIRROR)throw new Error("Mirror Data: "+this.name+" is read-only");e=e||void 0,this._demandSubscriberList(e).handle(t,e,n),this._wildcardSubscriberList.handle(t,e,n)}},{key:"refresh",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this.peek(t);return e&&this.write(e._msg,t),this}},{key:"toggle",value:function(t){return this.dead&&this._throwDead(),t=t||void 0,this.write(!this.read(t),t),this}},{key:"_throwDead",value:function(){throw new Error("Data: "+this.name+" is already dead.")}},{key:"scope",get:function(){return this._scope}},{key:"name",get:function(){return this._name}},{key:"type",get:function(){return this._type}},{key:"dead",get:function(){return this._dead}}]),t}(),rt=function(){function t(e){q(this,t),this.process=e&&e.process?this[e.process]:o,this.action=e?e.stateful?e.action.apply(e,V(e.args)):e.action:null}return Y(t,[{key:"handle",value:function(t,e,n,r,i){this.process(t,e,n,r,i)}},{key:"run",value:function(t,e,n,r,i){this.action(n,r,i),t.emit(e,n,r,i)}},{key:"msg",value:function(t,e,n,r,i){n=this.action(n,r,i),t.emit(e,n,r,i)}},{key:"source",value:function(t,e,n,r,i){r=this.action(n,r,i),t.emit(e,n,r,i)}},{key:"filter",value:function(t,e,n,r,i){this.action(n,r,i)&&t.emit(e,n,r,i)}},{key:"delay",value:function(t,e,n,r,i){function a(){t.emit(e,n,r,i)}setTimeout(a,this.action(n,r,i)||0,n,r,i)}}]),t}(),it=function(){function t(e,n,r){function i(t){if(!r[t])return null;var e=J(r[t]),n=e[0],i=e[1],a=e.slice(2);return i?n.call.apply(n,[this].concat(V(a))):n}q(this,t),this.frame=e,this.wire=n,this.keep=i("keep")||B.getKeepLast(),this.when=i("when")||B.ALWAYS_TRUE,this.until=i("until")||B.ALWAYS_TRUE,this.timer=i("timer"),this.clear=i("clear")||B.ALWAYS_FALSE,this.isPrimed=!1}return Y(t,[{key:"handle",value:function(t,e,n,r,i){if(this.keep(n,r,i),!this.isPrimed){var a=this.keep.content();this.when(a)&&(this.isPrimed=!0,this.timer(this))}}},{key:"build",value:function(t,e){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];this[t]=e.call.apply(e,[this].concat(r))}},{key:"release",value:function(t){t=t||this;var e=!t.keep.isEmpty,n=e&&t.keep.next();t.clear()&&(t.keep.reset(),t.when.reset()),t.isPrimed=!1,e&&t.frame.emit(t.wire,n)}}]),t}(),at=function t(){q(this,t),this.name="pool",this.keep=null,this.when=null,this.until=null,this.timer=null,this.clear=null},st=function(){function t(){q(this,t),this.target=null,this.dead=!1,this.name=null,this.cleanupMethod=B.NOOP,this.pull=B.NOOP}return Y(t,[{key:"handle",value:function(t,e,n){return!this.dead&&this.target&&this.target.handle(this,t,this.name||e,n),this}},{key:"destroy",value:function(){!this.dead&&this.target&&(this.dead=!0,this.cleanupMethod())}}]),t}();st.fromMonitor=function(t,e){var n=new st,r=n.name=e||t.name,i=function(t,e,i){n.handle(t,r,i)};return n.cleanupMethod=function(){t.unsubscribe(i)},t.monitor(i),n},st.fromSubscribe=function(t,e,n,r){var i=new st,a=i.name=n||e||t.name,s=function(t,e,n){i.handle(t,a,n)};return i.cleanupMethod=function(){t.unsubscribe(s,e)},r&&(i.pull=function(){var e=t.peek();if(e){var n=e._msg,r=a||e._source,s=e._topic;i.handle(n,r,s)}}),t.subscribe(s,e),i},st.fromEvent=function(t,e,n){n=!!n;var r=new st;r.name=e;var i=t.addEventListener||t.addListener||t.on,a=t.removeEventListener||t.removeListener||t.off,s=function(t){r.handle(t,e)};return r.cleanupMethod=function(){a.call(t,e,s,n)},i.call(t,e,s,n),r};for(var ut=function(){function t(e){q(this,t),this._bus=e,this._targets=[],this._index=e._frames.length,this._wireMap=new WeakMap,this._holding=!1,this._processDef=null,this._mergingWire=null}return Y(t,[{key:"define",value:function(t){return this._processDef=t,this}},{key:"merge",value:function(){return this._mergingWire=new st,this}},{key:"handle",value:function(t,e,n,r){if(this._mergingWire)return void this.emit(this._mergingWire,e,n,r);this._wireMap.has(t)||this._wireMap.set(t,this._createHandler(t)),this._wireMap.get(t).handle(this,t,e,n||t.name,r)}},{key:"emit",value:function(t,e,n,r){for(var i=this._targets.length,a=0;a<i;a++){this._targets[a].handle(t,e,n,r)}}},{key:"_createHandler",value:function(t){var e=this._processDef;return e&&"pool"===e.name?new it(this,t,e):new rt(e)}},{key:"hold",value:function(){return this._holding=!0,this._processDef=new at,this}},{key:"target",value:function(t){this._targets.push(t)}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return this._holding}}]),t}(),ot=function t(e,n,r){q(this,t),this.name="wave",this.process=e,this.action=n,this.stateful=r;for(var i=arguments.length,a=Array(i>3?i-3:0),s=3;s<i;s++)a[s-3]=arguments[s];this.args=a},ht=function(){function t(e){q(this,t),this._frames=[],this._wires=[],this._dead=!1,this._scope=e,this._children=[],this._parent=null,e&&e._busList.push(this);var n=new ut(this);this._frames.push(n),this._currentFrame=n}return Y(t,[{key:"addFrame",value:function(){var t=this._currentFrame,e=this._currentFrame=new ut(this);return this._frames.push(e),t.target(e),e}},{key:"spawn",value:function(){}},{key:"split",value:function(){B.ASSERT_NOT_HOLDING(this)}},{key:"fork",value:function(){B.ASSERT_NOT_HOLDING(this);var e=new t(this.scope);return e.parent=this,this._currentFrame.target(e._currentFrame),e}},{key:"back",value:function(){if(!this._parent)throw new Error("Cannot exit fork, parent does not exist!");return this.parent}},{key:"join",value:function(){var t=this.back();return t.add(this),t}},{key:"add",value:function(t){var e=this.addFrame();return t._currentFrame.target(e),this}},{key:"defer",value:function(){return this.timer(B.getDeferTimer)}},{key:"batch",value:function(){return this.timer(B.getBatchTimer)}},{key:"sync",value:function(){return this.timer(B.getSyncTimer)}},{key:"throttle",value:function(t){return this.timer(B.getThrottleTimer,t)}},{key:"hold",value:function(){return B.ASSERT_NOT_HOLDING(this),this.addFrame().hold(),this}},{key:"pull",value:function(){for(var t=this._wires.length,e=0;e<t;e++){this._wires[e].pull()}return this}},{key:"event",value:function(t,e,n){var r=st.fromEvent(t,e,n);return this.wire(r)}},{key:"subscribe",value:function(t,e,n,r){var i=st.fromSubscribe(t,e,n,r);return this.wire(i)}},{key:"wire",value:function(t){return t.target=this._frames[0],this._wires.push(t),this}},{key:"monitor",value:function(t,e){var n=st.fromMonitor(t,e);return n.target=this._frames[0],this._wires.push(n),this}},{key:"scan",value:function(t,e){return this.reduce(B.getScan,t,e)}},{key:"delay",value:function(t){return B.ASSERT_NEED_ONE_ARGUMENT(arguments),B.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("delay",B.FUNCTOR(t))),this}},{key:"willReset",value:function(){return B.ASSERT_IS_HOLDING(this),this.clear(B.getAlwaysTrue)}},{key:"whenKeys",value:function(t){return this.when(B.getWhenKeys,!0,t)}},{key:"group",value:function(t){return B.ASSERT_NOT_HOLDING(this),this.hold().reduce(B.getGroup,t),this}},{key:"groupByTopic",value:function(){return B.ASSERT_NOT_HOLDING(this),this.addFrame().hold().reduce(B.getGroup,B.TO_TOPIC),this}},{key:"all",value:function(){return this.reduce(B.getKeepAll)}},{key:"first",value:function(t){return this.reduce(B.getKeepFirst,t)}},{key:"last",value:function(t){return this.reduce(B.getKeepLast,t)}},{key:"clear",value:function(t){for(var e,n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(e=this._currentFrame).clear.apply(e,[t].concat(r))}},{key:"reduce",value:function(t){for(var e=this.holding,n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];if(e){this._currentFrame._processDef.keep=[t,!0].concat(r)}else{var a=this.addFrame(),s=new(Function.prototype.bind.apply(ot,[null].concat(["msg",t,!0],r)));a.define(s)}return this}},{key:"timer",value:function(t,e){for(var n=this.holding,r=n?this._currentFrame:this.addFrame().hold(),i=r._processDef,a=arguments.length,s=Array(a>2?a-2:0),u=2;u<a;u++)s[u-2]=arguments[u];return i.timer=[t,e].concat(s),this._currentFrame._holding=!1,this}},{key:"until",value:function(t){for(var e,n,r=arguments.length,i=Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).until.apply(e,[t].concat(i)):(n=this.addFrame().hold().reduce(B.getKeepLast)).until.apply(n,[t].concat(i)).timer(B.getSyncTimer),this}},{key:"when",value:function(t,e){for(var n=this.holding,r=arguments.length,i=Array(r>2?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];if(n){this._currentFrame._processDef.when=[t,e].concat(i)}else{var s=this.addFrame(),u=new(Function.prototype.bind.apply(ot,[null].concat(["filter",t,e],i)));s.define(u)}return this}},{key:"run",value:function(t){return B.ASSERT_IS_FUNCTION(t),B.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("run",t)),this}},{key:"merge",value:function(){return B.ASSERT_NOT_HOLDING(this),this.addFrame().merge(),this}},{key:"msg",value:function(t){return B.ASSERT_NEED_ONE_ARGUMENT(arguments),B.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("msg",B.FUNCTOR(t))),this}},{key:"transform",value:function(t){return B.ASSERT_NEED_ONE_ARGUMENT(arguments),B.ASSERT_NOT_HOLDING(this),this.addFrame().transform(t),this}},{key:"source",value:function(t){return B.ASSERT_NEED_ONE_ARGUMENT(arguments),B.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("source",B.FUNCTOR(t))),this}},{key:"filter",value:function(t){return B.ASSERT_NEED_ONE_ARGUMENT(arguments),B.ASSERT_IS_FUNCTION(t),B.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("filter",t)),this}},{key:"hasKeys",value:function(t){return B.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("filter",B.getHasKeys(t))),this}},{key:"skipDupes",value:function(){return B.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("filter",B.getSkipDupes,!0)),this}},{key:"toStream",value:function(){}},{key:"destroy",value:function(){if(this.dead)return this;this._dead=!0;for(var t=this._wires,e=t.length,n=0;n<e;n++){t[n].destroy()}return this}},{key:"children",get:function(){return this._children.map(function(t){return t})}},{key:"parent",get:function(){return this._parent},set:function(t){var e=this.parent;if(e!==t){if(e){var n=e._children.indexOf(this);e._children.splice(n,1)}return this._parent=t,t&&t._children.push(this),this}}},{key:"dead",get:function(){return this._dead}},{key:"holding",get:function(){return this._currentFrame._holding}},{key:"scope",get:function(){return this._scope}}]),t}(),ct={},ft=[{name:"ACTION",sym:"^",react:!0,subscribe:!0,need:!0,solo:!0},{name:"WIRE",sym:"~",react:!0,follow:!0},{name:"WATCH",sym:null,react:!0,follow:!0},{name:"EVENT",sym:"@",react:!0,event:!0},{name:"ALIAS",sym:"(",then:!0,solo:!0},{name:"METHOD",sym:"`",then:!0,solo:!0},{name:"READ",sym:null,then:!0,read:!0},{name:"ATTR",sym:"#",then:!0,solo:!0,output:!0},{name:"AND",sym:"&",then:!0},{name:"STYLE",sym:"$",then:!0,solo:!0,output:!0},{name:"WRITE",sym:"=",then:!0,solo:!0},{name:"SPRAY",sym:"<",then:!0},{name:"RUN",sym:"*",then:!0,output:!0},{name:"FILTER",sym:">",then:!0}],lt={},vt={},dt={},yt={},mt={},pt={},_t={},gt=0;gt<ft.length;gt++){var kt=ft[gt],wt=kt.name,bt=kt.sym;bt&&(lt[bt]=kt,yt[bt]=wt),vt[wt]=kt,dt[wt]=bt,kt.then&&(_t[wt]=!0),kt.react&&(mt[wt]=!0,pt[wt]=!0)}var Tt=function t(e,n,r,i,a,s,u,o){q(this,t),this.name=e,this.operation=n,this.maybe=r||!1,this.need=i||!1,this.topic=a||null,this.alias=s||null,this.monitor=u||!1,this.extracts=o&&o.length?o:null},Et=[];ct.parse=c;var St=function(){function t(){q(this,t),this.dead=!1,this.children=[],this.name=null,this.pool=null,this.cleanupMethod=B.NOOP,this.pull=B.NOOP,this.processMethod=this.emit,this.actionMethod=null}return Y(t,[{key:"handle",value:function(t,e){return this.dead?this:(this.processMethod(t,this.name||e),this)}},{key:"drop",value:function(t){var e=this.children,n=e.indexOf(t);-1!==n&&e.splice(n,1)}},{key:"addTarget",value:function(t){this.children.push(t)}},{key:"emit",value:function(t,e,n,r){r=r||this,e=r.name||e;for(var i=r.children,a=i.length,s=0;s<a;s++){i[s].handle(t,e,n)}}},{key:"doFilter",value:function(t,e,n){this.actionMethod(t,e,n)&&this.emit(t,e,n)}},{key:"doMsg",value:function(t,e,n){t=this.actionMethod(t,e,n),this.emit(t,e,n)}},{key:"doTransform",value:function(t,e,n){t=this.actionMethod.msg?this.actionMethod.msg(t,e,n):t,e=this.actionMethod.source?this.actionMethod.source(t,e,n):e,n=this.actionMethod.topic?this.actionMethod.topic(t,e,n):n,this.emit(t,e,n)}},{key:"doDelay",value:function(t,e,n){setTimeout(this.emit,this.actionMethod(t,e,n)||0,t,e,n,this)}},{key:"doSource",value:function(t,e,n){this.name=this.actionMethod(),this.emit(t,this.name||e,n)}},{key:"doRun",value:function(t,e,n){this.actionMethod(t,e,n),this.emit(t,e,n)}},{key:"createPool",value:function(){this.pool=new it(this)}},{key:"doPool",value:function(t,e,n){this.pool.handle(t,this.name||e,n)}},{key:"destroy",value:function(){this.dead||this.cleanupMethod()}}]),t}();St.fromMonitor=function(t,e,n){var r=new St,i=e||t.name;r.name=i;var a=function(t,e,n){r.emit(t,i,n)};return r.cleanupMethod=function(){t.unsubscribe(a)},n&&(r.pull=function(){var e=t.survey();if(e){var n=e._msg,a=i||e._source,s=e._topic;r.emit(n,a,s,r)}}),t.monitor(a),r},St.fromSubscribe=function(t,e,n,r){var i=new St,a=n||e||t.name;i.name=a;var s=function(t,e,n){i.emit(t,a,n)};return i.cleanupMethod=function(){t.unsubscribe(s,e)},r&&(i.pull=function(){var e=t.peek();if(e){var n=e._msg,r=a||e._source,s=e._topic;i.emit(n,r,s,i)}}),t.subscribe(s,e),i},St.fromEvent=function(t,e,n){n=!!n;var r=new St;r.name=e;var i=t.addEventListener||t.addListener||t.on,a=t.removeEventListener||t.removeListener||t.off,s=function(t){r.handle(t,e)};return r.cleanupMethod=function(){a.call(t,e,s,n)},i.call(t,e,s,n),r};var At=0,Ot=function(){function t(e){q(this,t),this._id=++At,this._name=e,this._parent=null,this._children=[],this._busList=[],this._dataList=new Map,this._valves=new Map,this._mirrors=new Map,this._dead=!1}return Y(t,[{key:"react",value:function(t,e,n){if(!t)throw new Error("Need a Nyan phrase!");return K(this,new ht(this),t,e,n)}},{key:"clear",value:function(){this._dead||(U(this.children),U(this._busList),U(this._dataList.values()),this._children=[],this._busList=[],this._dataList.clear(),this._valves.clear(),this._mirrors.clear())}},{key:"destroy",value:function(){this.clear(),this.parent=null,this._dead=!0}},{key:"createChild",value:function(e){var n=new t(e);return n.parent=this,n}},{key:"insertParent",value:function(t){return t.parent=this.parent,this.parent=t,this}},{key:"_createMirror",value:function(t){var e=Object.create(t);return e._type=$.MIRROR,this._mirrors.set(t.name,e),e}},{key:"_createData",value:function(t,e){var n=new nt(this,t,e);return this._dataList.set(t,n),n}},{key:"data",value:function(t){return this.grab(t)||this._createData(t,$.NONE)}},{key:"action",value:function(t){var e=this.grab(t);return e?e.verify($.ACTION):this._createData(t,$.ACTION)}},{key:"state",value:function(t){var e=this.grab(t);if(e)return e.verify($.STATE);var n=this._createData(t,$.STATE);return this._createMirror(n),n}},{key:"findDataSet",value:function(t,e){var n={},r=!0,i=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(r=(s=u.next()).done);r=!0){var o=s.value;n[o]=this.find(o,e)}}catch(t){i=!0,a=t}finally{try{!r&&u.return&&u.return()}finally{if(i)throw a}}return n}},{key:"readDataSet",value:function(t,e){var n=this.findDataSet(t,e),r={},i=!0,a=!1,s=void 0;try{for(var u,o=n[Symbol.iterator]();!(i=(u=o.next()).done);i=!0){var h=u.value;if(h){var c=h.peek();c&&(r[h.name]=c.msg)}}}catch(t){a=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(a)throw s}}return r}},{key:"flatten",value:function(){var t=this,e=new Map,n=new Map,r=!0,i=!1,a=void 0;try{for(var s,u=t._dataList[Symbol.iterator]();!(r=(s=u.next()).done);r=!0){var o=z(s.value,2),h=o[0],c=o[1];e.set(h,c)}}catch(t){i=!0,a=t}finally{try{!r&&u.return&&u.return()}finally{if(i)throw a}}for(;t=t._parent;){var f=t._dataList,l=t._valves,v=t._mirrors;if(f.size){if(l.size)if(n.size){var d=!0,y=!1,m=void 0;try{for(var p,_=n.keys()[Symbol.iterator]();!(d=(p=_.next()).done);d=!0){var g=p.value;l.has(g)||n.delete(g)}}catch(t){y=!0,m=t}finally{try{!d&&_.return&&_.return()}finally{if(y)throw m}}}else{var k=!0,w=!1,b=void 0;try{for(var T,E=l.entries()[Symbol.iterator]();!(k=(T=E.next()).done);k=!0){var S=z(T.value,2),A=S[0],c=S[1];n.set(A,c)}}catch(t){w=!0,b=t}finally{try{!k&&E.return&&E.return()}finally{if(w)throw b}}}var O=n.size?n:f,N=!0,R=!1,D=void 0;try{for(var L,M=O.keys()[Symbol.iterator]();!(N=(L=M.next()).done);N=!0){var F=L.value;if(!e.has(F)){var I=v.get(F)||f.get(F);I&&e.set(F,I)}}}catch(t){R=!0,D=t}finally{try{!N&&M.return&&M.return()}finally{if(R)throw D}}}}return e}},{key:"find",value:function(t,e){var n=this.grab(t);if(n)return n;for(var r=this;r=r._parent;){var i=r._valves;if(i.size&&!i.has(t))break;var a=r._mirrors.get(t);if(a)return a;var s=r.grab(t);if(s)return s}
if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"findOuter",value:function(t,e){var n=!1;this.grab(t)&&(n=!0);for(var r=this;r=r._parent;){var i=r._valves;if(i.size&&!i.has(t))break;var a=r._mirrors.get(t);if(a){if(n)return a;n=!0}else{var s=r.grab(t);if(s){if(n)return s;n=!0}}}if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"grab",value:function(t,e){var n=this._dataList.get(t);if(!n&&e)throw new Error("Required Data: "+t+" not found!");return n||null}},{key:"transaction",value:function(t){if(Array.isArray(t))return this._multiWriteArray(t);if("object"===(void 0===t?"undefined":j(t)))return this._multiWriteHash(t);throw new Error("Write values must be in an array of object hash.")}},{key:"_multiWriteArray",value:function(t){var e=[],n=!0,r=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var u=a.value,o=this.find(u.name);o.silentWrite(u.value,u.topic),e.push(o)}}catch(t){r=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}var h=!0,c=!1,f=void 0;try{for(var l,v=e[Symbol.iterator]();!(h=(l=v.next()).done);h=!0){var d=l.value,y=t[0];d.refresh(y.topic)}}catch(t){c=!0,f=t}finally{try{!h&&v.return&&v.return()}finally{if(c)throw f}}return this}},{key:"_multiWriteHash",value:function(t){var e=[];for(var n in t){var r=t[n],i=this.find(n);i.silentWrite(r),e.push(i)}var a=!0,s=!1,u=void 0;try{for(var o,h=e[Symbol.iterator]();!(a=(o=h.next()).done);a=!0){o.value.refresh()}}catch(t){s=!0,u=t}finally{try{!a&&h.return&&h.return()}finally{if(s)throw u}}return this}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"children",get:function(){return this._children.map(function(t){return t})}},{key:"parent",get:function(){return this._parent},set:function(t){var e=this.parent;if(e!==t){if(e){var n=e._children.indexOf(this);e._children.splice(n,1)}return this._parent=t,t&&t._children.push(this),this}}},{key:"valves",set:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=t[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var s=i.value;this._valves.set(s,!0)}}catch(t){n=!0,r=t}finally{try{!e&&a.return&&a.return()}finally{if(n)throw r}}},get:function(){return Array.from(this._valves.keys())}}]),t}(),Nt={},Rt=[],Dt=!1;return Nt.fromEvent=function(t,e,n){var r=new ht;return r.event(t,e,n),r},Nt.enqueue=function(t){Rt.push(t),Dt||(Dt=!0,"undefined"!=typeof window&&window.requestAnimationFrame?requestAnimationFrame(Nt.flush):process.nextTick(Nt.flush))},Nt.createChild=Nt.scope=function(t){return new Ot(t)},Nt.flush=function(){Dt=!1;var t=0,e=Rt;for(Rt=[];e.length;){for(;e.length;){e.shift().release()}if(e=Rt,Rt=[],++t>10)throw new Error("Flush batch cycling loop > 10.",e)}},Nt});
//# sourceMappingURL=catbus.umd.min.js.map
