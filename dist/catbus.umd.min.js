!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Catbus=e()}(this,function(){"use strict";function t(){return!0}function e(){return!1}function r(t,e){return e}function n(t,e,r){return r}function i(t){return t}function a(){}function o(t){return"function"==typeof t?t:function(){return t}}function s(t){return G.hasOwnProperty(t)}function u(t,e){for(var r=t._streams,n=e._streams,i=r.length,a=0;a<i;a++){var o=r[a],s=new j(e);s.name=o.name,n.push(s),o.addTarget(s)}}function h(t,e){for(var r=[],n=t.split(/([{}])/).map(function(t){return t.trim()}).filter(function(t){return t}),i=0;i<n.length;i++){var a=n[i],o="}"===a||"{"===a?a:v(a);("string"==typeof o||o.length>0)&&r.push(o)}return l(r,e)}function l(t,e){for(var r=[],n=!0,i=0;i<t.length;i++){var a=t[i];if("string"!=typeof a)for(var o=0;o<a.length;o++){var s=a[o];n&&!e?(c(s),n=!1,r.push({name:"REACT",phrase:s})):(f(s),r.push({name:"PROCESS",phrase:s}))}else"{"===a?r.push({name:"FORK"}):"}"===a&&r.push({name:"BACK"})}return r}function c(t){for(var e=!1,r=0;r<t.length;r++){var n=t[r],i=n.operation=n.operation||"WATCH";if(e=e||tt[i],!et[i])throw new Error("This Nyan command cannot be in a reaction!")}if(!e)throw new Error("Nyan commands must begin with an observation!")}function f(t){var e=t[0],r=e.operation||"READ";if(!rt[r])throw new Error("Illegal operation in phrase!");for(var n=0;n<t.length;n++){var i=t[n];if(i.operation=i.operation||r,i.operation!==r)throw console.log("mult",i.operation,r),new Error("Multiple operation types in phrase (only one allowed)!")}}function v(t){for(var e=[],r=t.split("|").map(function(t){return t.trim()}).filter(function(t){return t}),n=0;n<r.length;n++){var i=r[n],a=d(i);e.push(a)}return e}function d(t){for(var e=[],r=t.split(",").map(function(t){return t.trim()}).filter(function(t){return t}),n=r.length,i=0;i<n;i++){var a=r[i];console.log("word=",a);var o=a.split(/([(?!:.)])/).map(function(t){return t.trim()}).filter(function(t){return t});console.log("to:",o);for(var s=o.shift(),u=a[0],h=Z[u],l=h?1:0,c=s.slice(l),f=[],v=!1,d=!1,y=null,m=null,p=!1;o.length;){switch(o.shift()){case".":var _=o.length&&o[0],g=o.length>1&&"?"===o[1];_&&(f.push({name:_,silentFail:g}),o.shift(),g&&o.shift());break;case"?":v=!0;break;case"!":p=!0;break;case":":if(o.length){var k=o[0];"("===k?d=!0:(y=k,o.shift())}else d=!0;break;case"(":o.length&&(m=o.shift())}}m=m||y||c;var b=new st(c,h,v,p,y,m,d,f);e.push(b)}return e}function y(t,e){var r=t.find(e.name,!e.maybe);return r&&r.peek(e.topic)}function m(t,e){var r=t.find(e.name,!e.maybe);return r&&r.survey()}function p(t){var e={},r=t.length;return function(n){for(var i=!1,a=0;a<r;a++){var o=t[a];e.hasOwnProperty(o)&&e[o]===n[o]||(i=!0),e[o]=n[o]}return i}}function _(t,e){var r=e.length,n=e[0];return r>1||n.monitor?b(t,e):k(t,n)}function g(t,e){return b(t,e,!0)}function k(t,e){return function(){var r=y(t,e);return r&&r.msg}}function b(t,e,r){var n=e.length;return function(i){i=r&&i||{};for(var a=0;a<n;a++){var o=e[a];if(o.monitor){var s=m(t,o),u=!0,h=!1,l=void 0;try{for(var c,f=s[Symbol.iterator]();!(u=(c=f.next()).done);u=!0){var v=P(c.value,2),d=v[0],p=v[1];i[d]=p}}catch(t){h=!0,l=t}finally{try{!u&&f.return&&f.return()}finally{if(h)throw l}}}else{var _=y(t,o),g=o.monitor?o.alias||o.topic:o.alias||o.name;_&&(i[g]=_.msg)}}return i}}function w(t,e,r){var n=t.find(e.name,!e.maybe);return e.monitor?j.fromMonitor(n,e.alias,r):j.fromSubscribe(n,e.topic,e.alias,r)}function S(t,e,r){return j.fromEvent(r,e.topic,e.useCapture,e.alias)}function T(t){return t.filter(function(t){return t.operation.need}).map(function(t){return t.alias})}function E(t,e,r,n){var i=[],a=[],o=[],s=[];if(1===r.length&&"ACTION"===r[0].operation)return void e.addFrame(w(t,r[0],!1));for(var u=0;u<r.length;u++){var h=r[u],l=h.operation;"WATCH"===l?(o.push(w(t,h,!0)),a.push(h.alias)):"WIRE"===l?o.push(w(t,h,!0)):"EVENT"===l&&o.push(S(t,h)),h.extracts&&s.push(h),h.need&&i.push(h.alias)}e.addFrame(o),o.length>1?(e.merge().group().batch(),i.length&&e.whenKeys(i),a.length&&e.filter(p(a))):a.length&&e.skipDupes()}function A(t,e,r,n,i){var a=r[0].operation;if("READ"===a){e.msg(_(t,r));var o=T(r);o.length&&e.whenKeys(o)}else if("AND"===a){e.msg(g(t,r));var s=T(r);s.length&&e.whenKeys(s)}else"FILTER"===a?O(e,r,n):"RUN"===a&&N(e,r,n)}function N(t,e,r){for(var n=e.length,i=0;i<n;i++)!function(n){var i=e[n],a=i.name,o=r[a],s=function(t,e,n){return o.call(r,t,e,n)};t.run(s)}(i)}function O(t,e,r){for(var n=e.length,i=0;i<n;i++)!function(n){var i=e[n],a=i.name,o=r[a],s=function(t,e,n){return o.call(r,t,e,n)};t.filter(s)}(i)}function R(t,e,r,n,i){for(var a=V.parse(r),o=a.length,s=0;s<o;s++){var u=a[s],h=u.name,l=u.phrase;"FORK"===h?e=e.fork():"BACK"===h?e=e.back():"PROCESS"===h?A(t,e,l,n,i):E(t,e,l,i)}return e}function D(t){for(var e=t.length,r=0;r<e;r++){t[r].destroy()}}var F={ASSERT_NEED_ONE_ARGUMENT:function(t){if(t.length<1)throw new Error("Method requires at least one argument.")},ASSERT_IS_FUNCTION:function(t){if("function"!=typeof t)throw new Error("Argument [func] is not of type function.")},getAlwaysTrue:function(){return function(){return!0}},getBatchTimer:function(){var t=this;return function(){lt.enqueue(t)}},getSyncTimer:function(){var t=this;return function(){t.release(t)}},getDeferTimer:function(){var t=this;return function(){setTimeout(t.release,0,t)}},getThrottleTimer:function(t){function e(o){if(!r.stream.dead){var s=r.keep.isEmpty;if(!o)return void(i?a=!0:(r.release(r),n=!1,i=setTimeout(e,t.call(r),!0)));s?n||(n=!0,a=!1,i=setTimeout(e,t.call(r),!0)):(r.release(r),n=!1,i=setTimeout(e,t.call(r),!0))}}var r=this;t=o(t);var n=!1,i=null,a=!1;r.keep.auto;return e},getQueue:function(e){e=e||1/0;var r=[],n=function(t,n){return r.length<e&&r.push(t),r};return n.isBuffer=t,n.next=function(){return r.shift()},n.isEmpty=function(){return 0===r.length},n.content=function(){return r},n},getScan:function(t,e){var r=2===arguments.length,n=void 0,i=!0,o=function(a,o){return i?(i=!1,n=r?t(e,a,o):a):n=t(n,a,o),n};return o.reset=a,o.next=o.content=function(){return n},o},getGroup:function(t){t=t||r;var e={},n=function(r,n){var i=t(r,n);return e[i]=r,e};return n.reset=function(){for(var t in e)delete e[t];n.isEmpty=!0},n.next=n.content=function(){return e},n},getKeepLast:function(t){if(!t||t<0){var e=void 0,r=function(t,r){return e=t};return r.reset=function(){r.isEmpty=!0},r.next=r.content=function(){return e},r}var n=[],i=function(e,r){return n.push(e),n.length>t&&n.shift(),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepFirst:function(t){if(!t||t<0){var e=void 0,r=function(t,r){return e=t};return r.reset=function(){e=!1,r.isEmpty=!0},r.next=r.content=function(){return e},r}var n=[],i=function(e,r){return n.length<t&&n.push(e),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepAll:function(){var t=[],e=function(e,r){return t.push(e),t};return e.reset=function(){for(;t.length;)t.shift();e.isEmpty=!0},e.next=e.content=function(){return t},e},getWhenCount:function(t){var e=!1,r=function(r){return e=e||r.length>=t};return r.reset=function(){e=!1},r},getWhenKeys:function(t){for(var e={},r=t.length,n=0;n<r;n++){var i=t[n];e[i]=!0}var a=!1,o=function(e){if(a)return!0;for(var n=0;n<r;n++){var i=t[n];if(!e.hasOwnProperty(i))return!1}return a=!0};return o.reset=function(){a=!1;for(var t in e)delete e[t]},o},getSkipDupes:function(){var t=!1,e=void 0;return function(r){var n=!t||r!==e;return e=r,t=!0,n}},ASSERT_NOT_HOLDING:function(t){if(t.holding)throw new Error("Method cannot be invoked while holding messages in the frame.")},ASSERT_IS_HOLDING:function(t){if(!t.holding)throw new Error("Method cannot be invoked unless holding messages in the frame.")}};F.TO_SOURCE=r,F.TO_TOPIC=n,F.To_MSG=i,F.FUNCTOR=o,F.ALWAYS_TRUE=t,F.ALWAYS_FALSE=e,F.NOOP=a;var L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},M=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},I=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),P=function(){function t(t,e){var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!e||r.length!==e);n=!0);}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),x=function(){function t(e,r,n){M(this,t),this._msg=e,this._topic=r,this._source=n,this._timestamp=Date.now()}return I(t,[{key:"msg",get:function(){return this._msg}},{key:"topic",get:function(){return this._topic}},{key:"source",get:function(){return this._source}},{key:"timestamp",get:function(){return this._timestamp}}]),t}(),C={ACTION:"action",MIRROR:"mirror",STATE:"state",COMPUTED:"computed",NONE:"none",ANY:"any"},G={};for(var H in C){var W=C[H];G[W]=H}var U=function(){function t(e,r){M(this,t),this._topic=e,this._subscribers=[],this._lastPacket=null,this._data=r,this._name=r._name,this._dead=!1}return I(t,[{key:"handle",value:function(t,e,r){if(!this.dead){e=e||this.topic;var n=this.name,i=new x(t,e,n);this.data.type!==C.ACTION&&(this._lastPacket=i);var a=[].concat(this._subscribers),o=a.length;if(!r)for(var s=0;s<o;s++){var u=a[s];"function"==typeof u?u.call(u,t,i):u.handle(t,i)}}}},{key:"destroy",value:function(){this.dead||(this._subscribers=null,this._lastPacket=null,this._dead=!0)}},{key:"add",value:function(t){this._subscribers.push(t)}},{key:"remove",value:function(t){var e=this._subscribers.indexOf(t);-1!==e&&this._subscribers.splice(e,1)}},{key:"lastPacket",get:function(){return this._lastPacket}},{key:"data",get:function(){return this._data}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"topic",get:function(){return this._topic}}]),t}(),K=function(){function t(e,r,n){if(M(this,t),n=n||C.NONE,!s(n))throw new Error("Invalid Data of type: "+n);this._scope=e,this._name=r,this._type=n,this._dead=!1,this._wildcardSubscriberList=new U(null,this),this._subscriberListsByTopic=new Map}return I(t,[{key:"destroy",value:function(){this.dead&&this._throwDead();var t=!0,e=!1,r=void 0;try{for(var n,i=this._subscriberListsByTopic.values()[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){n.value.destroy()}}catch(t){e=!0,r=t}finally{try{!t&&i.return&&i.return()}finally{if(e)throw r}}this._dead=!0}},{key:"_demandSubscriberList",value:function(t){t=t||void 0;var e=this._subscriberListsByTopic.get(t);return e||(e=new U(t,this),this._subscriberListsByTopic.set(t,e),e)}},{key:"verify",value:function(t){if(this.type===t)return this;throw new Error("Data "+this.name+" requested as type "+t+" exists as "+this.type)}},{key:"follow",value:function(t,e){this.dead&&this._throwDead(),e=e||void 0,this.subscribe(t,e);var r=this.peek();return r&&("function"==typeof t?t.call(t,r.msg,r):t.handle(r.msg,r)),this}},{key:"subscribe",value:function(t,e){return this.dead&&this._throwDead(),e=e||void 0,this._demandSubscriberList(e).add(t),this}},{key:"monitor",value:function(t){return this.dead&&this._throwDead(),this._wildcardSubscriberList.add(t),this}},{key:"unsubscribe",value:function(t,e){return this.dead&&this._throwDead(),e=e||void 0,this._demandSubscriberList(e).remove(t),this._wildcardSubscriberList.remove(t),this}},{key:"topics",value:function(){return this._subscriberListsByTopic.keys()}},{key:"survey",value:function(){var t=this._subscriberListsByTopic.entries(),e=new Map,r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=P(a.value,2),u=s[0],h=s[1];e.set(u,h.lastPacket)}}catch(t){n=!0,i=t}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return e}},{key:"peek",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this._subscriberListsByTopic.get(t);return e?e.lastPacket:null}},{key:"read",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this.peek(t);return e?e.msg:void 0}},{key:"silentWrite",value:function(t,e){this.dead&&this._throwDead(),e=e||void 0,this.write(t,e,!0)}},{key:"write",value:function(t,e,r){if(this.dead&&this._throwDead(),this.type===C.MIRROR)throw new Error("Mirror Data: "+this.name+" is read-only");e=e||void 0,this._demandSubscriberList(e).handle(t,e,r),this._wildcardSubscriberList.handle(t,e,r)}},{key:"refresh",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this.peek(t);return e&&this.write(e._msg,t),this}},{key:"toggle",value:function(t){return this.dead&&this._throwDead(),t=t||void 0,this.write(!this.read(t),t),this}},{key:"_throwDead",value:function(){throw new Error("Data: "+this.name+" is already dead.")}},{key:"scope",get:function(){return this._scope}},{key:"name",get:function(){return this._name}},{key:"type",get:function(){return this._type}},{key:"dead",get:function(){return this._dead}}]),t}(),B=function t(){M(this,t),this.until=null,this.reduce=null,this.when=null,this.clear=null,this.timer=null},q=function(){function t(e,r){M(this,t),r=r||[],this._bus=e,this._index=e._frames.length,this._holding=!1,this._streams=r,this._process=null,this._action=null,this._isFactory=!1,this._poolAspects=null;for(var n=r.length,i=0;i<n;i++)r[i].debugFrame=this}return I(t,[{key:"applySyncProcess",value:function(t,e,r){this._process=t,this._action=e,this._isFactory=r;var n=this._streams,i=n.length;if(r)for(var a=0;a<i;a++){var o=n[a];o.actionMethod=e(),o.processMethod=o[t]}else for(var s=0;s<i;s++){var u=n[s];u.actionMethod=e,u.processMethod=u[t]}return this}},{key:"hold",value:function(){this._holding=!0,this._poolAspects=new B;for(var t=this._streams,e=t.length,r=0;r<e;r++){var n=t[r];n.createPool(),n.processMethod=n.doPool}return this}},{key:"poll",value:function(){for(var t=this._streams,e=t.length,r=0;r<e;r++){t[r].poll()}}},{key:"run",value:function(t,e){return this.applySyncProcess("doRun",t,e)}},{key:"msg",value:function(t,e){return this.applySyncProcess("doMsg",F.FUNCTOR(t),e)}},{key:"transform",value:function(t,e){return this.applySyncProcess("doTransform",F.FUNCTOR(t),e)}},{key:"source",value:function(t,e){return this.applySyncProcess("doSource",F.FUNCTOR(t),e)}},{key:"delay",value:function(t,e){return this.applySyncProcess("doDelay",F.FUNCTOR(t),e)}},{key:"filter",value:function(t,e){return this.applySyncProcess("doFilter",t,e)}},{key:"skipDupes",value:function(){return this.applySyncProcess("doFilter",F.getSkipDupes,!0)}},{key:"clear",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["clear",t].concat(r))}},{key:"reduce",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["keep",t].concat(r))}},{key:"timer",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["timer",t].concat(r))}},{key:"when",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["when",t].concat(r))}},{key:"until",value:function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.buildPoolAspect.apply(this,["until",t].concat(r))}},{key:"buildPoolAspect",value:function(t,e){"timer"===t&&(this._holding=!1);for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this._poolAspects[t]=[e].concat(n);for(var a=this._streams,o=a.length,s=0;s<o;s++){var u=a[s],h=u.pool;h.build.apply(h,[t,e].concat(n))}return this}},{key:"destroy",value:function(){for(var t=this._streams,e=t.length,r=0;r<e;r++)t[r].cleanupMethod();this._streams=null}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return this._holding}},{key:"streams",get:function(){return[].concat(this._streams)}}]),t}(),Y=function(){function t(e){M(this,t),this.stream=e,this.keep=null,this.when=F.ALWAYS_TRUE,this.until=F.ALWAYS_TRUE,this.timer=null,this.clear=F.ALWAYS_FALSE,this.isPrimed=!1,this.source=e.name}return I(t,[{key:"handle",value:function(t,e){if(this.keep(t,e),!this.isPrimed){var r=this.keep.content();this.when(r)&&(this.isPrimed=!0,this.timer(this))}}},{key:"build",value:function(t,e){for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this[t]=e.call.apply(e,[this].concat(n))}},{key:"release",value:function(t){t=t||this;var e=!t.keep.isEmpty,r=e&&t.keep.next();t.clear()&&(t.keep.reset(),t.when.reset()),t.isPrimed=!1,e&&t.stream.emit(r,t.stream.name)}}]),t}(),j=function(){function t(){M(this,t),this.debugFrame=null,this.dead=!1,this.children=[],this.name=null,this.pool=null,this.cleanupMethod=F.NOOP,this.poll=F.NOOP,this.processMethod=this.emit,this.actionMethod=null}return I(t,[{key:"handle",value:function(t,e){return this.dead?this:(this.processMethod(t,e),this)}},{key:"drop",value:function(t){var e=this.children,r=e.indexOf(t);-1!==r&&e.splice(r,1)}},{key:"addTarget",value:function(t){this.children.push(t)}},{key:"emit",value:function(t,e,r,n){n=n||this;for(var i=n.children,a=i.length,o=0;o<a;o++){i[o].handle(t,e,r)}}},{key:"doFilter",value:function(t,e,r){this.actionMethod(t,e,r)&&this.emit(t,e,r)}},{key:"doMsg",value:function(t,e,r){t=this.actionMethod(t,e,r),this.emit(t,e,r)}},{key:"doTransform",value:function(t,e,r){t=this.actionMethod.msg?this.actionMethod.msg(t,e,r):t,e=this.actionMethod.source?this.actionMethod.source(t,e,r):e,r=this.actionMethod.topic?this.actionMethod.topic(t,e,r):r,this.emit(t,e,r)}},{key:"doDelay",value:function(t,e,r){setTimeout(this.emit,this.actionMethod(t,e,r)||0,t,e,r,this)}},{key:"doSource",value:function(t,e,r){e=this.actionMethod(t,e,r),this.emit(t,e,r)}},{key:"doRun",value:function(t,e,r){this.actionMethod(t,e,r),this.emit(t,e,r)}},{key:"createPool",value:function(){this.pool=new Y(this)}},{key:"doPool",value:function(t,e,r){this.pool.handle(t,e,r)}},{key:"destroy",value:function(){this.dead||this.cleanupMethod()}}]),t}();j.fromMonitor=function(t,e,r){var n=new j,i=e||t.name;n.name=i;var a=function(t,e,r){n.emit(t,i||e,r)};return n.cleanupMethod=function(){t.unsubscribe(a)},r&&(n.poll=function(){var e=t.survey();if(e){var r=e._msg,a=i||e._source,o=e._topic;n.emit(r,a,o,n)}}),t.monitor(a),n},j.fromSubscribe=function(t,e,r,n){var i=new j,a=r||e||t.name;i.name=a;var o=function(t,e,r){i.emit(t,a||e,r)};return i.cleanupMethod=function(){t.unsubscribe(o,e)},n&&(i.poll=function(){var e=t.peek();if(e){var r=e._msg,n=a||e._source,o=e._topic;i.emit(r,n,o,i)}}),t.subscribe(o,e),i},j.fromEvent=function(t,e,r){r=!!r;var n=new j;n.name=e;var i=t.addEventListener||t.addListener||t.on,a=t.removeEventListener||t.removeListener||t.off,o=function(t){n.handle(t,e)};return n.cleanupMethod=function(){a.call(t,e,o,r)},i.call(t,e,o,r),n};for(var z=function(){function t(e,r){M(this,t),this._frames=[],this._dead=!1,this._scope=e,this._children=[],this._parent=null,e&&e._busList.push(this);var n=new q(this,r||[]);this._frames.push(n),this._currentFrame=n}return I(t,[{key:"addFrame",value:function(t){var e=this._currentFrame,r=this._currentFrame=new q(this,t);return this._frames.push(r),u(e,r),r}},{key:"spawn",value:function(){}},{key:"split",value:function(){F.ASSERT_NOT_HOLDING(this)}},{key:"fork",value:function(){F.ASSERT_NOT_HOLDING(this);var e=new t(this.scope);return e.parent=this,u(this._currentFrame,e._currentFrame),e}},{key:"back",value:function(){if(!this._parent)throw new Error("Cannot exit fork, parent does not exist!");return this.parent}},{key:"add",value:function(t){var e=this.addFrame();return u(t._currentFrame,e),this}},{key:"defer",value:function(){return this.timer(F.getDeferTimer)}},{key:"batch",value:function(){return this.timer(F.getBatchTimer)}},{key:"sync",value:function(){return this.timer(F.getSyncTimer)}},{key:"throttle",value:function(t){return this.timer(F.getThrottleTimer,t)}},{key:"hold",value:function(){return F.ASSERT_NOT_HOLDING(this),this.addFrame().hold(),this}},{key:"poll",value:function(){var t=this._frames[0];if(t._streams.length>0)return t.poll(),this;if(1!==this._frames.length){this._frames[1].poll()}return this}},{key:"event",value:function(t,e,r,n){r=r||t,F.ASSERT_NOT_HOLDING(this);var i=j.fromEvent(e,r,n);return i.name=t,this.addFrame([i]),this}},{key:"eventList",value:function(t){F.ASSERT_NOT_HOLDING(this);for(var e=t.length,r=[],n=0;n<e;n++){var i=t[n],a=i.eventName||i.name,o=i.name||i.eventName,s=j.fromEvent(i.target,a,i.useCapture);s.name=o,r.push(s)}return this.addFrame(r),this}},{key:"scan",value:function(t,e){return this.reduce(F.getScan,t,e)}},{key:"delay",value:function(t){return F.ASSERT_NEED_ONE_ARGUMENT(arguments),F.ASSERT_NOT_HOLDING(this),this.addFrame().delay(t),this}},{key:"willReset",value:function(){return F.ASSERT_IS_HOLDING(this),this.clear(F.getAlwaysTrue)}},{key:"whenKeys",value:function(t){return this.when(F.getWhenKeys,t)}},{key:"group",value:function(t){return F.ASSERT_NOT_HOLDING(this),this.addFrame().hold().reduce(F.getGroup,t),this}},{key:"groupByTopic",value:function(){return F.ASSERT_NOT_HOLDING(this),this.addFrame().hold().reduce(F.getGroup,F.TO_TOPIC),this}},{key:"all",value:function(){return this.reduce(F.getKeepAll)}},{key:"first",value:function(t){return this.reduce(F.getKeepFirst,t)}},{key:"last",value:function(t){return this.reduce(F.getKeepLast,t)}},{key:"clear",value:function(t){for(var e,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return(e=this._currentFrame).clear.apply(e,[t].concat(n))}},{key:"reduce",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).reduce.apply(e,[t].concat(i)):(r=this.addFrame().hold()).reduce.apply(r,[t].concat(i)).timer(F.getSyncTimer),this}},{key:"timer",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).timer.apply(e,[t].concat(i)):(r=this.addFrame().hold()).timer.apply(r,[t].concat(i)),this}},{key:"until",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).until.apply(e,[t].concat(i)):(r=this.addFrame().hold()).until.apply(r,[t].concat(i)).timer(F.getSyncTimer),this}},{key:"when",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).when.apply(e,[t].concat(i)):(r=this.addFrame().hold()).when.apply(r,[t].concat(i)).timer(F.getSyncTimer),this}},{key:"run",value:function(t){return F.ASSERT_IS_FUNCTION(t),F.ASSERT_NOT_HOLDING(this),this.addFrame().run(t),this}},{key:"merge",value:function(){F.ASSERT_NOT_HOLDING(this);var t=new j,e=this._currentFrame,r=this._currentFrame=new q(this,[t]);this._frames.push(r);for(var n=e._streams,i=n.length,a=0;a<i;a++){n[a].addTarget(t)}return this}},{key:"msg",value:function(t){return F.ASSERT_NEED_ONE_ARGUMENT(arguments),F.ASSERT_NOT_HOLDING(this),this.addFrame().msg(t),this}},{key:"transform",value:function(t){return F.ASSERT_NEED_ONE_ARGUMENT(arguments),F.ASSERT_NOT_HOLDING(this),this.addFrame().transform(t),this}},{key:"source",value:function(t){return F.ASSERT_NEED_ONE_ARGUMENT(arguments),F.ASSERT_NOT_HOLDING(this),this.addFrame().source(t),this}},{key:"filter",value:function(t){return F.ASSERT_NEED_ONE_ARGUMENT(arguments),F.ASSERT_IS_FUNCTION(t),F.ASSERT_NOT_HOLDING(this),this.addFrame().filter(t),this}},{key:"skipDupes",value:function(){return F.ASSERT_NOT_HOLDING(this),this.addFrame().skipDupes(),this}},{key:"toStream",value:function(){}},{key:"destroy",value:function(){if(this.dead)return this;this._dead=!0;var t=this._frames,e=!0,r=!1,n=void 0;try{for(var i,a=t[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){i.value.destroy()}}catch(t){r=!0,n=t}finally{try{!e&&a.return&&a.return()}finally{if(r)throw n}}return this}},{key:"children",get:function(){return this._children.map(function(t){return t})}},{key:"parent",get:function(){return this._parent},set:function(t){var e=this.parent;if(e!==t){if(e){var r=e._children.indexOf(this);e._children.splice(r,1)}return this._parent=t,t&&t._children.push(this),this}}},{key:"dead",get:function(){return this._dead}},{key:"holding",get:function(){return this._currentFrame._holding}},{key:"scope",get:function(){return this._scope}}]),t}(),V={},Q=[{name:"ACTION",sym:"^",react:!0,subscribe:!0,need:!0,solo:!0},{name:"WIRE",sym:"~",react:!0,follow:!0},{name:"WATCH",sym:null,react:!0,follow:!0},{name:"EVENT",sym:"@",react:!0,event:!0},{name:"READ",sym:null,then:!0,read:!0},{name:"ATTR",sym:"#",then:!0,solo:!0,output:!0},{name:"AND",sym:"&",then:!0},{name:"STYLE",sym:"$",then:!0,solo:!0,output:!0},{name:"WRITE",sym:"=",then:!0,solo:!0},{name:"RUN",sym:"*",then:!0,output:!0},{name:"FILTER",sym:"%",then:!0}],$={},J={},X={},Z={},tt={},et={},rt={},nt=0;nt<Q.length;nt++){var it=Q[nt],at=it.name,ot=it.sym;ot&&($[ot]=it,Z[ot]=at),J[at]=it,X[at]=ot,it.then&&(rt[at]=!0),it.react&&(tt[at]=!0,et[at]=!0)}var st=function t(e,r,n,i,a,o,s,u){M(this,t),this.name=e,this.operation=r,this.maybe=n||!1,this.need=i||!1,this.topic=a||null,this.alias=o||null,this.monitor=s||!1,this.extracts=u||null};V.parse=h;var ut=0,ht=function(){function t(e){M(this,t),this._id=++ut,this._name=e,this._parent=null,this._children=[],this._busList=[],this._dataList=new Map,this._valves=new Map,this._mirrors=new Map,this._dead=!1}return I(t,[{key:"react",value:function(t,e,r){if(!t)throw new Error("Need a Nyan phrase!");return R(this,new z(this),t,e,r)}},{key:"clear",value:function(){this._dead||(D(this.children),D(this._busList),D(this._dataList.values()),this._children=[],this._busList=[],this._dataList.clear(),this._valves.clear(),this._mirrors.clear())}},{key:"destroy",value:function(){this.clear(),this.parent=null,this._dead=!0}},{key:"createChild",value:function(e){var r=new t(e);return r.parent=this,r}},{key:"insertParent",value:function(t){return t.parent=this.parent,this.parent=t,this}},{key:"_createMirror",value:function(t){var e=Object.create(t);return e._type=C.MIRROR,this._mirrors.set(t.name,e),e}},{key:"_createData",value:function(t,e){var r=new K(this,t,e);return this._dataList.set(t,r),r}},{key:"data",value:function(t){return this.grab(t)||this._createData(t,C.NONE)}},{key:"action",value:function(t){var e=this.grab(t);return e?e.verify(C.ACTION):this._createData(t,C.ACTION)}},{key:"state",value:function(t){var e=this.grab(t);if(e)return e.verify(C.STATE);var r=this._createData(t,C.STATE);return this._createMirror(r),r}},{key:"findDataSet",value:function(t,e){var r={},n=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;r[u]=this.find(u,e)}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return r}},{key:"readDataSet",value:function(t,e){var r=this.findDataSet(t,e),n={},i=!0,a=!1,o=void 0;try{for(var s,u=r[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var h=s.value;if(h){var l=h.peek();l&&(n[h.name]=l.msg)}}}catch(t){a=!0,o=t}finally{try{!i&&u.return&&u.return()}finally{if(a)throw o}}return n}},{key:"flatten",value:function(){var t=this,e=new Map,r=new Map,n=!0,i=!1,a=void 0;try{for(var o,s=t._dataList[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=P(o.value,2),h=u[0],l=u[1];e.set(h,l)}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}for(;t=t._parent;){var c=t._dataList,f=t._valves,v=t._mirrors;if(c.size){if(f.size)if(r.size){var d=!0,y=!1,m=void 0;try{for(var p,_=r.keys()[Symbol.iterator]();!(d=(p=_.next()).done);d=!0){var g=p.value;f.has(g)||r.delete(g)}}catch(t){y=!0,m=t}finally{try{!d&&_.return&&_.return()}finally{if(y)throw m}}}else{var k=!0,b=!1,w=void 0;try{for(var S,T=f.entries()[Symbol.iterator]();!(k=(S=T.next()).done);k=!0){var E=P(S.value,2),A=E[0],l=E[1];r.set(A,l)}}catch(t){b=!0,w=t}finally{try{!k&&T.return&&T.return()}finally{if(b)throw w}}}var N=r.size?r:c,O=!0,R=!1,D=void 0;try{for(var F,L=N.keys()[Symbol.iterator]();!(O=(F=L.next()).done);O=!0){var M=F.value;if(!e.has(M)){var I=v.get(M)||c.get(M);I&&e.set(M,I)}}}catch(t){R=!0,D=t}finally{try{!O&&L.return&&L.return()}finally{if(R)throw D}}}}return e}},{key:"find",value:function(t,e){var r=this.grab(t);if(r)return r;for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(t))break;var a=n._mirrors.get(t);if(a)return a;var o=n.grab(t);if(o)return o}if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"findOuter",value:function(t,e){var r=!1;this.grab(t)&&(r=!0);for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(t))break;var a=n._mirrors.get(t);if(a){if(r)return a;r=!0}else{var o=n.grab(t);if(o){if(r)return o;r=!0}}}if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"grab",value:function(t,e){var r=this._dataList.get(t);if(!r&&e)throw new Error("Required Data: "+t+" not found!");return r||null}},{key:"transaction",value:function(t){if(Array.isArray(t))return this._multiWriteArray(t);if("object"===(void 0===t?"undefined":L(t)))return this._multiWriteHash(t);throw new Error("Write values must be in an array of object hash.")}},{key:"_multiWriteArray",value:function(t,e){var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value,h=this.find(u.name);h.silentWrite(u.value,u.topic),r.push(h)}}catch(t){i=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}var l=!0,c=!1,f=void 0;try{for(var v,d=r[Symbol.iterator]();!(l=(v=d.next()).done);l=!0){var y=v.value,m=t[0];y.refresh(m.topic)}}catch(t){c=!0,f=t}finally{try{!l&&d.return&&d.return()}finally{if(c)throw f}}return this}},{key:"_multiWriteHash",value:function(t){var e=[];for(var r in t){var n=t[r],i=this.find(r);i.silentWrite(n),e.push(i)}var a=!0,o=!1,s=void 0;try{for(var u,h=e[Symbol.iterator]();!(a=(u=h.next()).done);a=!0){u.value.refresh()}}catch(t){o=!0,s=t}finally{try{!a&&h.return&&h.return()}finally{if(o)throw s}}return this}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"children",get:function(){return this._children.map(function(t){return t})}},{key:"parent",get:function(){return this._parent},set:function(t){var e=this.parent;if(e!==t){if(e){var r=e._children.indexOf(this);e._children.splice(r,1)}return this._parent=t,t&&t._children.push(this),this}}},{key:"valves",set:function(t){var e=!0,r=!1,n=void 0;try{for(var i,a=t[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;this._valves.set(o,!0)}}catch(t){r=!0,n=t}finally{try{!e&&a.return&&a.return()}finally{if(r)throw n}}},get:function(){return Array.from(this._valves.keys())}}]),t}(),lt={},ct=[],ft=!1;return lt.fromEvent=function(t,e,r){var n=j.fromEvent(t,e,r);return new z(null,[n])},lt.enqueue=function(t){ct.push(t),ft||(ft=!0,"undefined"!=typeof window&&window.requestAnimationFrame?requestAnimationFrame(lt.flush):process.nextTick(lt.flush))},lt.scope=function(t){console.log("NYAN");var e=V.parse("^bunny?:error(badbunny), cow:(huh), moo2?(meow) | %kitten                       {*toMuffin | =order {=raw}} =meow {you} =woo"),r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;console.log("CMD: ",s.name);var u=s.phrase;if(u){var h=!0,l=!1,c=void 0;try{for(var f,v=u[Symbol.iterator]();!(h=(f=v.next()).done);h=!0){var d=f.value;console.log(d.name,d.operation,d.maybe)}}catch(t){l=!0,c=t}finally{try{!h&&v.return&&v.return()
}finally{if(l)throw c}}}}}catch(t){n=!0,i=t}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return console.log(e),console.log("root is ",t),new ht(t)},lt.flush=function(){ft=!1;var t=0,e=ct;for(ct=[];e.length;){for(;e.length;){e.shift().release()}if(e=ct,ct=[],++t>10)throw new Error("Flush batch cycling loop > 10.",e)}},lt});
//# sourceMappingURL=catbus.umd.min.js.map
