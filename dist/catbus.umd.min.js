!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Catbus=e()}(this,function(){"use strict";function t(t){return $.hasOwnProperty(t)}function e(t,e,r,n,i){t.emit(e,r,n,i)}function r(){return!0}function n(){return!1}function i(t,e){return e}function a(t,e,r){return r}function s(t){return t}function u(){}function o(t){return"function"==typeof t?t:function(){return t}}function h(t){Et=[];for(var e=t.split(/([`])/),r=[],n=!1;e.length;){var i=e.shift();"`"===i?(n=!n,r.push(i)):n?Et.push(i):r.push(i)}return r.join("")}function f(t,e){t=h(t);for(var r=[],n=t.split(/([{}]|-})/).map(function(t){return t.trim()}).filter(function(t){return t}),i=0;i<n.length;i++){var a=n[i],s="}"===a||"{"===a||"-}"===a?a:d(a);("string"==typeof s||s.length>0)&&r.push(s)}return c(r,e)}function c(t,e){for(var r=[],n=!0,i=0;i<t.length;i++){var a=t[i];if("string"!=typeof a)for(var s=0;s<a.length;s++){var u=a[s];n&&!e?(l(u),n=!1,r.push({name:"REACT",phrase:u})):(v(u),r.push({name:"PROCESS",phrase:u}))}else"{"===a?r.push({name:"FORK"}):"}"===a?r.push({name:"BACK"}):"-}"===a&&r.push({name:"JOIN"})}return r}function l(t){for(var e=!1,r=0;r<t.length;r++){var n=t[r],i=n.operation=n.operation||"WATCH";if(e=e||mt[i],!pt[i])throw new Error("This Nyan command cannot be in a reaction!")}if(!e)throw new Error("Nyan commands must begin with an observation!")}function v(t){var e=t[0],r=e.operation||"READ";if(!_t[r])throw new Error("Illegal operation in phrase!");for(var n=0;n<t.length;n++){var i=t[n];if(i.operation=i.operation||r,i.operation!==r)throw new Error("Multiple operation types in phrase (only one allowed)!")}}function d(t){for(var e=[],r=t.split("|").map(function(t){return t.trim()}).filter(function(t){return t}),n=0;n<r.length;n++){var i=r[n],a=y(i);e.push(a)}return e}function y(t){for(var e=[],r=t.split(",").map(function(t){return t.trim()}).filter(function(t){return t}),n=r.length,i=0;i<n;i++){for(var a=r[i],s=a.split(/([(?!:.`)])/),u=[],o=!1;s.length;){var h=s.shift();if("`"===h)o=!o,u.push(h);else if(o)u.push(h);else{var f=h.trim();f&&u.push(f)}}var c=u.shift(),l=a[0],v=yt[l],d=v?1:0,y=c.slice(d).trim(),m=[],p=!1,_=!1,g=null,k=null,w=!1;if("ALIAS"===v)k=u.shift(),u.shift();else if("METHOD"===v){u.shift();var b=Et.shift(),T=b.indexOf(" ");for(-1===T?m.push(b):(m.push(b.slice(0,T)),b.length>T&&m.push(b.slice(T+1)));u.length;)u.shift()}for(;u.length;){switch(u.shift()){case".":var E=u.length&&u[0],S=u.length>1&&"?"===u[1];E&&(m.push({name:E,silentFail:S}),u.shift(),S&&u.shift());break;case"?":p=!0;break;case"!":w=!0;break;case":":if(u.length){var A=u[0];"("===A?_=!0:(g=A,u.shift())}else _=!0;break;case"(":u.length&&(k=u.shift())}}k=k||g||y;var O=new Tt(y,v,p,w,g,k,_,m);e.push(O)}return e}function m(t,e){var r=t.find(e.name,!e.maybe);return r&&r.peek(e.topic)}function p(t,e){var r=t.find(e.name,!e.maybe);return r&&r.survey()}function _(t){console.log("throwing ",t);var e=new Error(t);throw console.log(this,e),e}function g(t){var e={},r=t.length;return function(n){for(var i=!1,a=0;a<r;a++){var s=t[a];e.hasOwnProperty(s)&&e[s]===n[s]||(i=!0),e[s]=n[s]}return i}}function k(t,e){var r=t.find(e.name,!e.maybe);return function(t){r.write(t,e.topic)}}function w(t,e){for(var r={},n={},i=e.length,a=0;a<i;a++){var s=e[a],u=t.find(s.name,!s.maybe);u&&(r[s.alias]=s,n[s.alias]=u)}return function(t){for(var e in t){var i=n[e];if(i){var a=r[e],s=t[e];i.silentWrite(s,a.topic)}}for(var u in t){var o=n[u];if(o){var h=r[u];o.refresh(h.topic)}}}}function b(t,e){var r=e.length,n=e[0];return r>1||n.monitor?S(t,e):E(t,n)}function T(t,e){return S(t,e,!0)}function E(t,e){return function(){var r=m(t,e);return r&&r.msg}}function S(t,e,r){var n=e.length;return function(i,a){var s={};if(r)if(a)s[a]=i;else for(var u in i)s[u]=i[u];for(var o=0;o<n;o++){var h=e[o];if(h.monitor){var f=p(t,h),c=!0,l=!1,v=void 0;try{for(var d,y=f[Symbol.iterator]();!(c=(d=y.next()).done);c=!0){var _=Y(d.value,2),g=_[0],k=_[1];s[g]=k}}catch(t){l=!0,v=t}finally{try{!c&&y.return&&y.return()}finally{if(l)throw v}}}else{var w=m(t,h),b=h.monitor?h.alias||h.topic:h.alias||h.name;w&&(s[b]=w.msg)}}return s}}function A(t,e,r){var n=t.find(e.name,!e.maybe);return e.monitor?st.fromMonitor(n,e.alias,r):st.fromSubscribe(n,e.topic,e.alias,r)}function O(t){return null!==t&&("function"==typeof t||"object"===(void 0===t?"undefined":B(t)))}function N(t,e){return st.fromEvent(e,t.topic,t.useCapture,t.alias)}function R(t,e){for(var r=t,n=e.length,i=0;i<n;i++){var a=e[i];if(!O(r)){if(a.silentFail)return;_("Cannot access property '"+a.name+"' of "+r)}r=r[a.name]}return r}function D(t){return t.filter(function(t){return t.operation.need}).map(function(t){return t.alias})}function L(t){for(var e=t.length,r={},n=0;n<e;n++){var i=t[n];r[i.alias]=i.extracts}return function(t){var e={};for(var n in r){t.hasOwnProperty(n)&&(e[n]=R(t[n],r[n]))}return e}}function F(t){var e=t.extracts;return function(t){return R(t,e)}}function I(t,e,r,n){var i=[],a=[],s=[];if(1===r.length&&"ACTION"===r[0].operation){var u=r[0];return void e.wire(A(t,u,!1))}for(var o=0;o<r.length;o++){var h=r[o],f=h.operation;"WATCH"===f?(e.wire(A(t,h,!0)),a.push(h.alias)):"WIRE"===f?e.wire(A(t,h,!0)):"EVENT"===f&&e.wire(N(h,n)),h.extracts&&s.push(h),h.need&&i.push(h.alias)}e._wires.length>1?(e.merge().group().batch(),s.length&&e.msg(L(s)),i.length&&e.hasKeys(i),a.length&&e.filter(g(a))):(s.length&&e.msg(F(s[0])),a.length&&e.skipDupes())}function x(t){return!!t}function M(t){return!t}function C(t,e){switch(e.extracts[0]){case"true":t.msg(!0);break;case"false":t.msg(!1);break;case"null":t.msg(null);break;case"undefined":t.msg(void 0);break;case"array":t.msg([]);break;case"object":t.msg({});break;case"truthy":t.filter(x);break;case"falsey":t.filter(M);break;case"string":t.msg(function(){return e.extracts[1]})}}function H(t,e,r,n,i){var a=r[0].operation;if("READ"===a){e.msg(b(t,r));var s=D(r);s.length&&e.whenKeys(s)}else if("AND"===a){e.msg(T(t,r));var u=D(r);u.length&&e.whenKeys(u)}else"METHOD"===a?C(e,r[0]):"FILTER"===a?G(e,r,n):"RUN"===a?W(e,r,n):"ALIAS"===a?P(e,r[0]):"WRITE"===a?e.run(k(t,r[0])):"SPRAY"===a&&e.run(w(t,r))}function W(t,e,r){for(var n=e.length,i=0;i<n;i++)!function(n){var i=e[n],a=i.name,s=r[a],u=function(t,e,n){return s.call(r,t,e,n)};t.msg(u)}(i)}function P(t,e){t.source(e.alias)}function G(t,e,r){for(var n=e.length,i=0;i<n;i++)!function(n){var i=e[n],a=i.name,s=r[a],u=function(t,e,n){return s.call(r,t,e,n)};t.filter(u)}(i)}function K(t,e,r,n,i){for(var a=ft.parse(r),s=a.length,u=0;u<s;u++){var o=a[u],h=o.name,f=o.phrase;"JOIN"===h?(e=e.join(),e.merge(),e.group(),e.sync()):"FORK"===h?e=e.fork():"BACK"===h?e=e.back():"PROCESS"===h?H(t,e,f,n,i):I(t,e,f,i)}return e}function U(t){for(var e=t.length,r=0;r<e;r++){t[r].destroy()}}var B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},j=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},q=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),Y=function(){function t(t,e){var r=[],n=!0,i=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(n=(s=u.next()).done)&&(r.push(s.value),!e||r.length!==e);n=!0);}catch(t){i=!0,a=t}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),z=function(t){return Array.isArray(t)?t:Array.from(t)},J=function(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)},V=function(){function t(e,r,n){j(this,t),this._msg=e,this._topic=r,this._source=n,this._timestamp=Date.now()}return q(t,[{key:"msg",get:function(){return this._msg}},{key:"topic",get:function(){return this._topic}},{key:"source",get:function(){return this._source}},{key:"timestamp",get:function(){return this._timestamp}}]),t}(),Q={ACTION:"action",MIRROR:"mirror",STATE:"state",COMPUTED:"computed",NONE:"none",ANY:"any"},$={};for(var X in Q){var Z=Q[X];$[Z]=X}var tt=function(){function t(e,r){j(this,t),this._topic=e,this._subscribers=[],this._lastPacket=null,this._data=r,this._name=r._name,this._dead=!1}return q(t,[{key:"handle",value:function(t,e,r){if(!this.dead){e=e||this.topic;var n=this.name,i=new V(t,e,n);this.data.type!==Q.ACTION&&(this._lastPacket=i);var a=[].concat(this._subscribers),s=a.length;if(!r)for(var u=0;u<s;u++){var o=a[u];"function"==typeof o?o.call(o,t,i):o.handle(t,i)}}}},{key:"destroy",value:function(){this.dead||(this._subscribers=null,this._lastPacket=null,this._dead=!0)}},{key:"add",value:function(t){this._subscribers.push(t)}},{key:"remove",value:function(t){var e=this._subscribers.indexOf(t);-1!==e&&this._subscribers.splice(e,1)}},{key:"lastPacket",get:function(){return this._lastPacket}},{key:"data",get:function(){return this._data}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"topic",get:function(){return this._topic}}]),t}(),et=function(){function e(r,n,i){if(j(this,e),i=i||Q.NONE,!t(i))throw new Error("Invalid Data of type: "+i);this._scope=r,this._name=n,this._type=i,this._dead=!1,this._wildcardSubscriberList=new tt(null,this),this._subscriberListsByTopic=new Map}return q(e,[{key:"destroy",value:function(){this.dead&&this._throwDead();var t=!0,e=!1,r=void 0;try{for(var n,i=this._subscriberListsByTopic.values()[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){n.value.destroy()}}catch(t){e=!0,r=t}finally{try{!t&&i.return&&i.return()}finally{if(e)throw r}}this._dead=!0}},{key:"_demandSubscriberList",value:function(t){t=t||void 0;var e=this._subscriberListsByTopic.get(t);return e||(e=new tt(t,this),this._subscriberListsByTopic.set(t,e),e)}},{key:"verify",value:function(t){if(this.type===t)return this;throw new Error("Data "+this.name+" requested as type "+t+" exists as "+this.type)}},{key:"follow",value:function(t,e){this.dead&&this._throwDead(),e=e||void 0,this.subscribe(t,e);var r=this.peek();return r&&("function"==typeof t?t.call(t,r.msg,r):t.handle(r.msg,r)),this}},{key:"subscribe",value:function(t,e){return this.dead&&this._throwDead(),e=e||void 0,this._demandSubscriberList(e).add(t),this}},{key:"monitor",value:function(t){return this.dead&&this._throwDead(),this._wildcardSubscriberList.add(t),this}},{key:"unsubscribe",value:function(t,e){return this.dead&&this._throwDead(),e=e||void 0,this._demandSubscriberList(e).remove(t),this._wildcardSubscriberList.remove(t),this}},{key:"topics",value:function(){return this._subscriberListsByTopic.keys()}},{key:"survey",value:function(){var t=this._subscriberListsByTopic.entries(),e=new Map,r=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var u=Y(a.value,2),o=u[0],h=u[1];e.set(o,h.lastPacket)}}catch(t){n=!0,i=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return e}},{key:"peek",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this._subscriberListsByTopic.get(t);return e?e.lastPacket:null}},{key:"read",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this.peek(t);return e?e.msg:void 0}},{key:"silentWrite",value:function(t,e){this.dead&&this._throwDead(),e=e||void 0,this.write(t,e,!0)}},{key:"write",value:function(t,e,r){if(this.dead&&this._throwDead(),this.type===Q.MIRROR)throw new Error("Mirror Data: "+this.name+" is read-only");e=e||void 0,this._demandSubscriberList(e).handle(t,e,r),this._wildcardSubscriberList.handle(t,e,r)}},{key:"refresh",value:function(t){this.dead&&this._throwDead(),t=t||void 0;var e=this.peek(t);return e&&this.write(e._msg,t),this}},{key:"toggle",value:function(t){return this.dead&&this._throwDead(),t=t||void 0,this.write(!this.read(t),t),this}},{key:"_throwDead",value:function(){throw new Error("Data: "+this.name+" is already dead.")}},{key:"scope",get:function(){return this._scope}},{key:"name",get:function(){return this._name}},{key:"type",get:function(){return this._type}},{key:"dead",get:function(){return this._dead}}]),e}(),rt=function(){function t(r){j(this,t),this.process=r&&r.process?this[r.process]:e,this.action=r?r.stateful?r.action.apply(r,J(r.args)):r.action:null}return q(t,[{key:"handle",value:function(t,e,r,n,i){this.process(t,e,r,n,i)}},{key:"run",value:function(t,e,r,n,i){this.action(r,n,i),t.emit(e,r,n,i)}},{key:"msg",value:function(t,e,r,n,i){r=this.action(r,n,i),t.emit(e,r,n,i)}},{key:"source",value:function(t,e,r,n,i){n=this.action(r,n,i),t.emit(e,r,n,i)}},{key:"filter",value:function(t,e,r,n,i){this.action(r,n,i)&&t.emit(e,r,n,i)}},{key:"delay",value:function(t,e,r,n,i){function a(){t.emit(e,r,n,i)}setTimeout(a,this.action(r,n,i)||0,r,n,i)}}]),t}(),nt={ASSERT_NEED_ONE_ARGUMENT:function(t){if(t.length<1)throw new Error("Method requires at least one argument.")},ASSERT_IS_FUNCTION:function(t){if("function"!=typeof t)throw new Error("Argument [func] is not of type function.")},getAlwaysTrue:function(){return function(){return!0}},getBatchTimer:function(t){Ot.enqueue(t)},getSyncTimer:function(){return function(t){t.release(t)}},getDeferTimer:function(){return function(t){setTimeout(t.release,0,t)}},getThrottleTimer:function(t){function e(s){if(!r.stream.dead){var u=r.keep.isEmpty;if(!s)return void(i?a=!0:(r.release(r),n=!1,i=setTimeout(e,t.call(r),!0)));u?n||(n=!0,a=!1,i=setTimeout(e,t.call(r),!0)):(r.release(r),n=!1,i=setTimeout(e,t.call(r),!0))}}var r=this;t=o(t);var n=!1,i=null,a=!1;r.keep.auto;return e},getQueue:function(t){t=t||1/0;var e=[],n=function(r,n){return e.length<t&&e.push(r),e};return n.isBuffer=r,n.next=function(){return e.shift()},n.isEmpty=function(){return 0===e.length},n.content=function(){return e},n},getScan:function(t,e){var r=2===arguments.length,n=void 0,i=!0,a=function(a,s){return i?(i=!1,n=r?t(e,a,s):a):n=t(n,a,s),n};return a.reset=u,a.next=a.content=function(){return n},a},getGroup:function(t){t=t||i;var e={},r=function(r,n){var i=t(r,n);if(i)e[i]=r;else for(var a in r)e[a]=r[a];return e};return r.reset=function(){for(var t in e)delete e[t];r.isEmpty=!0},r.next=r.content=function(){return e},r},getHash:function(t){t=t||i;var e={},r=function(r,n){var i=t(r,n);return e[i]=r,e};return r.reset=function(){for(var t in e)delete e[t];r.isEmpty=!0},r.next=r.content=function(){return e},r},getKeepLast:function(t){if(!t||t<0){var e=void 0,r=function(t,r){return e=t};return r.reset=function(){r.isEmpty=!0},r.next=r.content=function(){return e},r}var n=[],i=function(e,r){return n.push(e),n.length>t&&n.shift(),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepFirst:function(t){if(!t||t<0){var e=void 0,r=function(t,r){return e=t};return r.reset=function(){e=!1,r.isEmpty=!0},r.next=r.content=function(){return e},r}var n=[],i=function(e,r){return n.length<t&&n.push(e),n};return i.reset=function(){for(;n.length;)n.shift();i.isEmpty=!0},i.next=i.content=function(){return n},i},getKeepAll:function(){var t=[],e=function(e,r){return t.push(e),t};return e.reset=function(){for(;t.length;)t.shift();e.isEmpty=!0},e.next=e.content=function(){return t},e},getWhenCount:function(t){var e=!1,r=function(r){return e=e||r.length>=t};return r.reset=function(){e=!1},r},getWhenKeys:function(t){for(var e={},r=t.length,n=0;n<r;n++){var i=t[n];e[i]=!0}var a=!1,s=function(e){if(a)return!0;for(var n=0;n<r;n++){var i=t[n];if(!e.hasOwnProperty(i))return!1}return a=!0};return s.reset=function(){a=!1;for(var t in e)delete e[t]},s},getHasKeys:function(t,e){var r=!1,n=t.length;return function(i){if(r||!n)return!0;for(var a=0;a<n;a++){var s=t[a];if(!i.hasOwnProperty(s))return!1}return e||(r=!0),!0}},getSkipDupes:function(){var t=!1,e=void 0;return function(r){var n=!t||r!==e;return e=r,t=!0,n}},ASSERT_NOT_HOLDING:function(t){if(t.holding)throw new Error("Method cannot be invoked while holding messages in the frame.")},ASSERT_IS_HOLDING:function(t){if(!t.holding)throw new Error("Method cannot be invoked unless holding messages in the frame.")}};nt.TO_SOURCE=i,nt.TO_TOPIC=a,nt.To_MSG=s,nt.FUNCTOR=o,nt.ALWAYS_TRUE=r,nt.ALWAYS_FALSE=n,nt.NOOP=u;var it=function(){function t(e,r,n){function i(t){if(!n[t])return null;var e=z(n[t]),r=e[0],i=e[1],a=e.slice(2);return i?r.call.apply(r,[this].concat(J(a))):r}j(this,t),this.frame=e,this.wire=r,this.keep=i("keep")||nt.getKeepLast(),this.when=i("when")||nt.ALWAYS_TRUE,this.until=i("until")||nt.ALWAYS_TRUE,this.timer=i("timer"),this.clear=i("clear")||nt.ALWAYS_FALSE,this.isPrimed=!1}return q(t,[{key:"handle",value:function(t,e,r,n,i){if(this.keep(r,n,i),!this.isPrimed){var a=this.keep.content();this.when(a)&&(this.isPrimed=!0,this.timer(this))}}},{key:"build",value:function(t,e){for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];this[t]=e.call.apply(e,[this].concat(n))}},{key:"release",value:function(t){t=t||this;var e=!t.keep.isEmpty,r=e&&t.keep.next();t.clear()&&(t.keep.reset(),t.when.reset()),t.isPrimed=!1,e&&t.frame.emit(t.wire,r)}}]),t}(),at=function t(){j(this,t),this.name="pool",this.keep=null,this.when=null,this.until=null,this.timer=null,this.clear=null},st=function(){function t(){j(this,t),this.target=null,this.dead=!1,this.name=null,this.cleanupMethod=nt.NOOP,this.pull=nt.NOOP}return q(t,[{key:"handle",value:function(t,e,r){return!this.dead&&this.target&&this.target.handle(this,t,this.name||e,r),this}},{key:"destroy",value:function(){!this.dead&&this.target&&(this.dead=!0,this.cleanupMethod())}}]),t}();st.fromMonitor=function(t,e){var r=new st,n=r.name=e||t.name,i=function(t,e,i){r.handle(t,n,i)};return r.cleanupMethod=function(){t.unsubscribe(i)},t.monitor(i),r},st.fromSubscribe=function(t,e,r,n){var i=new st,a=i.name=r||e||t.name,s=function(t,e,r){i.handle(t,a,r)};return i.cleanupMethod=function(){t.unsubscribe(s,e)},n&&(i.pull=function(){var e=t.peek();if(e){var r=e._msg,n=a||e._source,s=e._topic;i.handle(r,n,s)}}),t.subscribe(s,e),i},st.fromEvent=function(t,e,r){r=!!r;var n=new st;n.name=e;var i=t.addEventListener||t.addListener||t.on,a=t.removeEventListener||t.removeListener||t.off,s=function(t){n.handle(t,e)};return n.cleanupMethod=function(){a.call(t,e,s,r)},i.call(t,e,s,r),n};for(var ut=function(){function t(e){j(this,t),this._bus=e,this._targets=[],this._index=e._frames.length,this._wireMap=new WeakMap,this._holding=!1,this._processDef=null,this._mergingWire=null}return q(t,[{key:"define",value:function(t){return this._processDef=t,this}},{key:"merge",value:function(){return this._mergingWire=new st,this}},{key:"handle",value:function(t,e,r,n){if(this._mergingWire)return void this.emit(this._mergingWire,e,r,n);this._wireMap.has(t)||this._wireMap.set(t,this._createHandler(t)),this._wireMap.get(t).handle(this,t,e,r||t.name,n)}},{key:"emit",value:function(t,e,r,n){for(var i=this._targets.length,a=0;a<i;a++){this._targets[a].handle(t,e,r,n)}}},{key:"_createHandler",value:function(t){var e=this._processDef;return e&&"pool"===e.name?new it(this,t,e):new rt(e)}},{key:"hold",value:function(){return this._holding=!0,this._processDef=new at,this}},{key:"target",value:function(t){this._targets.push(t)}},{key:"destroy",value:function(){}},{key:"bus",get:function(){return this._bus}},{key:"index",get:function(){return this._index}},{key:"holding",get:function(){return this._holding}}]),t}(),ot=function t(e,r,n){j(this,t),this.name="wave",this.process=e,this.action=r,this.stateful=n;for(var i=arguments.length,a=Array(i>3?i-3:0),s=3;s<i;s++)a[s-3]=arguments[s];this.args=a},ht=function(){function t(e){j(this,t),this._frames=[],this._wires=[],this._dead=!1,this._scope=e,this._children=[],this._parent=null,e&&e._busList.push(this);var r=new ut(this);this._frames.push(r),this._currentFrame=r}return q(t,[{key:"addFrame",value:function(){var t=this._currentFrame,e=this._currentFrame=new ut(this);return this._frames.push(e),t.target(e),e}},{key:"spawn",value:function(){}},{key:"split",value:function(){nt.ASSERT_NOT_HOLDING(this)}},{key:"fork",value:function(){nt.ASSERT_NOT_HOLDING(this);var e=new t(this.scope);return e.parent=this,this._currentFrame.target(e._currentFrame),e}},{key:"back",value:function(){if(!this._parent)throw new Error("Cannot exit fork, parent does not exist!");return this.parent}},{key:"join",value:function(){var t=this.back();return t.add(this),t}},{key:"add",value:function(t){var e=this.addFrame();return t._currentFrame.target(e),this}},{key:"defer",value:function(){return this.timer(nt.getDeferTimer)}},{key:"batch",value:function(){return this.timer(nt.getBatchTimer)}},{key:"sync",value:function(){return this.timer(nt.getSyncTimer)}},{key:"throttle",value:function(t){return this.timer(nt.getThrottleTimer,t)}},{key:"hold",value:function(){return nt.ASSERT_NOT_HOLDING(this),this.addFrame().hold(),this}},{key:"pull",value:function(){for(var t=this._wires.length,e=0;e<t;e++){this._wires[e].pull()}return this}},{key:"event",value:function(t,e,r){var n=st.fromEvent(t,e,r);return this.wire(n)}},{key:"subscribe",value:function(t,e,r,n){var i=st.fromSubscribe(t,e,r,n);return this.wire(i)}},{key:"wire",value:function(t){return t.target=this._frames[0],this._wires.push(t),this}},{key:"monitor",value:function(t,e){var r=st.fromMonitor(t,e);return r.target=this._frames[0],this._wires.push(r),this}},{key:"scan",value:function(t,e){return this.reduce(nt.getScan,t,e)}},{key:"delay",value:function(t){return nt.ASSERT_NEED_ONE_ARGUMENT(arguments),nt.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("delay",nt.FUNCTOR(t))),this}},{key:"willReset",value:function(){return nt.ASSERT_IS_HOLDING(this),this.clear(nt.getAlwaysTrue)}},{key:"whenKeys",value:function(t){return this.when(nt.getWhenKeys,!0,t)}},{key:"group",value:function(t){return nt.ASSERT_NOT_HOLDING(this),this.hold().reduce(nt.getGroup,t),this}},{key:"groupByTopic",value:function(){return nt.ASSERT_NOT_HOLDING(this),this.addFrame().hold().reduce(nt.getGroup,nt.TO_TOPIC),this}},{key:"all",value:function(){return this.reduce(nt.getKeepAll)}},{key:"first",value:function(t){return this.reduce(nt.getKeepFirst,t)}},{key:"last",value:function(t){return this.reduce(nt.getKeepLast,t)}},{key:"clear",value:function(t){for(var e,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return(e=this._currentFrame).clear.apply(e,[t].concat(n))}},{key:"reduce",value:function(t){for(var e=this.holding,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(e){this._currentFrame._processDef.keep=[t,!0].concat(n)}else{var a=this.addFrame(),s=new(Function.prototype.bind.apply(ot,[null].concat(["msg",t,!0],n)));a.define(s)}return this}},{key:"timer",value:function(t,e){for(var r=this.holding,n=r?this._currentFrame:this.addFrame().hold(),i=n._processDef,a=arguments.length,s=Array(a>2?a-2:0),u=2;u<a;u++)s[u-2]=arguments[u];return i.timer=[t,e].concat(s),this._currentFrame._holding=!1,this}},{key:"until",value:function(t){for(var e,r,n=arguments.length,i=Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return this.holding?(e=this._currentFrame).until.apply(e,[t].concat(i)):(r=this.addFrame().hold().reduce(nt.getKeepLast)).until.apply(r,[t].concat(i)).timer(nt.getSyncTimer),this}},{key:"when",value:function(t,e){for(var r=this.holding,n=arguments.length,i=Array(n>2?n-2:0),a=2;a<n;a++)i[a-2]=arguments[a];if(r){this._currentFrame._processDef.when=[t,e].concat(i)}else{var s=this.addFrame(),u=new(Function.prototype.bind.apply(ot,[null].concat(["filter",t,e],i)));s.define(u)}return this}},{key:"run",value:function(t){return nt.ASSERT_IS_FUNCTION(t),nt.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("run",t)),this}},{key:"merge",value:function(){return nt.ASSERT_NOT_HOLDING(this),this.addFrame().merge(),this}},{key:"msg",value:function(t){return nt.ASSERT_NEED_ONE_ARGUMENT(arguments),nt.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("msg",nt.FUNCTOR(t))),this}},{key:"transform",value:function(t){return nt.ASSERT_NEED_ONE_ARGUMENT(arguments),nt.ASSERT_NOT_HOLDING(this),this.addFrame().transform(t),this}},{key:"source",value:function(t){return nt.ASSERT_NEED_ONE_ARGUMENT(arguments),nt.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("source",nt.FUNCTOR(t))),this}},{key:"filter",value:function(t){return nt.ASSERT_NEED_ONE_ARGUMENT(arguments),nt.ASSERT_IS_FUNCTION(t),nt.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("filter",t)),this}},{key:"hasKeys",value:function(t){return nt.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("filter",nt.getHasKeys(t))),this}},{key:"skipDupes",value:function(){return nt.ASSERT_NOT_HOLDING(this),this.addFrame().define(new ot("filter",nt.getSkipDupes,!0)),this}},{key:"toStream",value:function(){}},{key:"destroy",value:function(){if(this.dead)return this;this._dead=!0;for(var t=this._wires,e=t.length,r=0;r<e;r++){t[r].destroy()}return this}},{key:"children",get:function(){return this._children.map(function(t){return t})}},{key:"parent",get:function(){return this._parent},set:function(t){var e=this.parent;if(e!==t){if(e){var r=e._children.indexOf(this);e._children.splice(r,1)}return this._parent=t,t&&t._children.push(this),this}}},{key:"dead",get:function(){return this._dead}},{key:"holding",get:function(){return this._currentFrame._holding}},{key:"scope",get:function(){return this._scope}}]),t}(),ft={},ct=[{name:"ACTION",sym:"^",react:!0,subscribe:!0,need:!0,solo:!0},{name:"WIRE",sym:"~",react:!0,follow:!0},{name:"WATCH",sym:null,react:!0,follow:!0},{name:"EVENT",sym:"@",react:!0,event:!0},{name:"ALIAS",sym:"(",then:!0,solo:!0},{name:"METHOD",sym:"`",then:!0,solo:!0},{name:"READ",sym:null,then:!0,read:!0},{name:"ATTR",sym:"#",then:!0,solo:!0,output:!0},{name:"AND",sym:"&",then:!0},{name:"STYLE",sym:"$",then:!0,solo:!0,output:!0},{name:"WRITE",sym:"=",then:!0,solo:!0},{name:"SPRAY",sym:"<",then:!0},{name:"RUN",sym:"*",then:!0,output:!0},{name:"FILTER",sym:">",then:!0}],lt={},vt={},dt={},yt={},mt={},pt={},_t={},gt=0;gt<ct.length;gt++){var kt=ct[gt],wt=kt.name,bt=kt.sym;bt&&(lt[bt]=kt,yt[bt]=wt),vt[wt]=kt,dt[wt]=bt,kt.then&&(_t[wt]=!0),kt.react&&(mt[wt]=!0,pt[wt]=!0)}var Tt=function t(e,r,n,i,a,s,u,o){j(this,t),this.name=e,this.operation=r,this.maybe=n||!1,this.need=i||!1,this.topic=a||null,this.alias=s||null,this.monitor=u||!1,this.extracts=o&&o.length?o:null},Et=[];ft.parse=f;var St=0,At=function(){function t(e){j(this,t),this._id=++St,this._name=e,this._parent=null,this._children=[],this._busList=[],this._dataList=new Map,this._valves=new Map,this._mirrors=new Map,this._dead=!1}return q(t,[{key:"react",value:function(t,e,r){if(!t)throw new Error("Need a Nyan phrase!");return K(this,new ht(this),t,e,r)}},{key:"clear",value:function(){this._dead||(U(this.children),U(this._busList),U(this._dataList.values()),this._children=[],this._busList=[],this._dataList.clear(),this._valves.clear(),this._mirrors.clear())}},{key:"destroy",value:function(){this.clear(),this.parent=null,this._dead=!0}},{key:"createChild",value:function(e){var r=new t(e);return r.parent=this,r}},{key:"insertParent",value:function(t){return t.parent=this.parent,this.parent=t,this}},{key:"_createMirror",value:function(t){var e=Object.create(t);return e._type=Q.MIRROR,this._mirrors.set(t.name,e),e}},{key:"_createData",value:function(t,e){var r=new et(this,t,e);return this._dataList.set(t,r),r}},{key:"data",value:function(t){return this.grab(t)||this._createData(t,Q.NONE)}},{key:"action",value:function(t){var e=this.grab(t);return e?e.verify(Q.ACTION):this._createData(t,Q.ACTION)}},{key:"state",value:function(t){var e=this.grab(t);if(e)return e.verify(Q.STATE);var r=this._createData(t,Q.STATE);return this._createMirror(r),r}},{key:"findDataSet",value:function(t,e){var r={},n=!0,i=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var o=s.value;r[o]=this.find(o,e)}}catch(t){i=!0,a=t}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}return r}},{key:"readDataSet",value:function(t,e){var r=this.findDataSet(t,e),n={},i=!0,a=!1,s=void 0;try{for(var u,o=r[Symbol.iterator]();!(i=(u=o.next()).done);i=!0){var h=u.value;if(h){var f=h.peek();f&&(n[h.name]=f.msg)}}}catch(t){a=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(a)throw s}}return n}},{key:"flatten",value:function(){var t=this,e=new Map,r=new Map,n=!0,i=!1,a=void 0;try{for(var s,u=t._dataList[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var o=Y(s.value,2),h=o[0],f=o[1];e.set(h,f)}}catch(t){i=!0,a=t}finally{try{!n&&u.return&&u.return()}finally{if(i)throw a}}for(;t=t._parent;){var c=t._dataList,l=t._valves,v=t._mirrors;if(c.size){if(l.size)if(r.size){var d=!0,y=!1,m=void 0;try{for(var p,_=r.keys()[Symbol.iterator]();!(d=(p=_.next()).done);d=!0){var g=p.value;l.has(g)||r.delete(g)}}catch(t){y=!0,m=t}finally{try{!d&&_.return&&_.return()}finally{if(y)throw m}}}else{var k=!0,w=!1,b=void 0;try{for(var T,E=l.entries()[Symbol.iterator]();!(k=(T=E.next()).done);k=!0){var S=Y(T.value,2),A=S[0],f=S[1];r.set(A,f)}}catch(t){w=!0,b=t}finally{try{!k&&E.return&&E.return()}finally{if(w)throw b}}}var O=r.size?r:c,N=!0,R=!1,D=void 0;try{for(var L,F=O.keys()[Symbol.iterator]();!(N=(L=F.next()).done);N=!0){var I=L.value;if(!e.has(I)){var x=v.get(I)||c.get(I);x&&e.set(I,x)}}}catch(t){R=!0,D=t}finally{try{!N&&F.return&&F.return()}finally{if(R)throw D}}}}return e}},{key:"find",value:function(t,e){var r=this.grab(t);if(r)return r;for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(t))break;var a=n._mirrors.get(t);if(a)return a;var s=n.grab(t);if(s)return s}if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"findOuter",value:function(t,e){var r=!1;this.grab(t)&&(r=!0);for(var n=this;n=n._parent;){var i=n._valves;if(i.size&&!i.has(t))break;var a=n._mirrors.get(t);if(a){if(r)return a;r=!0}else{var s=n.grab(t);if(s){if(r)return s;r=!0}}}if(e)throw new Error("Required data: "+t+" not found!");return null}},{key:"grab",value:function(t,e){var r=this._dataList.get(t);if(!r&&e)throw new Error("Required Data: "+t+" not found!");return r||null}},{key:"transaction",value:function(t){if(Array.isArray(t))return this._multiWriteArray(t);if("object"===(void 0===t?"undefined":B(t)))return this._multiWriteHash(t);throw new Error("Write values must be in an array of object hash.")}},{key:"_multiWriteArray",value:function(t){var e=[],r=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var u=a.value,o=this.find(u.name);o.silentWrite(u.value,u.topic),e.push(o)}}catch(t){n=!0,i=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}var h=!0,f=!1,c=void 0;try{for(var l,v=e[Symbol.iterator]();!(h=(l=v.next()).done);h=!0){var d=l.value,y=t[0];d.refresh(y.topic)}}catch(t){f=!0,c=t}finally{try{!h&&v.return&&v.return()}finally{if(f)throw c}}return this}},{key:"_multiWriteHash",value:function(t){var e=[];for(var r in t){var n=t[r],i=this.find(r);i.silentWrite(n),e.push(i)}var a=!0,s=!1,u=void 0;try{for(var o,h=e[Symbol.iterator]();!(a=(o=h.next()).done);a=!0){o.value.refresh()}}catch(t){s=!0,u=t}finally{try{!a&&h.return&&h.return()}finally{if(s)throw u}}return this}},{key:"name",get:function(){return this._name}},{key:"dead",get:function(){return this._dead}},{key:"children",get:function(){return this._children.map(function(t){return t})}},{key:"parent",get:function(){return this._parent},set:function(t){var e=this.parent;if(e!==t){if(e){var r=e._children.indexOf(this);e._children.splice(r,1)}return this._parent=t,t&&t._children.push(this),this}}},{key:"valves",set:function(t){var e=!0,r=!1,n=void 0;try{for(var i,a=t[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var s=i.value;this._valves.set(s,!0)}}catch(t){r=!0,n=t}finally{try{!e&&a.return&&a.return()}finally{if(r)throw n}}},get:function(){return Array.from(this._valves.keys())}}]),t
}(),Ot={},Nt=[],Rt=!1;return Ot.fromEvent=function(t,e,r){var n=new ht;return n.event(t,e,r),n},Ot.enqueue=function(t){Nt.push(t),Rt||(Rt=!0,"undefined"!=typeof window&&window.requestAnimationFrame?requestAnimationFrame(Ot.flush):process.nextTick(Ot.flush))},Ot.createChild=Ot.scope=function(t){return new At(t)},Ot.flush=function(){Rt=!1;var t=0,e=Nt;for(Nt=[];e.length;){for(;e.length;){e.shift().release()}if(e=Nt,Nt=[],++t>10)throw new Error("Flush batch cycling loop > 10.",e)}},Ot});
//# sourceMappingURL=catbus.umd.min.js.map
